import asyncio
import concurrent.futures
import re
from datetime import datetime, timedelta

from mcp_agent.agents.agent import Agent
from mcp_agent.app import MCPApp
from mcp_agent.workflows.llm.augmented_llm import RequestParams
from mcp_agent.workflows.llm.augmented_llm_openai import OpenAIAugmentedLLM

app = MCPApp(name="stock_analysis")

# WiseReport URL 템플릿 설정
WISE_REPORT_BASE = "https://comp.wisereport.co.kr/company/"
URLS = {
    "기업현황": "c1010001.aspx?cmp_cd={}",
    "기업개요": "c1020001.aspx?cmp_cd={}",
    "재무분석": "c1030001.aspx?cmp_cd={}",
    "투자지표": "c1040001.aspx?cmp_cd={}",
    "컨센서스": "c1050001.aspx?cmp_cd={}",
    "경쟁사분석": "c1060001.aspx?cmp_cd={}",
    "지분현황": "c1070001.aspx?cmp_cd={}",
    "업종분석": "c1090001.aspx?cmp_cd={}",
    "최근리포트": "c1080001.aspx?cmp_cd={}"
}

async def collect_data(data_key: str, collector_agent: Agent, company_name: str, company_code: str, reference_date: str, logger, delay: float = 3.0):
    """데이터 수집을 위한 async 함수"""
    # 각 작업 시작 전 지연
    await asyncio.sleep(delay)

    logger.info(f"Collecting {data_key} for {company_name}...")

    llm = await collector_agent.attach_llm(OpenAIAugmentedLLM)
    data = await llm.generate_str(
        message=f"""{company_name}({company_code})의 {data_key} 데이터를 수집해주세요. 
        제목은 눈에 잘 보이게 큰 양식으로 적고 나머지 분석 항목들은 작은 양식으로 적어주세요. 
        그리고 아래 보고서 품질 기준을 지켜주세요:

        ##보고서 품질 기준:
        1. 모든 수치는 구체적인 날짜와 함께 제시
        2. 주장에는 반드시 데이터 기반 근거 첨부
        3. 분석은 객관적 사실과 데이터에 기반
        4. 미래 전망은 근거와 함께 제시
        5. 모든 비교는 구체적인 수치로 표현
        """,
        request_params=RequestParams(
            model="gpt-4o-mini",
            maxTokens=8000,
            max_iterations=5,
            parallel_tool_calls=True,
            use_history=True
        )
    )

    logger.info(f"Completed collecting {data_key} - {len(data)} characters")
    return data_key, data

async def write_report_section(data_key: str, writer_agent: Agent, collected_data: dict,
                               company_name: str, company_code: str, reference_date: str, logger, delay: float = 3.0):
    """보고서 섹션 작성을 위한 async 함수"""
    # 각 작업 시작 전 지연
    await asyncio.sleep(delay)

    if data_key not in collected_data:
        logger.warning(f"Missing data for {data_key}, skipping report section")
        return data_key, ""

    logger.info(f"Writing report section for {data_key}...")

    llm = await writer_agent.attach_llm(OpenAIAugmentedLLM)
    section_report = await llm.generate_str(
        message=f"""{company_name}({company_code})의 {data_key} 분석 보고서를 작성해주세요.
                    보고서의 길이는 response token이 허락하는 최대한도를 써야 합니다.
                    가능하면 5,000글자 이상을 원합니다.
                    최대한 상세하고 구체적인 수치가 많이 들어가도록 전문성 있는 보고서를 작성해주세요.
                    
                    (주의사항) 보고서 작성시 제목을 넣기 전에 반드시 개행문자를 2번 넣어 시작하세요 (\n\n).
                    이는 보고서의 시작부분에서 충분한 여백을 확보하기 위함입니다.
                    
                    분석에 사용할 데이터는 다음과 같습니다:
                    (최신날짜인 {reference_date} 날짜(YYYYMMDD 형식)로부터 2~3년전까지 자료들을 위주로 취합했습니다)
                    <데이터>
                    {collected_data[data_key]}
                    </데이터>
                    ##분석일 : {reference_date}(YYYYMMDD 형식)
                    """,
        request_params=RequestParams(
            model="gpt-4o-mini",
            maxTokens=8000,
            max_iterations=5,
            parallel_tool_calls=True,
            use_history=True
        )
    )

    logger.info(f"Completed writing report section for {data_key} - {len(section_report)} characters")
    return data_key, section_report

def clean_markdown(text: str) -> str:
    """마크다운 텍스트 정리"""

    # 1. 백틱 블록 제거
    text = re.sub(r'```[^\n]*\n(.*?)\n```', r'\1', text, flags=re.DOTALL)

    return text


def get_wise_report_url(report_type: str, company_code: str) -> str:
    """WiseReport URL 생성"""
    return WISE_REPORT_BASE + URLS[report_type].format(company_code)

async def analyze_stock(company_code: str = "000660", company_name: str = "SK하이닉스", reference_date: str = None):
    # reference_date가 없으면 오늘 날짜를 사용
    if reference_date is None:
        reference_date = datetime.now().strftime("%Y%m%d")

    year = reference_date[:4]

    # 날짜 객체로 변환
    ref_date = datetime.strptime(reference_date, "%Y%m%d")

    # 기간 계산
    max_years = 1
    max_years_ago = (ref_date - timedelta(days=365*max_years)).strftime("%Y%m%d")
    six_months_ago = (ref_date - timedelta(days=180)).strftime("%Y%m%d")

    async with app.run() as parallel_app:
        logger = parallel_app.logger
        logger.info(f"시작: {company_name}({company_code}) 분석 - 기준일: {reference_date}")

        # 공유 리소스로 데이터를 저장할 딕셔너리 생성
        collected_data = {}
        section_reports = {}

        # URL 매핑 생성
        urls = {k: get_wise_report_url(k, company_code) for k in URLS.keys()}

        # 데이터 수집 에이전트 설정
        data_collectors = {
            "price_data": Agent(
                name="price_data_collector",
                instruction=f"""당신은 주가 데이터 수집 전문가입니다. 
                            get_stock_ohlcv tool을 사용하여 {max_years_ago} ~ {reference_date} 기간(YYYYMMDD 형식)의 주가/거래량 데이터를 수집하세요.
                            예시: get_stock_ohlcv("20240101", "20240131", "005930")
    
                            다음 데이터를 분석하고 핵심 인사이트와 세부 분석으로 구성된 2,500자 이상의 종합 데이터 수집 보고서를 작성해주세요.
                            {reference_date} 날짜(YYYYMMDD 형식) 기준으로 가장 최근 흐름 중심으로 분석해주세요.
                    
                            기업: {company_name} ({company_code})
                            """,
                server_names=["kospi_kosdaq"]
            ),
            "fundamental_data": Agent(
                name="fundamental_data_collector",
                instruction=f"""당신은 기업 재무 데이터 수집 전문가입니다.
                            get_stock_fundamental tool을 사용하여 {max_years_ago} ~ {reference_date} 기간(YYYYMMDD 형식)의 재무 지표를 수집하세요.
                            예시: get_stock_fundamental("20240101", "20240131", "005930")
    
                            다음 데이터를 분석하고 핵심 인사이트와 세부 분석으로 구성된 2,500자 이상의 종합 데이터 수집 보고서를 작성해주세요.
                            {reference_date} 날짜(YYYYMMDD 형식) 기준으로 가장 최근 흐름 중심으로 분석해주세요.
                    

                            기업: {company_name} ({company_code})
                            """,
                server_names=["kospi_kosdaq"]
            ),
            "market_cap_data": Agent(
                name="market_cap_collector",
                instruction=f"""당신은 시가총액 데이터 수집 전문가입니다.
                            get_stock_market_cap tool을 사용하여 {max_years_ago} ~ {reference_date} 기간(YYYYMMDD 형식)의 데이터를 수집하세요.
                            예시: get_stock_market_cap("20240101", "20240131", "005930") 
    
                            다음 데이터를 분석하고 핵심 인사이트와 세부 분석으로 구성된 2,500자 이상의 종합 데이터 수집 보고서를 작성해주세요.
                            {reference_date} 날짜(YYYYMMDD 형식) 기준으로 가장 최근 흐름 중심으로 분석해주세요.
                    
                            기업: {company_name} ({company_code})
                            """,
                server_names=["kospi_kosdaq"]
            ),
            "trading_volume_data": Agent(
                name="trading_volume_collector",
                instruction=f"""당신은 투자자 거래 데이터 수집 전문가입니다.
                            get_stock_trading_volume tool을 사용하여 {max_years_ago} ~ {reference_date} 기간(YYYYMMDD 형식)의 데이터를 수집하세요.
                            예시: get_stock_trading_volume("20240101", "20240131", "005930")
    
                            다음 데이터를 분석하고 핵심 인사이트와 세부 분석으로 구성된 2,500자 이상의 종합 데이터 수집 보고서를 작성해주세요.
                            {reference_date} 날짜(YYYYMMDD 형식) 기준으로 가장 최근 흐름 중심으로 분석해주세요.
                    
                            기업: {company_name} ({company_code})
                            """,
                server_names=["kospi_kosdaq"]
            ),
            "corporate_overview": Agent(
                name="corporate_data_collector1",
                instruction=f"""당신은 기업 개요 데이터 수집 전문가입니다.
                            아래 url에 접속해서 {reference_date} 날짜(YYYYMMDD 형식)로부터 2~3년전까지 자료들을 수집하고 최신순으로 분석하세요:
                            단, url 접속 시 visit_page tool을 사용하고 takeScreenshot 파라미터는 false로 넣으세요. 그리고 차트는 분석하지 말고 테이블을 위주로 분석하세요.
                            
                            ## 접속 URL : {urls['기업개요']}
                            
                            기업개요에 대한 내용을 상세하게 정리해서 작성해주시면 됩니다.
                            
                            핵심 인사이트와 세부 분석으로 구성된 2,500자 이상의 데이터 수집 보고서를 작성해주세요.
                            최대한 상세하고 구체적인 수치가 많이 들어가도록 전문성 있는 수집결과를 작성해주세요.
                            기업: {company_name} ({company_code})
                            """,
                server_names=["webresearch"]
            ),
            "corporate_status": Agent(
                name="corporate_data_collector2",
                instruction=f"""당신은 기업현황 데이터 수집 전문가입니다.
                            아래 url에 접속해서 {year} 년도로부터 2~3년전까지 자료들을 수집하고 최신순으로 분석하세요:
                            단, url 접속 시 visit_page tool을 사용하고 takeScreenshot 파라미터는 false로 넣으세요. 그리고 차트는 분석하지 말고 테이블을 위주로 분석하세요.
                            
                            - 접속 URL :  {urls['기업현황']}
                            
                            기업현황에 대한 내용을 상세하게 정리해서 작성해주시면 됩니다.
                            
                            핵심 인사이트와 세부 분석으로 구성된 2,500자 이상의 데이터 수집 보고서를 작성해주세요.
                            최대한 상세하고 구체적인 수치가 많이 들어가도록 전문성 있는 수집결과를 작성해주세요.
                            기업: {company_name} ({company_code})
                            """,
                server_names=["webresearch"]
            ),
            "financial_analysis1": Agent(
                name="corporate_data_collector3_1",
                instruction=f"""당신은 기업 재무분석(포괄손익계산서) 데이터 수집 전문가입니다.
                            아래 url에 접속해서 {year} 년도로부터 2~3년전까지 자료들을 수집하고 최신순으로 분석하세요:
                            단, url 접속 시 visit_page tool을 사용하고 takeScreenshot 파라미터는 false로 넣으세요. 그리고 차트는 분석하지 말고 테이블을 위주로 분석하세요.
                            '포괄손익계산서'탭을 위주로 분석해주세요
                            
                            - 접속 URL :  {urls['재무분석']}
                            
                            재무분석(포괄손익계산서)에 대한 내용을 상세하게 정리해서 작성해주시면 됩니다.
                            
                            핵심 인사이트와 세부 분석으로 구성된 2,500자 이상의 데이터 수집 보고서를 작성해주세요.
                            최대한 상세하고 구체적인 수치가 많이 들어가도록 전문성 있는 수집결과를 작성해주세요.
                            기업: {company_name} ({company_code})
                            """,
                server_names=["webresearch"]
            ),
            "financial_analysis2": Agent(
                name="corporate_data_collector3_2",
                instruction=f"""당신은 기업 재무분석(재무상태표) 데이터 수집 전문가입니다.
                            아래 url에 접속해서 {year} 년도로부터 2~3년전까지 자료들을 수집하고 최신순으로 분석하세요:
                            단, url 접속 시 visit_page tool을 사용하고 takeScreenshot 파라미터는 false로 넣으세요. 그리고 차트는 분석하지 말고 테이블을 위주로 분석하세요.
                            '재무상태표'탭을 위주로 분석해주세요
                            
                            - 접속 URL :  {urls['재무분석']}
                            
                            재무분석(재무상태표)에 대한 내용을 상세하게 정리해서 작성해주시면 됩니다.
                            
                            핵심 인사이트와 세부 분석으로 구성된 2,500자 이상의 데이터 수집 보고서를 작성해주세요.
                            최대한 상세하고 구체적인 수치가 많이 들어가도록 전문성 있는 수집결과를 작성해주세요.
                            기업: {company_name} ({company_code})
                            """,
                server_names=["webresearch"]
            ),
            "financial_analysis3": Agent(
                name="corporate_data_collector3_3",
                instruction=f"""당신은 기업 재무분석(현금흐름표) 데이터 수집 전문가입니다.
                            아래 url에 접속해서 {year} 년도로부터 2~3년전까지 자료들을 수집하고 최신순으로 분석하세요:
                            단, url 접속 시 visit_page tool을 사용하고 takeScreenshot 파라미터는 false로 넣으세요. 그리고 차트는 분석하지 말고 테이블을 위주로 분석하세요.
                            '현금흐름표'탭을 위주로 분석해주세요.
                            
                            - 접속 URL :  {urls['재무분석']}
                            
                            재무분석(현금흐름표)에 대한 내용을 상세하게 정리해서 작성해주시면 됩니다.
                            
                            핵심 인사이트와 세부 분석으로 구성된 2,500자 이상의 데이터 수집 보고서를 작성해주세요.
                            최대한 상세하고 구체적인 수치가 많이 들어가도록 전문성 있는 수집결과를 작성해주세요.
                            기업: {company_name} ({company_code})
                            """,
                server_names=["webresearch"]
            ),
            "investment_indicators": Agent(
                name="corporate_data_collector4",
                instruction=f"""당신은 기업 투자지표 데이터 수집 전문가입니다.
                            아래 url에 접속해서 {year} 년도로부터 2~3년전까지 자료들을 수집하고 최신순으로 분석하세요:
                            단, url 접속 시 visit_page tool을 사용하고 takeScreenshot 파라미터는 false로 넣으세요. 그리고 차트는 분석하지 말고 테이블을 위주로 분석하세요.
                            페이지 안에 '수익성', '성장성', '안정성', '활동성' 등의 단어의 탭이 보이면 거기도 들어갈 수 있도록 시도해보세요. url파라미터를 조절하며 접근하면 될겁니다.
                            
                            - 접속 URL :  {urls['투자지표']}
                            
                            투자지표에 대한 내용을 상세하게 정리해서 작성해주시면 됩니다.
                            
                            핵심 인사이트와 세부 분석으로 구성된 2,500자 이상의 데이터 수집 보고서를 작성해주세요.
                            최대한 상세하고 구체적인 수치가 많이 들어가도록 전문성 있는 수집결과를 작성해주세요.
                            기업: {company_name} ({company_code})
                            """,
                server_names=["webresearch"]
            ),
            "consensus_data": Agent(
                name="corporate_data_collector5",
                instruction=f"""당신은 기업 컨센서스 데이터 수집 전문가입니다.
                            아래 url에 접속해서 {year} 년도로부터 2~3년전까지 자료들을 수집하고 최신순으로 분석하세요:
                            단, url 접속 시 visit_page tool을 사용하고 takeScreenshot 파라미터는 false로 넣으세요. 그리고 차트는 분석하지 말고 테이블을 위주로 분석하세요.
                            페이지 안에 '분기' 단어의 탭이 보이면 거기도 들어갈 수 있도록 시도해보세요. url파라미터를 조절하며 접근하면 될겁니다.
                            
                            - 접속 URL :  {urls['컨센서스']}
                            
                            컨센서스에 대한 내용을 상세하게 정리해서 작성해주시면 됩니다.
                            
                            핵심 인사이트와 세부 분석으로 구성된 2,500자 이상의 데이터 수집 보고서를 작성해주세요.
                            최대한 상세하고 구체적인 수치가 많이 들어가도록 전문성 있는 수집결과를 작성해주세요.
                            기업: {company_name} ({company_code})
                            """,
                server_names=["webresearch"]
            ),
            "competitor_analysis": Agent(
                name="corporate_data_collector6",
                instruction=f"""당신은 기업 경쟁사분석 데이터 수집 전문가입니다.
                            아래 url에 접속해서 {year} 년도로부터 2~3년전까지 자료들을 수집하고 최신순으로 분석하세요:
                            단, url 접속 시 visit_page tool을 사용하고 takeScreenshot 파라미터는 false로 넣으세요. 그리고 차트는 분석하지 말고 테이블을 위주로 분석하세요.
                            페이지 안에 '분기' 단어의 탭이 보이면 거기도 들어갈 수 있도록 시도해보세요. url파라미터를 조절하며 접근하면 될겁니다.
                            
                            - 접속 URL :  {urls['경쟁사분석']}
                            
                            경쟁사분석에 대한 내용을 상세하게 정리해서 작성해주시면 됩니다.
                            
                            핵심 인사이트와 세부 분석으로 구성된 2,500자 이상의 데이터 수집 보고서를 작성해주세요.
                            최대한 상세하고 구체적인 수치가 많이 들어가도록 전문성 있는 수집결과를 작성해주세요.
                            기업: {company_name} ({company_code})
                            """,
                server_names=["webresearch"]
            ),
            "etc_analysis": Agent(
                name="corporate_data_collector7",
                instruction=f"""당신은 기업 지분현황/업종분석/최근리포트 데이터 수집 전문가입니다.
                            아래 url 리스트에 접속해서 {year} 년도로부터 2~3년전까지 자료들을 수집하고 최신순으로 분석하세요:
                            단, url 접속 시 visit_page tool을 사용하고 takeScreenshot 파라미터는 false로 넣으세요. 그리고 차트는 분석하지 말고 테이블을 위주로 분석하세요.
                            
                            - 접속 URL 리스트 :
                             1. 지분현황 : {urls['지분현황']}
                             2. 업종분석 : {urls['업종분석']} 
                             3. 최근리포트 : {urls['최근리포트']}
                            
                            지분현황,업종분석,최근리포트 총 3가지에 대한 내용을 상세하게 정리해서 작성해주시면 됩니다.
                            
                            핵심 인사이트와 세부 분석으로 구성된 2,500자 이상의 데이터 수집 보고서를 작성해주세요.
                            최대한 상세하고 구체적인 수치가 많이 들어가도록 전문성 있는 수집결과를 작성해주세요.
                            기업: {company_name} ({company_code})
                            """,
                server_names=["webresearch"]
            ),
            "news_data": Agent(
                name="news_data_collector",
                instruction=f"""당신은 기업 뉴스/리서치 데이터 수집 전문가입니다. 
                            {six_months_ago} ~ {reference_date} 기간(YYYYMMDD 형식)의 뉴스 및 리서치 자료를 최신순으로 10개를 수집하세요.
                            exa server의 search tool을 이용해서 임의로 쿼리를 생성하여 조사하세요.
                            
                            수집 항목:
                            - 주요 기업 뉴스
                            - 산업 뉴스
                            - 애널리스트 리포트
                            
                            뉴스수집 대한 내용을 최신뉴스순으로 상세하게 정리해서 작성해주시면 됩니다.
                            핵심 인사이트와 세부 분석으로 구성된 2,500자 이상의 데이터 수집 보고서를 작성해주세요.
                            최대한 상세하고 구체적인 수치가 많이 들어가도록 전문성 있는 수집결과를 작성해주세요.
                            기업: {company_name} ({company_code})
                            """,
                server_names=["exa"]
            )
        }

        # 보고서 작성 에이전트 설정
        report_writers = {
            "price_data": Agent(
                name="price_analyst",
                instruction=f"""당신은 주가 분석 전문가입니다. 수집된 주가 데이터를 바탕으로 객관적이고 데이터 중심의 분석 보고서를 작성하세요.
                            최대한 상세하고 구체적인 수치가 많이 들어가도록 전문성 있는 보고서를 작성해주세요.
                            {reference_date} 날짜(YYYYMMDD 형식)로부터 최신순으로 분석한 보고서를 작성해주세요.
                            최신데이터일수록 보고서에 다루어질 가중치가 높아집니다:
                            
                            ##보고서 형식:
                            1. 모든 섹션은 독립적인 소보고서로 마크다운 형식으로 작성되어야 합니다
                            2. 제목은 반드시 "# [번호]. [제목] 보고서"로 시작 (예: "# 1. 주가 및 기술적 분석 보고서")
                            3. 각 섹션은 마크다운 형식의 명확한 구분선으로 분리
                            4. 보고서의 제목 앞에 제일 첫 부분은 Enter키(개행문자)를 친 뒤에 시작합니다. (예시 : (개행문자) # 1. 제목) (예시 : (개행문자) # 1. 제목)
                            5. 제목과 본문 사이에는 반드시 개행문자를 2번 넣어 충분한 여백을 확보해주세요
                            
                            ##항목 구조화:
                            1. 모든 주요 항목은 "1.", "2." 형식의 번호 사용
                            2. 하위 항목은 "1.1", "1.2" 형식으로 통일
                            3. 각 항목에는 설명적인 제목 필수 (예: "1. 수익성 분석", "1.1 영업이익률 추이")
                            
                            ##제외사항:
                            1. 기업 기본정보는 생략합니다
                            2. 해당 분석과 직접 관련없는 일반적인 산업 설명은 제외합니다
                            3. 분석 목적과 무관한 데이터는 포함하지 않습니다
                            
                            ##주의사항:
                            1. 본 보고서는 [주가 분석 주제]에 한정된 분석만 다룹니다
                            2. 다른 보고서의 주제(재무분석, 기업개요 등)는 다루지 않습니다
                            3. 데이터 인용 시 반드시 출처와 기준일자를 명시합니다 (출처 : http://data.krx.co.kr/)

                            ## 말투 지침:
                            - 전문적이고 객관적인 문어체를 사용하세요
                            - 모든 문장은 '~합니다', '~입니다'와 같은 높임말로 통일하세요
                            - 개인적 의견이나 감정표현은 피하세요 ('~것 같습니다', '~보입니다' 대신 '~나타납니다', '~확인됩니다' 사용)
                            - 질문형 문장은 사용하지 마세요
                            - 모든 에이전트가 동일한 말투를 유지할 수 있도록 해당 지침을 따르세요
                            
                            ## 보고서 작성 지침:
                            1. 길이: 5,000자 이상으로 작성 (중복되는 내용 없이 핵심만 포함)
                            2. 데이터: 모든 분석은 구체적 수치와 기간을 명시할 것
                            3. 객관성: 개인적 견해보다 데이터에 기반한 객관적 분석 제시
                            4. 일관성: 다른 섹션과 중복되지 않도록 주가/기술적 분석에만 집중
                            5. 시각화: 주요 지표와 패턴은 표 형식으로 요약하여 제시
                            6. 금지사항 : 결론에 해당하는 문단은 만들지 말 것. 해당 보고서는 섹션 중 하나이기 때문
                            7. 필수 입력 : 보고서 작성시 맨 앞에 개행문자를 2번 연속 입력하여 반드시 여백을 확보하고 시작하세요 (\n\n)
                            
                            ##분석 항목:
                            - 주가 추세 분석
                            - 기술적 지표 분석
                            - 거래량 분석
                            - 변동성 분석
                            - 주가 패턴 분석
                            
                            당신은 최초의 보고자입니다. 최초의 보고자로써 해당 기업의 전체 보고서 제목(예시 : SK하이닉스 기업 분석 보고서 (2025.02.19))을 제일 먼저 작성해야 합니다.
                            그 다음 당신만의 섹션의 보고서 제목은 "# 1. 주가 및 기술적 분석"으로 시작하세요.
                            제목은 눈에 잘 보이게 큰 양식으로 적고 나머지 분석 항목들은 작은 양식으로 적어주세요.
                            
                            기업: {company_name} ({company_code})
                            ##분석일 : {reference_date}(YYYYMMDD 형식)
                            """
            ),
            "market_cap_data": Agent(
                name="market_cap_analyst",
                instruction=f"""당신은 시가총액 분석 전문가입니다. 수집된 시가총액 데이터를 바탕으로 객관적이고 데이터 중심의 분석 보고서를 작성하세요.
                            최대한 상세하고 구체적인 수치가 많이 들어가도록 전문성 있는 보고서를 작성해주세요.
                            {reference_date} 날짜(YYYYMMDD 형식)로부터 최신순으로 분석한 보고서를 작성해주세요.
                            최신데이터일수록 보고서에 다루어질 가중치가 높아집니다:
                            
                            ##보고서 형식:
                            1. 모든 섹션은 독립적인 소보고서로 마크다운 형식으로 작성되어야 합니다
                            2. 제목은 반드시 "# [번호]. [제목] 보고서"로 시작 (예: "# 1. 주가 및 기술적 분석 보고서")
                            3. 각 섹션은 마크다운 형식의 명확한 구분선으로 분리
                            4. 보고서의 제목 앞에 제일 첫 부분은 Enter키(개행문자)를 친 뒤에 시작합니다. (예시 : (개행문자) # 1. 제목)
                            5. 제목과 본문 사이에는 반드시 개행문자를 2번 넣어 충분한 여백을 확보해주세요
                            
                            ##항목 구조화:
                            1. 모든 주요 항목은 "1.", "2." 형식의 번호 사용
                            2. 하위 항목은 "1.1", "1.2" 형식으로 통일
                            3. 각 항목에는 설명적인 제목 필수 (예: "1. 수익성 분석", "1.1 영업이익률 추이")
                            
                            ##제외사항:
                            1. 기업 기본정보는 생략합니다
                            2. 해당 분석과 직접 관련없는 일반적인 산업 설명은 제외합니다
                            3. 분석 목적과 무관한 데이터는 포함하지 않습니다
                            
                            ##주의사항:
                            1. 본 보고서는 [시가총액 분석 주제]에 한정된 분석만 다룹니다
                            2. 다른 보고서의 주제(재무분석, 기업개요 등)는 다루지 않습니다
                            3. 데이터 인용 시 반드시 출처와 기준일자를 명시합니다 (출처 : http://data.krx.co.kr/)

                            ## 말투 지침:
                            - 전문적이고 객관적인 문어체를 사용하세요
                            - 모든 문장은 '~합니다', '~입니다'와 같은 높임말로 통일하세요
                            - 개인적 의견이나 감정표현은 피하세요 ('~것 같습니다', '~보입니다' 대신 '~나타납니다', '~확인됩니다' 사용)
                            - 질문형 문장은 사용하지 마세요
                            - 모든 에이전트가 동일한 말투를 유지할 수 있도록 해당 지침을 따르세요
                            
                            ## 보고서 작성 지침:
                            1. 길이: 5,000자 이상으로 작성 (중복되는 내용 없이 핵심만 포함)
                            2. 데이터: 모든 분석은 구체적 수치와 기간을 명시할 것
                            3. 객관성: 개인적 견해보다 데이터에 기반한 객관적 분석 제시
                            4. 일관성: 다른 섹션과 중복되지 않도록 주가/기술적 분석에만 집중
                            5. 시각화: 주요 지표와 패턴은 표 형식으로 요약하여 제시
                            6. 금지사항 : 결론에 해당하는 문단은 만들지 말 것. 해당 보고서는 섹션 중 하나이기 때문
                            7. 필수 입력 : 보고서 작성시 맨 앞에 개행문자를 2번 연속 입력하여 반드시 여백을 확보하고 시작하세요 (\n\n)
                            
                            ##분석 항목:
                            - 시가총액 추이 분석
                            - 시장 대비 상대적 규모 분석
                            - 거래대금 및 유동성 분석
                            - 상장주식수
                            
                            보고서 제목은 "# 2. 시가총액 및 유동성 분석"으로 시작하세요.
                            제목은 눈에 잘 보이게 큰 양식으로 적고 나머지 분석 항목들은 작은 양식으로 적어주세요.
                            기업: {company_name} ({company_code})
                            ##분석일 : {reference_date}(YYYYMMDD 형식)
                            """
            ),
            "trading_volume_data": Agent(
                name="trading_volume_analyst",
                instruction=f"""당신은 거래 패턴 분석 전문가입니다. 수집된 거래량 데이터를 바탕으로 객관적이고 데이터 중심의 분석 보고서를 작성하세요.
                            최대한 상세하고 구체적인 수치가 많이 들어가도록 전문성 있는 보고서를 작성해주세요.
                            {reference_date} 날짜(YYYYMMDD 형식)로부터 최신순으로 분석한 보고서를 작성해주세요.
                            최신데이터일수록 보고서에 다루어질 가중치가 높아집니다:
                            
                            ##보고서 형식:
                            1. 모든 섹션은 독립적인 소보고서로 마크다운 형식으로 작성되어야 합니다
                            2. 제목은 반드시 "# [번호]. [제목] 보고서"로 시작 (예: "# 1. 주가 및 기술적 분석 보고서")
                            3. 각 섹션은 마크다운 형식의 명확한 구분선으로 분리
                            4. 보고서의 제목 앞에 제일 첫 부분은 Enter키(개행문자)를 친 뒤에 시작합니다. (예시 : (개행문자) # 1. 제목)
                            5. 제목과 본문 사이에는 반드시 개행문자를 2번 넣어 충분한 여백을 확보해주세요
                            
                            ##항목 구조화:
                            1. 모든 주요 항목은 "1.", "2." 형식의 번호 사용
                            2. 하위 항목은 "1.1", "1.2" 형식으로 통일
                            3. 각 항목에는 설명적인 제목 필수 (예: "1. 수익성 분석", "1.1 영업이익률 추이")
                            
                            ##제외사항:
                            1. 기업 기본정보는 생략합니다
                            2. 해당 분석과 직접 관련없는 일반적인 산업 설명은 제외합니다
                            3. 분석 목적과 무관한 데이터는 포함하지 않습니다
                            
                            ##주의사항:
                            1. 본 보고서는 [거래 패턴 분석 주제]에 한정된 분석만 다룹니다
                            2. 다른 보고서의 주제(재무분석, 기업개요 등)는 다루지 않습니다
                            3. 데이터 인용 시 반드시 출처와 기준일자를 명시합니다 (출처 : http://data.krx.co.kr/)


                            ## 말투 지침:
                            - 전문적이고 객관적인 문어체를 사용하세요
                            - 모든 문장은 '~합니다', '~입니다'와 같은 높임말로 통일하세요
                            - 개인적 의견이나 감정표현은 피하세요 ('~것 같습니다', '~보입니다' 대신 '~나타납니다', '~확인됩니다' 사용)
                            - 질문형 문장은 사용하지 마세요
                            - 모든 에이전트가 동일한 말투를 유지할 수 있도록 해당 지침을 따르세요
                            
                            ## 보고서 작성 지침:
                            1. 길이: 5,000자 이상으로 작성 (중복되는 내용 없이 핵심만 포함)
                            2. 데이터: 모든 분석은 구체적 수치와 기간을 명시할 것
                            3. 객관성: 개인적 견해보다 데이터에 기반한 객관적 분석 제시
                            4. 일관성: 다른 섹션과 중복되지 않도록 주가/기술적 분석에만 집중
                            5. 시각화: 주요 지표와 패턴은 표 형식으로 요약하여 제시
                            6. 금지사항 : 결론에 해당하는 문단은 만들지 말 것. 해당 보고서는 섹션 중 하나이기 때문
                            7. 필수 입력 : 보고서 작성시 맨 앞에 개행문자를 2번 연속 입력하여 반드시 여백을 확보하고 시작하세요 (\n\n)
                            
                            ##분석 항목:
                            - 투자자별 순매수/순매도 분석 
                            - 투자주체별 거래 비중 분석
                            - 기관/외국인/개인 매매 패턴 분석
                            - 거래량 변동성 분석
                            
                            보고서 제목은 "# 3. 투자자 거래 패턴 분석"으로 시작하세요.
                            제목은 눈에 잘 보이게 큰 양식으로 적고 나머지 분석 항목들은 작은 양식으로 적어주세요.
                            기업: {company_name} ({company_code})
                            ##분석일 : {reference_date}(YYYYMMDD 형식)
                            """
            ),
            "corporate_overview": Agent(
                name="business_analyst",
                instruction=f"""당신은 기업 분석 전문가입니다. 수집된 기업 개요 데이터를 바탕으로 객관적이고 데이터 중심의 분석 보고서를 작성하세요.
                            최대한 상세하고 구체적인 수치가 많이 들어가도록 전문성 있는 보고서를 작성해주세요.
                            {year} 년도로부터 최신순으로 분석한 보고서를 작성해주세요
                            
                            ##보고서 형식:
                            1. 모든 섹션은 독립적인 소보고서로 마크다운 형식으로 작성되어야 합니다
                            2. 제목은 반드시 "# [번호]. [제목] 보고서"로 시작 (예: "# 1. 주가 및 기술적 분석 보고서")
                            3. 각 섹션은 마크다운 형식의 명확한 구분선으로 분리
                            4. 보고서의 제목 앞에 제일 첫 부분은 Enter키(개행문자)를 친 뒤에 시작합니다. (예시 : (개행문자) # 1. 제목)
                            5. 제목과 본문 사이에는 반드시 개행문자를 2번 넣어 충분한 여백을 확보해주세요
                            
                            ##항목 구조화:
                            1. 모든 주요 항목은 "1.", "2." 형식의 번호 사용
                            2. 하위 항목은 "1.1", "1.2" 형식으로 통일
                            3. 각 항목에는 설명적인 제목 필수 (예: "1. 수익성 분석", "1.1 영업이익률 추이")
                            
                            ##제외사항:
                            1. 기업 기본정보는 생략합니다
                            2. 해당 분석과 직접 관련없는 일반적인 산업 설명은 제외합니다
                            3. 분석 목적과 무관한 데이터는 포함하지 않습니다
                            
                            ##주의사항:
                            1. 본 보고서는 [기업 분석 주제]에 한정된 분석만 다룹니다
                            2. 다른 보고서의 주제(재무분석, 기업개요 등)는 다루지 않습니다
                            3. 데이터 인용 시 반드시 출처와 기준일자를 명시합니다 (출처 : https://comp.wisereport.co.kr/)


                            ## 말투 지침:
                            - 전문적이고 객관적인 문어체를 사용하세요
                            - 모든 문장은 '~합니다', '~입니다'와 같은 높임말로 통일하세요
                            - 개인적 의견이나 감정표현은 피하세요 ('~것 같습니다', '~보입니다' 대신 '~나타납니다', '~확인됩니다' 사용)
                            - 질문형 문장은 사용하지 마세요
                            - 모든 에이전트가 동일한 말투를 유지할 수 있도록 해당 지침을 따르세요
                            
                            ## 보고서 작성 지침:
                            1. 길이: 5,000자 이상으로 작성 (중복되는 내용 없이 핵심만 포함)
                            2. 데이터: 모든 분석은 구체적 수치와 기간을 명시할 것
                            3. 객관성: 개인적 견해보다 데이터에 기반한 객관적 분석 제시
                            4. 일관성: 다른 섹션과 중복되지 않도록 주가/기술적 분석에만 집중
                            5. 시각화: 주요 지표와 패턴은 표 형식으로 요약하여 제시
                            6. 금지사항 : 결론에 해당하는 문단은 만들지 말 것. 해당 보고서는 섹션 중 하나이기 때문
                            7. 필수 입력 : 보고서 작성시 맨 앞에 개행문자를 2번 연속 입력하여 반드시 여백을 확보하고 시작하세요 (\n\n)
                            
                            ##분석 항목:
                            - 사업 구조 분석
                            - 경영 전략 분석
                            - 핵심 역량 분석
                            - 비즈니스 모델 분석
                            
                            보고서 제목은 "# 4. 기업 사업 구조 및 전략 분석"으로 시작하세요.
                            제목은 눈에 잘 보이게 큰 양식으로 적고 나머지 분석 항목들은 작은 양식으로 적어주세요.
                            기업: {company_name} ({company_code})
                            ##분석일 : {reference_date}(YYYYMMDD 형식)
                            """
            ),
            "corporate_status": Agent(
                name="status_analyst",
                instruction=f"""당신은 기업 현황 분석 전문가입니다. 수집된 기업 현황 데이터를 바탕으로 객관적이고 데이터 중심의 분석 보고서를 작성하세요.
                            최대한 상세하고 구체적인 수치가 많이 들어가도록 전문성 있는 보고서를 작성해주세요.
                            {year} 년도로부터 최신순으로 분석한 보고서를 작성해주세요:
                            
                            ##보고서 형식:
                            1. 모든 섹션은 독립적인 소보고서로 마크다운 형식으로 작성되어야 합니다
                            2. 제목은 반드시 "# [번호]. [제목] 보고서"로 시작 (예: "# 1. 주가 및 기술적 분석 보고서")
                            3. 각 섹션은 마크다운 형식의 명확한 구분선으로 분리
                            4. 보고서의 제목 앞에 제일 첫 부분은 Enter키(개행문자)를 친 뒤에 시작합니다. (예시 : (개행문자) # 1. 제목)
                            5. 제목과 본문 사이에는 반드시 개행문자를 2번 넣어 충분한 여백을 확보해주세요
                            
                            ##항목 구조화:
                            1. 모든 주요 항목은 "1.", "2." 형식의 번호 사용
                            2. 하위 항목은 "1.1", "1.2" 형식으로 통일
                            3. 각 항목에는 설명적인 제목 필수 (예: "1. 수익성 분석", "1.1 영업이익률 추이")
                            
                            ##제외사항:
                            1. 기업 기본정보는 생략합니다
                            2. 해당 분석과 직접 관련없는 일반적인 산업 설명은 제외합니다
                            3. 분석 목적과 무관한 데이터는 포함하지 않습니다
                            
                            ##주의사항:
                            1. 본 보고서는 [기업 현황 분석 주제]에 한정된 분석만 다룹니다
                            2. 다른 보고서의 주제(재무분석, 기업개요 등)는 다루지 않습니다
                            3. 데이터 인용 시 반드시 출처와 기준일자를 명시합니다 (출처 : https://comp.wisereport.co.kr/)


                            ## 말투 지침:
                            - 전문적이고 객관적인 문어체를 사용하세요
                            - 모든 문장은 '~합니다', '~입니다'와 같은 높임말로 통일하세요
                            - 개인적 의견이나 감정표현은 피하세요 ('~것 같습니다', '~보입니다' 대신 '~나타납니다', '~확인됩니다' 사용)
                            - 질문형 문장은 사용하지 마세요
                            - 모든 에이전트가 동일한 말투를 유지할 수 있도록 해당 지침을 따르세요
                            
                            ## 보고서 작성 지침:
                            1. 길이: 5,000자 이상으로 작성 (중복되는 내용 없이 핵심만 포함)
                            2. 데이터: 모든 분석은 구체적 수치와 기간을 명시할 것
                            3. 객관성: 개인적 견해보다 데이터에 기반한 객관적 분석 제시
                            4. 일관성: 다른 섹션과 중복되지 않도록 주가/기술적 분석에만 집중
                            5. 시각화: 주요 지표와 패턴은 표 형식으로 요약하여 제시
                            6. 금지사항 : 결론에 해당하는 문단은 만들지 말 것. 해당 보고서는 섹션 중 하나이기 때문
                            7. 필수 입력 : 보고서 작성시 맨 앞에 개행문자를 2번 연속 입력하여 반드시 여백을 확보하고 시작하세요 (\n\n)
                            
                            ##분석 항목:
                            - 첨부된 참고데이터 
                            
                            보고서 제목은 "# 5. 기업 지배구조 및 경영 현황 분석"으로 시작하세요.
                            제목은 눈에 잘 보이게 큰 양식으로 적고 나머지 분석 항목들은 작은 양식으로 적어주세요.
                            기업: {company_name} ({company_code})
                            ##분석일 : {reference_date}(YYYYMMDD 형식)
                            """
            ),
            "fundamental_data": Agent(
                name="fundamental_analyst",
                instruction=f"""당신은 기업 재무 분석 전문가입니다. 수집된 재무 데이터를 바탕으로 객관적이고 데이터 중심의 분석 보고서를 작성하세요.
                            최대한 상세하고 구체적인 수치가 많이 들어가도록 전문성 있는 보고서를 작성해주세요.
                            {reference_date} 날짜(YYYYMMDD 형식)로부터 최신순으로 분석한 보고서를 작성해주세요:
                            
                            ##보고서 형식:
                            1. 모든 섹션은 독립적인 소보고서로 마크다운 형식으로 작성되어야 합니다
                            2. 제목은 반드시 "# [번호]. [제목] 보고서"로 시작 (예: "# 1. 주가 및 기술적 분석 보고서")
                            3. 각 섹션은 마크다운 형식의 명확한 구분선으로 분리
                            4. 보고서의 제목 앞에 제일 첫 부분은 Enter키(개행문자)를 친 뒤에 시작합니다. (예시 : (개행문자) # 1. 제목)
                            5. 제목과 본문 사이에는 반드시 개행문자를 2번 넣어 충분한 여백을 확보해주세요
                            
                            ##항목 구조화:
                            1. 모든 주요 항목은 "1.", "2." 형식의 번호 사용
                            2. 하위 항목은 "1.1", "1.2" 형식으로 통일
                            3. 각 항목에는 설명적인 제목 필수 (예: "1. 수익성 분석", "1.1 영업이익률 추이")
                            
                            ##제외사항:
                            1. 기업 기본정보는 생략합니다
                            2. 해당 분석과 직접 관련없는 일반적인 산업 설명은 제외합니다
                            3. 분석 목적과 무관한 데이터는 포함하지 않습니다
                            
                            ##주의사항:
                            1. 본 보고서는 [기업 재무 분석 주제]에 한정된 분석만 다룹니다
                            2. 다른 보고서의 주제(재무분석, 기업개요 등)는 다루지 않습니다
                            3. 데이터 인용 시 반드시 출처와 기준일자를 명시합니다 (출처 : https://comp.wisereport.co.kr/)

                            ## 말투 지침:
                            - 전문적이고 객관적인 문어체를 사용하세요
                            - 모든 문장은 '~합니다', '~입니다'와 같은 높임말로 통일하세요
                            - 개인적 의견이나 감정표현은 피하세요 ('~것 같습니다', '~보입니다' 대신 '~나타납니다', '~확인됩니다' 사용)
                            - 질문형 문장은 사용하지 마세요
                            - 모든 에이전트가 동일한 말투를 유지할 수 있도록 해당 지침을 따르세요
                            
                            ## 보고서 작성 지침:
                            1. 길이: 5,000자 이상으로 작성 (중복되는 내용 없이 핵심만 포함)
                            2. 데이터: 모든 분석은 구체적 수치와 기간을 명시할 것
                            3. 객관성: 개인적 견해보다 데이터에 기반한 객관적 분석 제시
                            4. 일관성: 다른 섹션과 중복되지 않도록 주가/기술적 분석에만 집중
                            5. 시각화: 주요 지표와 패턴은 표 형식으로 요약하여 제시
                            6. 금지사항 : 결론에 해당하는 문단은 만들지 말 것. 해당 보고서는 섹션 중 하나이기 때문
                            7. 필수 입력 : 보고서 작성시 맨 앞에 개행문자를 2번 연속 입력하여 반드시 여백을 확보하고 시작하세요 (\n\n)
                            
                            ##분석 항목:
                            - 첨부된 참고데이터
                            
                            보고서 제목은 "# 6. 재무 및 기본적 분석"으로 시작하세요.
                            제목은 눈에 잘 보이게 큰 양식으로 적고 나머지 분석 항목들은 작은 양식으로 적어주세요.
                            기업: {company_name} ({company_code})
                            ##분석일 : {reference_date}(YYYYMMDD 형식)
                            """
            ),
            "financial_analysis1": Agent(
                name="finance_analyst1",
                instruction=f"""당신은 심층 재무 분석 전문가(포괄손익계산서 전문)입니다. 수집된 재무 분석 데이터(포괄손익계산서)를 바탕으로 객관적이고 데이터 중심의 분석 보고서를 작성하세요.
                            최대한 상세하고 구체적인 수치가 많이 들어가도록 전문성 있는 보고서를 작성해주세요.
                            {year} 년도로부터 최신순으로 분석한 보고서를 작성해주세요:
                            
                            ##보고서 형식:
                            1. 모든 섹션은 독립적인 소보고서로 마크다운 형식으로 작성되어야 합니다
                            2. 제목은 반드시 "# [번호]. [제목] 보고서"로 시작 (예: "# 1. 주가 및 기술적 분석 보고서")
                            3. 각 섹션은 마크다운 형식의 명확한 구분선으로 분리
                            4. 보고서의 제목 앞에 제일 첫 부분은 Enter키(개행문자)를 친 뒤에 시작합니다. (예시 : (개행문자) # 1. 제목)
                            5. 제목과 본문 사이에는 반드시 개행문자를 2번 넣어 충분한 여백을 확보해주세요
                            
                            ##항목 구조화:
                            1. 모든 주요 항목은 "1.", "2." 형식의 번호 사용
                            2. 하위 항목은 "1.1", "1.2" 형식으로 통일
                            3. 각 항목에는 설명적인 제목 필수 (예: "1. 수익성 분석", "1.1 영업이익률 추이")
                            
                            ##제외사항:
                            1. 기업 기본정보는 생략합니다
                            2. 해당 분석과 직접 관련없는 일반적인 산업 설명은 제외합니다
                            3. 분석 목적과 무관한 데이터는 포함하지 않습니다
                            
                            ##주의사항:
                            1. 본 보고서는 [심층 재무 분석(포괄손익계산서) 주제]에 한정된 분석만 다룹니다
                            2. 다른 보고서의 주제(재무분석, 기업개요 등)는 다루지 않습니다
                            3. 데이터 인용 시 반드시 출처와 기준일자를 명시합니다 (출처 : https://comp.wisereport.co.kr/)

                            ## 말투 지침:
                            - 전문적이고 객관적인 문어체를 사용하세요
                            - 모든 문장은 '~합니다', '~입니다'와 같은 높임말로 통일하세요
                            - 개인적 의견이나 감정표현은 피하세요 ('~것 같습니다', '~보입니다' 대신 '~나타납니다', '~확인됩니다' 사용)
                            - 질문형 문장은 사용하지 마세요
                            - 모든 에이전트가 동일한 말투를 유지할 수 있도록 해당 지침을 따르세요
                            
                            ## 보고서 작성 지침:
                            1. 길이: 5,000자 이상으로 작성 (중복되는 내용 없이 핵심만 포함)
                            2. 데이터: 모든 분석은 구체적 수치와 기간을 명시할 것
                            3. 객관성: 개인적 견해보다 데이터에 기반한 객관적 분석 제시
                            4. 일관성: 다른 섹션과 중복되지 않도록 주가/기술적 분석에만 집중
                            5. 시각화: 주요 지표와 패턴은 표 형식으로 요약하여 제시
                            6. 금지사항 : 결론에 해당하는 문단은 만들지 말 것. 해당 보고서는 섹션 중 하나이기 때문
                            7. 필수 입력 : 보고서 작성시 맨 앞에 개행문자를 2번 연속 입력하여 반드시 여백을 확보하고 시작하세요 (\n\n)
                            
                            ##분석 항목:
                            - 첨부된 참고데이터
                            
                            보고서 제목은 "# 7-1. 심층 재무제표 분석(포괄손익계산서)"으로 시작하시고, 제일 앞에 개행문자를 넣어 문단을 띄워주세요.
                            제목은 눈에 잘 보이게 큰 양식으로 적고 나머지 분석 항목들은 작은 양식으로 적어주세요.
                            기업: {company_name} ({company_code})
                            ##분석일 : {reference_date}(YYYYMMDD 형식)
                            """
            ),
            "financial_analysis2": Agent(
                name="finance_analyst2",
                instruction=f"""당신은 심층 재무 분석 전문가(재무상태표 전문)입니다. 수집된 재무 분석 데이터(재무상태표)를 바탕으로 객관적이고 데이터 중심의 분석 보고서를 작성하세요.
                            최대한 상세하고 구체적인 수치가 많이 들어가도록 전문성 있는 보고서를 작성해주세요.
                            {year} 년도로부터 최신순으로 분석한 보고서를 작성해주세요:
                            
                            ##보고서 형식:
                            1. 모든 섹션은 독립적인 소보고서로 마크다운 형식으로 작성되어야 합니다
                            2. 제목은 반드시 "# [번호]. [제목] 보고서"로 시작 (예: "# 1. 주가 및 기술적 분석 보고서")
                            3. 각 섹션은 마크다운 형식의 명확한 구분선으로 분리
                            4. 보고서의 제목 앞에 제일 첫 부분은 Enter키(개행문자)를 친 뒤에 시작합니다. (예시 : (개행문자) # 1. 제목)
                            5. 제목과 본문 사이에는 반드시 개행문자를 2번 넣어 충분한 여백을 확보해주세요
                            
                            ##항목 구조화:
                            1. 모든 주요 항목은 "1.", "2." 형식의 번호 사용
                            2. 하위 항목은 "1.1", "1.2" 형식으로 통일
                            3. 각 항목에는 설명적인 제목 필수 (예: "1. 수익성 분석", "1.1 영업이익률 추이")
                            
                            ##제외사항:
                            1. 기업 기본정보는 생략합니다
                            2. 해당 분석과 직접 관련없는 일반적인 산업 설명은 제외합니다
                            3. 분석 목적과 무관한 데이터는 포함하지 않습니다
                            
                            ##주의사항:
                            1. 본 보고서는 [심층 재무 분석(재무상태표) 주제]에 한정된 분석만 다룹니다
                            2. 다른 보고서의 주제(재무분석, 기업개요 등)는 다루지 않습니다
                            3. 데이터 인용 시 반드시 출처와 기준일자를 명시합니다 (출처 : https://comp.wisereport.co.kr/)

                            ## 말투 지침:
                            - 전문적이고 객관적인 문어체를 사용하세요
                            - 모든 문장은 '~합니다', '~입니다'와 같은 높임말로 통일하세요
                            - 개인적 의견이나 감정표현은 피하세요 ('~것 같습니다', '~보입니다' 대신 '~나타납니다', '~확인됩니다' 사용)
                            - 질문형 문장은 사용하지 마세요
                            - 모든 에이전트가 동일한 말투를 유지할 수 있도록 해당 지침을 따르세요
                            
                            ## 보고서 작성 지침:
                            1. 길이: 5,000자 이상으로 작성 (중복되는 내용 없이 핵심만 포함)
                            2. 데이터: 모든 분석은 구체적 수치와 기간을 명시할 것
                            3. 객관성: 개인적 견해보다 데이터에 기반한 객관적 분석 제시
                            4. 일관성: 다른 섹션과 중복되지 않도록 주가/기술적 분석에만 집중
                            5. 시각화: 주요 지표와 패턴은 표 형식으로 요약하여 제시
                            6. 금지사항 : 결론에 해당하는 문단은 만들지 말 것. 해당 보고서는 섹션 중 하나이기 때문
                            7. 필수 입력 : 보고서 작성시 맨 앞에 개행문자를 2번 연속 입력하여 반드시 여백을 확보하고 시작하세요 (\n\n)
                            
                            ##분석 항목:
                            - 첨부된 참고데이터
                            
                            보고서 제목은 "# 7-2. 심층 재무제표 분석(재무상태표)"으로 시작하세요.
                            제목은 눈에 잘 보이게 큰 양식으로 적고 나머지 분석 항목들은 작은 양식으로 적어주세요.
                            기업: {company_name} ({company_code})
                            ##분석일 : {reference_date}(YYYYMMDD 형식)
                            """
            ),
            "financial_analysis3": Agent(
                name="finance_analyst3",
                instruction=f"""당신은 심층 재무 분석 전문가(현금흐름표 전문)입니다. 수집된 재무 분석 데이터(현금흐름표)를 바탕으로 객관적이고 데이터 중심의 분석 보고서를 작성하세요.
                            최대한 상세하고 구체적인 수치가 많이 들어가도록 전문성 있는 보고서를 작성해주세요.
                            {year} 년도로부터 최신순으로 분석한 보고서를 작성해주세요:
                            
                            ##보고서 형식:
                            1. 모든 섹션은 독립적인 소보고서로 마크다운 형식으로 작성되어야 합니다
                            2. 제목은 반드시 "# [번호]. [제목] 보고서"로 시작 (예: "# 1. 주가 및 기술적 분석 보고서")
                            3. 각 섹션은 마크다운 형식의 명확한 구분선으로 분리
                            4. 보고서의 제목 앞에 제일 첫 부분은 Enter키(개행문자)를 친 뒤에 시작합니다. (예시 : (개행문자) # 1. 제목)
                            5. 제목과 본문 사이에는 반드시 개행문자를 2번 넣어 충분한 여백을 확보해주세요
                            
                            ##항목 구조화:
                            1. 모든 주요 항목은 "1.", "2." 형식의 번호 사용
                            2. 하위 항목은 "1.1", "1.2" 형식으로 통일
                            3. 각 항목에는 설명적인 제목 필수 (예: "1. 수익성 분석", "1.1 영업이익률 추이")
                            
                            ##제외사항:
                            1. 기업 기본정보는 생략합니다
                            2. 해당 분석과 직접 관련없는 일반적인 산업 설명은 제외합니다
                            3. 분석 목적과 무관한 데이터는 포함하지 않습니다
                            
                            ##주의사항:
                            1. 본 보고서는 [심층 재무 분석(재무상태표) 주제]에 한정된 분석만 다룹니다
                            2. 다른 보고서의 주제(재무분석, 기업개요 등)는 다루지 않습니다
                            3. 데이터 인용 시 반드시 출처와 기준일자를 명시합니다 (출처 : https://comp.wisereport.co.kr/)

                            ## 말투 지침:
                            - 전문적이고 객관적인 문어체를 사용하세요
                            - 모든 문장은 '~합니다', '~입니다'와 같은 높임말로 통일하세요
                            - 개인적 의견이나 감정표현은 피하세요 ('~것 같습니다', '~보입니다' 대신 '~나타납니다', '~확인됩니다' 사용)
                            - 질문형 문장은 사용하지 마세요
                            - 모든 에이전트가 동일한 말투를 유지할 수 있도록 해당 지침을 따르세요
                            
                            ## 보고서 작성 지침:
                            1. 길이: 5,000자 이상으로 작성 (중복되는 내용 없이 핵심만 포함)
                            2. 데이터: 모든 분석은 구체적 수치와 기간을 명시할 것
                            3. 객관성: 개인적 견해보다 데이터에 기반한 객관적 분석 제시
                            4. 일관성: 다른 섹션과 중복되지 않도록 주가/기술적 분석에만 집중
                            5. 시각화: 주요 지표와 패턴은 표 형식으로 요약하여 제시
                            6. 금지사항 : 결론에 해당하는 문단은 만들지 말 것. 해당 보고서는 섹션 중 하나이기 때문
                            7. 필수 입력 : 보고서 작성시 맨 앞에 개행문자를 2번 연속 입력하여 반드시 여백을 확보하고 시작하세요 (\n\n)
                            
                            ##분석 항목:
                            - 첨부된 참고데이터
                            
                            보고서 제목은 "# 7-3. 심층 재무제표 분석(현금흐름표)"으로 시작하세요.
                            제목은 눈에 잘 보이게 큰 양식으로 적고 나머지 분석 항목들은 작은 양식으로 적어주세요.
                            기업: {company_name} ({company_code})
                            ##분석일 : {reference_date}(YYYYMMDD 형식)
                            """
            ),
            "investment_indicators": Agent(
                name="investment_analyst",
                instruction=f"""당신은 투자 지표 분석 전문가입니다. 수집된 투자 지표 데이터를 바탕으로 객관적이고 데이터 중심의 분석 보고서를 작성하세요.
                            최대한 상세하고 구체적인 수치가 많이 들어가도록 전문성 있는 보고서를 작성해주세요.
                            {year} 년도로부터 최신순으로 분석한 보고서를 작성해주세요:
                            
                            ##보고서 형식:
                            1. 모든 섹션은 독립적인 소보고서로 마크다운 형식으로 작성되어야 합니다
                            2. 제목은 반드시 "# [번호]. [제목] 보고서"로 시작 (예: "# 1. 주가 및 기술적 분석 보고서")
                            3. 각 섹션은 마크다운 형식의 명확한 구분선으로 분리
                            4. 보고서의 제목 앞에 제일 첫 부분은 Enter키(개행문자)를 친 뒤에 시작합니다. (예시 : (개행문자) # 1. 제목)
                            5. 제목과 본문 사이에는 반드시 개행문자를 2번 넣어 충분한 여백을 확보해주세요
                            
                            ##항목 구조화:
                            1. 모든 주요 항목은 "1.", "2." 형식의 번호 사용
                            2. 하위 항목은 "1.1", "1.2" 형식으로 통일
                            3. 각 항목에는 설명적인 제목 필수 (예: "1. 수익성 분석", "1.1 영업이익률 추이")
                            
                            ##제외사항:
                            1. 기업 기본정보는 생략합니다
                            2. 해당 분석과 직접 관련없는 일반적인 산업 설명은 제외합니다
                            3. 분석 목적과 무관한 데이터는 포함하지 않습니다
                            
                            ##주의사항:
                            1. 본 보고서는 [투자 지표 분석 주제]에 한정된 분석만 다룹니다
                            2. 다른 보고서의 주제(재무분석, 기업개요 등)는 다루지 않습니다
                            3. 데이터 인용 시 반드시 출처와 기준일자를 명시합니다 (출처 : https://comp.wisereport.co.kr/)

                            ## 말투 지침:
                            - 전문적이고 객관적인 문어체를 사용하세요
                            - 모든 문장은 '~합니다', '~입니다'와 같은 높임말로 통일하세요
                            - 개인적 의견이나 감정표현은 피하세요 ('~것 같습니다', '~보입니다' 대신 '~나타납니다', '~확인됩니다' 사용)
                            - 질문형 문장은 사용하지 마세요
                            - 모든 에이전트가 동일한 말투를 유지할 수 있도록 해당 지침을 따르세요
                            
                            ## 보고서 작성 지침:
                            1. 길이: 5,000자 이상으로 작성 (중복되는 내용 없이 핵심만 포함)
                            2. 데이터: 모든 분석은 구체적 수치와 기간을 명시할 것
                            3. 객관성: 개인적 견해보다 데이터에 기반한 객관적 분석 제시
                            4. 일관성: 다른 섹션과 중복되지 않도록 주가/기술적 분석에만 집중
                            5. 시각화: 주요 지표와 패턴은 표 형식으로 요약하여 제시
                            6. 금지사항 : 결론에 해당하는 문단은 만들지 말 것. 해당 보고서는 섹션 중 하나이기 때문
                            7. 필수 입력 : 보고서 작성시 맨 앞에 개행문자를 2번 연속 입력하여 반드시 여백을 확보하고 시작하세요 (\n\n)
                            
                            ##분석 항목:
                            - 첨부된 참고데이터
                            
                            보고서 제목은 "# 8. 투자 지표 및 가치 평가 분석"으로 시작하세요.
                            제목은 눈에 잘 보이게 큰 양식으로 적고 나머지 분석 항목들은 작은 양식으로 적어주세요.
                            기업: {company_name} ({company_code})
                            ##분석일 : {reference_date}(YYYYMMDD 형식)
                            """
            ),
            "competitor_analysis": Agent(
                name="competitor_analyst",
                instruction=f"""당신은 경쟁사 분석 전문가입니다. 수집된 경쟁사 분석 데이터를 바탕으로 객관적이고 데이터 중심의 분석 보고서를 작성하세요.
                            최대한 상세하고 구체적인 수치가 많이 들어가도록 전문성 있는 보고서를 작성해주세요.
                            {year} 년도로부터 최신순으로 분석한 보고서를 작성해주세요:
                            
                            ##보고서 형식:
                            1. 모든 섹션은 독립적인 소보고서로 마크다운 형식으로 작성되어야 합니다
                            2. 제목은 반드시 "# [번호]. [제목] 보고서"로 시작 (예: "# 1. 주가 및 기술적 분석 보고서")
                            3. 각 섹션은 마크다운 형식의 명확한 구분선으로 분리
                            4. 보고서의 제목 앞에 제일 첫 부분은 Enter키(개행문자)를 친 뒤에 시작합니다. (예시 : (개행문자) # 1. 제목)
                            5. 제목과 본문 사이에는 반드시 개행문자를 2번 넣어 충분한 여백을 확보해주세요
                            
                            ##항목 구조화:
                            1. 모든 주요 항목은 "1.", "2." 형식의 번호 사용
                            2. 하위 항목은 "1.1", "1.2" 형식으로 통일
                            3. 각 항목에는 설명적인 제목 필수 (예: "1. 수익성 분석", "1.1 영업이익률 추이")
                            
                            ##제외사항:
                            1. 기업 기본정보는 생략합니다
                            2. 해당 분석과 직접 관련없는 일반적인 산업 설명은 제외합니다
                            3. 분석 목적과 무관한 데이터는 포함하지 않습니다
                            
                            ##주의사항:
                            1. 본 보고서는 [경쟁사 분석 주제]에 한정된 분석만 다룹니다
                            2. 다른 보고서의 주제(재무분석, 기업개요 등)는 다루지 않습니다
                            3. 데이터 인용 시 반드시 출처와 기준일자를 명시합니다 (출처 : https://comp.wisereport.co.kr/)

                            ## 말투 지침:
                            - 전문적이고 객관적인 문어체를 사용하세요
                            - 모든 문장은 '~합니다', '~입니다'와 같은 높임말로 통일하세요
                            - 개인적 의견이나 감정표현은 피하세요 ('~것 같습니다', '~보입니다' 대신 '~나타납니다', '~확인됩니다' 사용)
                            - 질문형 문장은 사용하지 마세요
                            - 모든 에이전트가 동일한 말투를 유지할 수 있도록 해당 지침을 따르세요
                            
                            ## 보고서 작성 지침:
                            1. 길이: 5,000자 이상으로 작성 (중복되는 내용 없이 핵심만 포함)
                            2. 데이터: 모든 분석은 구체적 수치와 기간을 명시할 것
                            3. 객관성: 개인적 견해보다 데이터에 기반한 객관적 분석 제시
                            4. 일관성: 다른 섹션과 중복되지 않도록 주가/기술적 분석에만 집중
                            5. 시각화: 주요 지표와 패턴은 표 형식으로 요약하여 제시
                            6. 금지사항 : 결론에 해당하는 문단은 만들지 말 것. 해당 보고서는 섹션 중 하나이기 때문
                            7. 필수 입력 : 보고서 작성시 맨 앞에 개행문자를 2번 연속 입력하여 반드시 여백을 확보하고 시작하세요 (\n\n)
                            
                            ##분석 항목:
                            - 첨부된 참고데이터
                            
                            보고서 제목은 "# 9. 경쟁사 비교 분석"으로 시작하세요.
                            제목은 눈에 잘 보이게 큰 양식으로 적고 나머지 분석 항목들은 작은 양식으로 적어주세요.
                            기업: {company_name} ({company_code})
                            ##분석일 : {reference_date}(YYYYMMDD 형식)
                            """
            ),
            "consensus_data": Agent(
                name="consensus_analyst",
                instruction=f"""당신은 애널리스트 컨센서스 분석 전문가입니다. 수집된 컨센서스 데이터를 바탕으로 객관적이고 데이터 중심의 분석 보고서를 작성하세요.
                            최대한 상세하고 구체적인 수치가 많이 들어가도록 전문성 있는 보고서를 작성해주세요.
                            {year} 년도로부터 최신순으로 분석한 보고서를 작성해주세요:
                            
                            ##보고서 형식:
                            1. 모든 섹션은 독립적인 소보고서로 마크다운 형식으로 작성되어야 합니다
                            2. 제목은 반드시 "# [번호]. [제목] 보고서"로 시작 (예: "# 1. 주가 및 기술적 분석 보고서")
                            3. 각 섹션은 마크다운 형식의 명확한 구분선으로 분리
                            4. 보고서의 제목 앞에 제일 첫 부분은 Enter키(개행문자)를 친 뒤에 시작합니다. (예시 : (개행문자) # 1. 제목)
                            5. 제목과 본문 사이에는 반드시 개행문자를 2번 넣어 충분한 여백을 확보해주세요
                            
                            ##항목 구조화:
                            1. 모든 주요 항목은 "1.", "2." 형식의 번호 사용
                            2. 하위 항목은 "1.1", "1.2" 형식으로 통일
                            3. 각 항목에는 설명적인 제목 필수 (예: "1. 수익성 분석", "1.1 영업이익률 추이")
                            
                            ##제외사항:
                            1. 기업 기본정보는 생략합니다
                            2. 해당 분석과 직접 관련없는 일반적인 산업 설명은 제외합니다
                            3. 분석 목적과 무관한 데이터는 포함하지 않습니다
                            
                            ##주의사항:
                            1. 본 보고서는 [애널리스트 컨센서스 분석 주제]에 한정된 분석만 다룹니다
                            2. 다른 보고서의 주제(재무분석, 기업개요 등)는 다루지 않습니다
                            3. 데이터 인용 시 반드시 출처와 기준일자를 명시합니다 (출처 : https://comp.wisereport.co.kr/)


                            ## 말투 지침:
                            - 전문적이고 객관적인 문어체를 사용하세요
                            - 모든 문장은 '~합니다', '~입니다'와 같은 높임말로 통일하세요
                            - 개인적 의견이나 감정표현은 피하세요 ('~것 같습니다', '~보입니다' 대신 '~나타납니다', '~확인됩니다' 사용)
                            - 질문형 문장은 사용하지 마세요
                            - 모든 에이전트가 동일한 말투를 유지할 수 있도록 해당 지침을 따르세요
                            
                            ## 보고서 작성 지침:
                            1. 길이: 5,000자 이상으로 작성 (중복되는 내용 없이 핵심만 포함)
                            2. 데이터: 모든 분석은 구체적 수치와 기간을 명시할 것
                            3. 객관성: 개인적 견해보다 데이터에 기반한 객관적 분석 제시
                            4. 일관성: 다른 섹션과 중복되지 않도록 주가/기술적 분석에만 집중
                            5. 시각화: 주요 지표와 패턴은 표 형식으로 요약하여 제시
                            6. 금지사항 : 결론에 해당하는 문단은 만들지 말 것. 해당 보고서는 섹션 중 하나이기 때문
                            7. 필수 입력 : 보고서 작성시 맨 앞에 개행문자를 2번 연속 입력하여 반드시 여백을 확보하고 시작하세요 (\n\n)
                            
                            ##분석 항목:
                            - 첨부된 참고데이터
                            
                            보고서 제목은 "# 10. 애널리스트 컨센서스 분석"으로 시작하세요.
                            제목은 눈에 잘 보이게 큰 양식으로 적고 나머지 분석 항목들은 작은 양식으로 적어주세요.
                            기업: {company_name} ({company_code})
                            ##분석일 : {reference_date}(YYYYMMDD 형식)
                            """
            ),
            "etc_analysis": Agent(
                name="etc_analyst",
                instruction=f"""당신은 지분현황/업종분석/최근리포트 분석 전문가입니다. 수집된 지분현황/업종분석/최근리포트 분석 데이터를 바탕으로 객관적이고 데이터 중심의 분석 보고서를 작성하세요.
                            최대한 상세하고 구체적인 수치가 많이 들어가도록 전문성 있는 보고서를 작성해주세요.
                            {year} 년도로부터 최신순으로 분석한 보고서를 작성해주세요:
                            
                            ##보고서 형식:
                            1. 모든 섹션은 독립적인 소보고서로 마크다운 형식으로 작성되어야 합니다
                            2. 제목은 반드시 "# [번호]. [제목] 보고서"로 시작 (예: "# 1. 주가 및 기술적 분석 보고서")
                            3. 각 섹션은 마크다운 형식의 명확한 구분선으로 분리
                            4. 보고서의 제목 앞에 제일 첫 부분은 Enter키(개행문자)를 친 뒤에 시작합니다. (예시 : (개행문자) # 1. 제목)
                            5. 제목과 본문 사이에는 반드시 개행문자를 2번 넣어 충분한 여백을 확보해주세요
                            
                            ##항목 구조화:
                            1. 모든 주요 항목은 "1.", "2." 형식의 번호 사용
                            2. 하위 항목은 "1.1", "1.2" 형식으로 통일
                            3. 각 항목에는 설명적인 제목 필수 (예: "1. 수익성 분석", "1.1 영업이익률 추이")
                            
                            ##제외사항:
                            1. 기업 기본정보는 생략합니다
                            2. 해당 분석과 직접 관련없는 일반적인 산업 설명은 제외합니다
                            3. 분석 목적과 무관한 데이터는 포함하지 않습니다
                            
                            ##주의사항:
                            1. 본 보고서는 [지분현황/업종분석/최근리포트 분석 주제]에 한정된 분석만 다룹니다
                            2. 다른 보고서의 주제(재무분석, 기업개요 등)는 다루지 않습니다
                            3. 데이터 인용 시 반드시 출처와 기준일자를 명시합니다 (출처 : https://comp.wisereport.co.kr/)

                            ## 말투 지침:
                            - 전문적이고 객관적인 문어체를 사용하세요
                            - 모든 문장은 '~합니다', '~입니다'와 같은 높임말로 통일하세요
                            - 개인적 의견이나 감정표현은 피하세요 ('~것 같습니다', '~보입니다' 대신 '~나타납니다', '~확인됩니다' 사용)
                            - 질문형 문장은 사용하지 마세요
                            - 모든 에이전트가 동일한 말투를 유지할 수 있도록 해당 지침을 따르세요
                            
                            ## 보고서 작성 지침:
                            1. 길이: 5,000자 이상으로 작성 (중복되는 내용 없이 핵심만 포함)
                            2. 데이터: 모든 분석은 구체적 수치와 기간을 명시할 것
                            3. 객관성: 개인적 견해보다 데이터에 기반한 객관적 분석 제시
                            4. 일관성: 다른 섹션과 중복되지 않도록 주가/기술적 분석에만 집중
                            5. 시각화: 주요 지표와 패턴은 표 형식으로 요약하여 제시
                            6. 금지사항 : 결론에 해당하는 문단은 만들지 말 것. 해당 보고서는 섹션 중 하나이기 때문
                            7. 필수 입력 : 보고서 작성시 맨 앞에 개행문자를 2번 연속 입력하여 반드시 여백을 확보하고 시작하세요 (\n\n)
                            
                            ##분석 항목:
                            - 첨부된 참고데이터
                            
                            보고서 제목은 "# 11. 지분현황/업종분석/최근리포트 분석"으로 시작하세요.
                            제목은 눈에 잘 보이게 큰 양식으로 적고 나머지 분석 항목들은 작은 양식으로 적어주세요.
                            기업: {company_name} ({company_code})
                            ##분석일 : {reference_date}(YYYYMMDD 형식)
                            """
            ),
            "news_data": Agent(
                name="news_analyst",
                instruction=f"""당신은 뉴스 및 시장 트렌드 분석 전문가입니다. 수집된 뉴스 데이터를 바탕으로 객관적이고 데이터 중심의 분석 보고서를 작성하세요.
                            최대한 상세하고 구체적인 수치가 많이 들어가도록 전문성 있는 보고서를 작성해주세요.
                            {reference_date} 날짜(YYYYMMDD 형식)로부터 최신순으로 분석한 보고서를 작성해주세요:
                            
                            ##보고서 형식:
                            1. 모든 섹션은 독립적인 소보고서로 마크다운 형식으로 작성되어야 합니다
                            2. 제목은 반드시 "# [번호]. [제목] 보고서"로 시작 (예: "# 1. 주가 및 기술적 분석 보고서")
                            3. 각 섹션은 마크다운 형식의 명확한 구분선으로 분리
                            4. 보고서의 제목 앞에 제일 첫 부분은 Enter키(개행문자)를 친 뒤에 시작합니다. (예시 : (개행문자) # 1. 제목)
                            5. 제목과 본문 사이에는 반드시 개행문자를 2번 넣어 충분한 여백을 확보해주세요
                            
                            ##항목 구조화:
                            1. 모든 주요 항목은 "1.", "2." 형식의 번호 사용
                            2. 하위 항목은 "1.1", "1.2" 형식으로 통일
                            3. 각 항목에는 설명적인 제목 필수 (예: "1. 수익성 분석", "1.1 영업이익률 추이")
                            
                            ##제외사항:
                            1. 기업 기본정보는 생략합니다
                            2. 해당 분석과 직접 관련없는 일반적인 산업 설명은 제외합니다
                            3. 분석 목적과 무관한 데이터는 포함하지 않습니다
                            
                            ##주의사항:
                            1. 본 보고서는 [뉴스 및 시장 트렌드 분석 주제]에 한정된 분석만 다룹니다
                            2. 다른 보고서의 주제(재무분석, 기업개요 등)는 다루지 않습니다
                            3. 데이터 인용 시 반드시 출처와 기준일자를 명시합니다 (출처 : https://comp.wisereport.co.kr/)

                            ## 말투 지침:
                            - 전문적이고 객관적인 문어체를 사용하세요
                            - 모든 문장은 '~합니다', '~입니다'와 같은 높임말로 통일하세요
                            - 개인적 의견이나 감정표현은 피하세요 ('~것 같습니다', '~보입니다' 대신 '~나타납니다', '~확인됩니다' 사용)
                            - 질문형 문장은 사용하지 마세요
                            - 모든 에이전트가 동일한 말투를 유지할 수 있도록 해당 지침을 따르세요
                            
                            ## 보고서 작성 지침:
                            1. 길이: 5,000자 이상으로 작성 (중복되는 내용 없이 핵심만 포함)
                            2. 데이터: 모든 분석은 구체적 수치와 기간을 명시할 것
                            3. 객관성: 개인적 견해보다 데이터에 기반한 객관적 분석 제시
                            4. 일관성: 다른 섹션과 중복되지 않도록 주가/기술적 분석에만 집중
                            5. 시각화: 주요 지표와 패턴은 표 형식으로 요약하여 제시
                            6. 금지사항 : 결론에 해당하는 문단은 만들지 말 것. 해당 보고서는 섹션 중 하나이기 때문
                            7. 필수 입력 : 보고서 작성시 맨 앞에 개행문자를 2번 연속 입력하여 반드시 여백을 확보하고 시작하세요 (\n\n)
                            
                            ##분석 항목:
                            - 첨부된 참고데이터
                            
                            보고서 제목은 "# 12. 뉴스 트렌드 및 시장 반응 분석"으로 시작하세요.
                            제목은 눈에 잘 보이게 큰 양식으로 적고 나머지 분석 항목들은 작은 양식으로 적어주세요.
                            기업: {company_name} ({company_code})
                            ##분석일 : {reference_date}(YYYYMMDD 형식)
                            """
            )
        }

        # 1. 병렬로 데이터 수집 수행
        collection_tasks = []
        with concurrent.futures.ThreadPoolExecutor(max_workers=2) as executor:  # worker 수 제한
            for i, (data_key, collector_agent) in enumerate(data_collectors.items()):
                collection_tasks.append(
                    collect_data(data_key, collector_agent, company_name, company_code,
                                 reference_date, logger, delay=i*10.0)  # 각 작업마다 10초씩 차이
                )

            results = await asyncio.gather(*collection_tasks)
            for data_key, data in results:
                collected_data[data_key] = data

        # 컬렉션 단계와 작성 단계 사이 30초 대기
        logger.info("Data collection completed. Waiting 30 seconds before report writing...")
        await asyncio.sleep(30)

        # 2. 병렬로 보고서 섹션 작성
        writing_tasks = []
        with concurrent.futures.ThreadPoolExecutor(max_workers=2) as executor:  # worker 수 제한
            for i, (data_key, writer_agent) in enumerate(report_writers.items()):
                writing_tasks.append(
                    write_report_section(data_key, writer_agent, collected_data,
                                         company_name, company_code, reference_date,
                                         logger, delay=i*10.0)  # 각 작업마다 10초씩 차이
                )

            results = await asyncio.gather(*writing_tasks)
            for data_key, report in results:
                if report:
                    section_reports[data_key] = report

        # 3. 최종 보고서 조합 및 정리
        final_report = ""
        for data_key in report_writers.keys():
            if data_key in section_reports:
                final_report += section_reports[data_key]


        # 4. 최종 보고서에 결론 섹션 추가
        opinion_agent = Agent(
            name="opinion",
            instruction=f"""
                        당신은 {company_name} ({company_code}) 기업분석 보고서에 대한 종합 결론과 투자자 유형별 투자 의견을 작성하는 투자 전문가입니다.
                        보고서 전체를 종합적으로 분석하여 보고서 맨 앞에 배치될 결론 섹션을 작성해야 합니다.
                        객관적인 데이터를 바탕으로 신중하고 전문적인 의견을 제시하세요.
                        
                        ##분석일 : {reference_date}(YYYYMMDD 형식)
                        """
        )

        final_llm = await opinion_agent.attach_llm(OpenAIAugmentedLLM)
        opinion = await final_llm.generate_str(
            message=f"""{company_name}({company_code})의 기업분석 보고서에 대한 종합 결론과 다양한 투자자 유형별 투자 의견을 5,000자 정도로 작성해주세요.
                        (##분석일 : {reference_date}(YYYYMMDD 형식))
                        
                        ## 주의사항 언급 : 투자의 책임은 본인에게 있다는 형식적인 워딩으로 보고서를 시작하세요.

                        ## 형식 가이드라인:
            
                        결론 부분은 아래 마크다운 형식의 구조로 작성하되, 전체 보고서의 맨 앞에 배치될 것입니다:
                        
                        ```
                        # 투자 결론 및 제언
                        
                        ## 종합 분석 요약
                        (여기에 내용 작성)
                        
                        ## 투자자 유형별 전략
                        
                        ### 1. 신규 투자자 전략
                        (여기에 내용 작성)
                        
                        ### 2. 기존 보유자 전략
                        (여기에 내용 작성)
                        
                        ### 3. 포트폴리오 관점 전략
                        (여기에 내용 작성)
                        
                        ### 4. 투자 성향별 접근법
                        (여기에 내용 작성)
                        
                        ### 5. 자금 배분 전략
                        (여기에 내용 작성)
                        ```
                        
                        ## 말투 및 문체 가이드라인:
                        
                        1. 전문적이고 간결한 문체 사용: 불필요한 수식어 배제, 핵심만 전달
                           예시: "~할 것으로 보입니다" 대신 "~할 것으로 예상됩니다" 또는 "~입니다"
                        
                        2. 분석적이고 객관적인 톤 유지: 
                           - "매우 좋은 기회입니다"(×) → "PER 기준 저평가 구간입니다"(○)
                           - "반드시 매수해야 합니다"(×) → "매수 검토가 적절합니다"(○)
                        
                        3. 명확한 수치와 근거 제시:
                           - "높은 성장이 예상됩니다"(×) → "2024년 매출 101.73% 성장이 예상됩니다"(○)
                           
                        4. 단정적 표현보다 확률적/조건부 표현 사용:
                           - "주가는 상승할 것입니다"(×) → "시장 회복 시 주가 상승 가능성이 높습니다"(○)
                        
                        5. 직접적 투자 권유보다 정보 제공 형태로 작성:
                           - "지금 매수하세요"(×) → "현 밸류에이션은 매수 시점으로 판단됩니다"(○)
                                            
                        ## 내용 가이드라인:
                        
                        ### 1. 종합 분석 요약 (400-600자)
                        - 핵심 재무지표 추이 요약
                        - 시장 내 위치 및 경쟁력 평가
                        - 향후 1-2년 전망
                        - 주요 리스크 요인
                        
                        ### 2. 신규 투자자 전략
                        - 현 진입 적정성 판단과 근거
                        - 자금 규모별 접근법
                        - 목표가/손절가 제시
                        - 적정 진입 시점
                        
                        ### 3. 기존 보유자 전략
                        - 보유 지속 여부 판단
                        - 평균단가별 대응방안
                        - 추가매수/분할매도 전략
                        - 장기보유 시 모니터링 포인트
                        
                        ### 4. 포트폴리오 관점 전략
                        - 반도체 업종 내 비중
                        - 전체 포트폴리오 내 적정 비중
                        - 상관관계 높은 종목들과의 관계
                        - 글로벌 경기/환율 변동 대응법
                        
                        ### 5. 투자 성향별 접근법
                        - 가치/성장/배당/기술적 분석 관점별 전략
                        - 투자 기간별 접근법
                        - 위험 감수성향별 대응법
                        
                        ### 6. 자금 배분 전략
                        - 일시투자 vs 분할투자 비교
                        - 매수 비율 및 타이밍
                        - 투자금 규모별 실행방안
                        
                        첨부된 보고서 내용:
                        {final_report}
                        """,
            request_params=RequestParams(
                model="gpt-4o-mini",
                maxTokens=8000,
                max_iterations=5,
                parallel_tool_calls=True,
                use_history=True
            )
        )

        final_report = opinion + "\n\n" + final_report
        # 최종 마크다운 정리
        final_report = clean_markdown(final_report)


        logger.info(f"Finalized report for {company_name} - {len(final_report)} characters")
        logger.info(f"Analysis completed for {company_name}.")
        logger.info(f"Final Report : " + final_report)

        return final_report


if __name__ == "__main__":
    import time
    start = time.time()

    # 특정 날짜를 기준으로 분석 실행 (예: 2025년 2월 19일)
    result = asyncio.run(analyze_stock(company_code="000660", company_name="SK하이닉스", reference_date="20250222"))

    # 결과 저장
    with open(f"SK하이닉스_분석보고서_{datetime.now().strftime('%Y%m%d')}.md", "w", encoding="utf-8") as f:
        f.write(result)

    end = time.time()
    print(f"총 실행 시간: {end - start:.2f}초")
    print(f"최종 보고서 길이: {len(result):,} 글자")