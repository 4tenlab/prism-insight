import asyncio
import concurrent.futures
import re
from datetime import datetime, timedelta

from mcp_agent.agents.agent import Agent
from mcp_agent.app import MCPApp
from mcp_agent.workflows.llm.augmented_llm import RequestParams
from mcp_agent.workflows.llm.augmented_llm_openai import OpenAIAugmentedLLM

app = MCPApp(name="stock_analysis")

# WiseReport URL 템플릿 설정
WISE_REPORT_BASE = "https://comp.wisereport.co.kr/company/"
URLS = {
    "기업현황": "c1010001.aspx?cmp_cd={}",
    "기업개요": "c1020001.aspx?cmp_cd={}",
    "재무분석": "c1030001.aspx?cmp_cd={}",
    "투자지표": "c1040001.aspx?cmp_cd={}",
    "컨센서스": "c1050001.aspx?cmp_cd={}",
    "경쟁사분석": "c1060001.aspx?cmp_cd={}",
    "지분현황": "c1070001.aspx?cmp_cd={}",
    "업종분석": "c1090001.aspx?cmp_cd={}",
    "최근리포트": "c1080001.aspx?cmp_cd={}"
}

async def write_report_section(data_key: str, agent: Agent,
                               company_name: str, company_code: str, reference_date: str, logger, delay: float = 10.0):
    """데이터 수집 및 보고서 작성을 위한 통합 async 함수"""
    # 각 작업 시작 전 지연
    await asyncio.sleep(delay)

    logger.info(f"Processing {data_key} for {company_name}...")

    llm = await agent.attach_llm(OpenAIAugmentedLLM)
    section_report = await llm.generate_str(
        message=f"""{company_name}({company_code})의 {data_key} 분석 보고서를 작성해주세요.
                
                ## 분석 및 보고서 작성 지침:
                1. 데이터 수집부터 분석까지 모든 과정을 수행하세요.
                2. 보고서의 길이는 response token이 허락하는 최대한도를 사용하세요.
                3. 가능하면 5,000글자 이상의 상세한 보고서를 작성하세요.
                4. 최대한 상세하고 구체적인 수치가 많이 들어가도록 전문성 있는 보고서를 작성하세요.
                5. 실제 수집된 데이터에만 기반하여 분석하고, 없는 데이터는 추측하지 마세요.
                
                ## 형식 요구사항:
                1. 보고서 시작 시 제목을 넣기 전에 반드시 개행문자를 2번 넣어 시작하세요 (\\n\\n).
                2. 이는 보고서의 시작부분에서 충분한 여백을 확보하기 위함입니다.
                3. 섹션 제목과 구조는 에이전트 지침에 명시된 형식을 따르세요.
                
                ##분석일: {reference_date}(YYYYMMDD 형식)
                """,
        request_params=RequestParams(
            model="gpt-4o-mini",
            maxTokens=8000,
            max_iterations=5,
            parallel_tool_calls=True,
            use_history=True
        )
    )

    logger.info(f"Completed {data_key} - {len(section_report)} characters")
    return data_key, section_report

def clean_markdown(text: str) -> str:
    """마크다운 텍스트 정리"""

    # 1. 백틱 블록 제거
    text = re.sub(r'```[^\n]*\n(.*?)\n```', r'\1', text, flags=re.DOTALL)

    # 2. 개행문자 리터럴을 실제 개행으로 변환
    text = re.sub(r'\\n\\n', '\n\n', text)

    return text


def get_wise_report_url(report_type: str, company_code: str) -> str:
    """WiseReport URL 생성"""
    return WISE_REPORT_BASE + URLS[report_type].format(company_code)

async def analyze_stock(company_code: str = "000660", company_name: str = "SK하이닉스", reference_date: str = None):
    # reference_date가 없으면 오늘 날짜를 사용
    if reference_date is None:
        reference_date = datetime.now().strftime("%Y%m%d")

    year = reference_date[:4]

    # 날짜 객체로 변환
    ref_date = datetime.strptime(reference_date, "%Y%m%d")

    # 기간 계산
    max_years = 1
    max_years_ago = (ref_date - timedelta(days=365*max_years)).strftime("%Y%m%d")
    six_months_ago = (ref_date - timedelta(days=180)).strftime("%Y%m%d")

    async with app.run() as parallel_app:
        logger = parallel_app.logger
        logger.info(f"시작: {company_name}({company_code}) 분석 - 기준일: {reference_date}")

        # 공유 리소스로 데이터를 저장할 딕셔너리 생성
        section_reports = {}

        # URL 매핑 생성
        urls = {k: get_wise_report_url(k, company_code) for k in URLS.keys()}

        # 데이터 수집 에이전트 설정
        report_writers = {
            "price_data": Agent(
                name="price_data_analyzer",
                instruction=f"""당신은 주가 데이터 수집 및 분석 전문가입니다. 다음 단계로 업무를 수행하세요:

                                ## 1. 데이터 수집
                                - get_stock_ohlcv tool을 사용하여 {max_years_ago} ~ {reference_date} 기간의 주가/거래량 데이터를 수집하세요.
                                - 예시: get_stock_ohlcv("20240101", "20240131", "005930")
                                - 필요시 추가 데이터를 수집하여 분석의 질을 높이세요.
                                
                                ## 2. 데이터 검증 및 준비
                                - 우선 데이터 수집이 성공했는지 명시적으로 확인하세요. 
                                - 데이터가 존재하지 않거나 충분하지 않은 경우 "충분한 데이터를 수집할 수 없었습니다"라고 명시하고 분석을 최소화하세요.
                                - 수집된 데이터의 날짜 범위, 데이터 포인트 수, 결측치 여부를 확인하고 보고하세요.
                                - 수집된 데이터에 대한 간단한 요약 통계(최소값, 최대값, 평균, 중앙값 등)를 계산하여 데이터 품질을 검증하세요.
                                
                                ## 3. 데이터 분석 및 보고서 작성
                                - 검증된 실제 데이터만을 기반으로 분석을 진행하세요. 데이터가 없는 부분에 대해서는 절대 추측하지 마세요.
                                - "수집된 데이터에 따르면..." 같은 표현을 사용하여 분석이 실제 데이터에 기반함을 명확히 하세요.
                                - 데이터에서 확실하게 관찰되는 패턴과 추세만 보고하고, 불확실한 내용은 언급하지 마세요.
                                
                                ## 보고서 구성 방향
                                - 수집된 데이터에서 가장 두드러진 특징과 인사이트에 집중하세요.
                                - 기업의 재무 상태를 종합적으로 평가할 수 있는 분석을 수행하세요.
                                - 시간 경과에 따른 변화와 추세를 파악하고 설명하세요.
                                - 가능하다면 동종 업계 평균 또는 경쟁사와 비교한 상대적 위치를 평가하세요.
                                - 분석은 항상 수집된 실제 데이터에 기반해야 합니다.
                                
                                ## 보고서 형식
                                - 보고서 시작 시 반드시 개행문자 2번 삽입 (\n\n)
                                - 첫 번째로 전체 보고서 제목 작성 (예: `{company_name} 기업 분석 보고서 ({reference_date})`)
                                - 그 다음 섹션 제목: "# 1. 주가 및 기술적 분석"
                                - 모든 주요 항목은 마크다운 형식으로 명확히 구조화 (##, ### 등 활용)
                                - 수집된 데이터를 기반으로 적절한 구조와 소제목을 자율적으로 구성하세요.
                                - 복잡한 데이터는 표 형식으로 정리하여 가독성을 높이세요.
                                - 데이터 인용 시 출처와 기준일자 명시 (출처: http://data.krx.co.kr/)
                                
                                ## 작성 스타일
                                - 전문적이고 객관적인 문어체 사용 ('~합니다', '~입니다'로 통일)
                                - 개인적 의견보다 데이터에 기반한 객관적 분석 제시
                                - 모든 분석은 구체적 수치와 기간을 명시
                                - 다른 보고서 섹션(재무분석, 기업개요 등)과 중복되지 않게 작성
                                - 주요 지표와 패턴은 표 형식으로 요약 제시
                                - 결론에 해당하는 문단은 작성하지 말 것 (해당 보고서는 전체 보고서의 섹션 중 하나임)
                                
                                ## 할루시네이션 방지 지침
                                - 실제로 확인된 데이터만 포함하고, 모든 분석은 구체적인 수치를 인용하세요.
                                - 데이터에서 확인되지 않은 내용에 대해서는 "확인할 수 없었습니다" 또는 "데이터가 없습니다"라고 명시하세요.
                                - 불확실한 내용은 서술하지 말고, 확실한 내용만 포함하세요.
                                - 일반적인 재무 분석 개념을 적용할 때도 반드시 해당 기업의 실제 데이터를 참조하세요.
                                - 분석 작성 시 각 문장이 수집된 특정 데이터에 근거하는지 확인하세요.
                                
                                
                                기업: {company_name} ({company_code})
                                ##분석일: {reference_date}(YYYYMMDD 형식)
                                """,
                server_names=["kospi_kosdaq"]
            ),
            "market_cap_data": Agent(
                name="market_cap_analyzer",
                instruction=f"""당신은 시가총액 데이터 수집 및 분석 전문가입니다. 다음 단계로 업무를 수행하세요:

                                ## 1. 데이터 수집
                                - get_stock_market_cap tool을 사용하여 {max_years_ago} ~ {reference_date} 기간(YYYYMMDD 형식)의 시가총액 데이터를 수집하세요.
                                - 예시: get_stock_market_cap("20240101", "20240131", "005930")
                                - 데이터 수집 후 반드시 결과를 확인하고, 데이터가 존재하는지 명시적으로 언급하세요.
                                
                                ## 2. 데이터 검증 및 준비
                                - 수집된 데이터가 있는지 확인하고, 데이터 포인트 수, 날짜 범위, 결측치 여부를 보고하세요.
                                - 데이터가 없거나 불충분한 경우 "시가총액 데이터를 충분히 수집할 수 없었습니다"라고 명시하고 분석을 최소화하세요.
                                - 데이터 포인트가 5개 미만인 경우, 신뢰할 수 있는 분석이 어렵다고 명시하세요.
                                - 수집된 데이터의 기본 통계(최대값, 최소값, 평균, 변동률 등)를 계산하여 데이터 품질을 검증하세요.
                                
                                ## 3. 데이터 분석 및 보고서 작성
                                - 검증된 실제 데이터만 사용하여 분석하고, 데이터가 없는 부분은 절대 추측하지 마세요.
                                - 분석 내용을 서술할 때 "수집된 데이터에 따르면..."과 같은 표현으로 시작하여 실제 데이터에 근거함을 명확히 하세요.
                                - 데이터에서 명확히 관찰되는 패턴과 추세만 보고하고, 불확실한 내용은 언급하지 마세요.
                                - {reference_date} 날짜(YYYYMMDD 형식) 기준으로 가장 최근 흐름에 중점을 두세요.
                                - 약 3,000자 내외의 간결한 보고서를 작성하세요. 분량보다 품질과 정확성에 집중하세요.
                                
                                ## 보고서 구성 방향
                                - 수집된 데이터에서 가장 두드러진 특징과 인사이트에 집중하세요.
                                - 시간 경과에 따른 변화와 추세를 파악하고 설명하세요.
                                - 가능하다면 동종 업계 평균 또는 시장 전체와 비교한 상대적 위치를 평가하세요.
                                - 분석은 항상 수집된 실제 데이터에 기반해야 합니다.
                                
                                ## 보고서 형식
                                - 보고서 시작 시 반드시 개행문자 2번 삽입 (\n\n)
                                - 섹션 제목: "# 2. 시가총액 및 유동성 분석"
                                - 수집된 데이터 요약을 먼저 제시한 후 분석 내용 전개
                                - 데이터가 충분한 경우에만 상세 분석 진행
                                - 데이터 인용 시 출처와 기준일자를 명시하세요 (출처: http://data.krx.co.kr/).
                                
                                ## 작성 스타일
                                - 전문적이고 객관적인 문어체 사용 ('~합니다', '~입니다'로 통일)
                                - 각 문장이 구체적인 데이터에 근거하도록 작성
                                - 데이터에 기반한 객관적 분석 제시
                                - 수치는 구체적으로 제시하고, 증감 방향과 의미를 명확히 설명
                                - 다른 보고서 섹션과 중복되지 않게 작성
                                - 결론에 해당하는 문단은 작성하지 말 것 (해당 보고서는 전체 보고서의 섹션 중 하나임)
                                
                                ## 할루시네이션 방지 지침
                                - 실제로 확인된 데이터만 포함하고, 모든 분석은 구체적인 수치를 인용하세요.
                                - 데이터에서 확인되지 않은 내용에 대해서는 "확인할 수 없었습니다" 또는 "데이터가 없습니다"라고 명시하세요.
                                - 불확실한 내용은 서술하지 말고, 확실한 내용만 포함하세요.
                                - 일반적인 재무 분석 개념을 적용할 때도 반드시 해당 기업의 실제 데이터를 참조하세요.
                                - 분석 작성 시 각 문장이 수집된 특정 데이터에 근거하는지 확인하세요.
                                
                                
                                기업: {company_name} ({company_code})
                                ##분석일: {reference_date}(YYYYMMDD 형식)
                            """,
                server_names=["kospi_kosdaq"]
            ),
            "trading_volume_data": Agent(
                name="trading_volume_analyzer",
                instruction=f"""당신은 투자자 거래 데이터 수집 및 분석 전문가입니다. 다음 단계로 업무를 수행하세요:

                                ## 1. 데이터 수집
                                - get_stock_trading_volume tool을 사용하여 {max_years_ago} ~ {reference_date} 기간(YYYYMMDD 형식)의 투자자별 거래 데이터를 수집하세요.
                                - 예시: get_stock_trading_volume("20240101", "20240131", "005930")
                                - 데이터 수집 결과를 확인하고, 수집 성공 여부와 데이터 범위를 명시적으로 언급하세요.
                                
                                ## 2. 데이터 검증 및 준비
                                - 수집된 데이터가 있는지 확인하고, 데이터 포인트 수, 날짜 범위, 투자자 유형별 데이터 존재 여부를 보고하세요.
                                - 데이터가 부족하거나 없는 경우 "투자자 거래 데이터를 충분히 수집할 수 없었습니다"라고 명시하고 분석을 최소화하세요.
                                - 데이터 포인트가 5개 미만인 경우, 신뢰할 수 있는 분석이 어렵다고 명시하세요.
                                - 투자자 유형별 기본 거래 패턴(평균 거래량, 매수/매도 비율 등)을 계산하여 데이터 품질을 검증하세요.
                                
                                ## 3. 데이터 분석 및 보고서 작성
                                - 검증된 실제 데이터만을 기반으로 분석하고, 데이터가 없는 부분은 추측하지 마세요.
                                - 모든 분석 내용은 "수집된 데이터에 따르면..."와 같은 표현으로 시작하여 실제 데이터 기반임을 명확히 하세요.
                                - 확실히 관찰되는 패턴과 추세만 보고하고, 불확실하거나 추측에 기반한 내용은 포함하지 마세요.
                                - {reference_date} 날짜(YYYYMMDD 형식) 기준으로 가장 최근 흐름에 중점을 두세요.
                                - 약 3,000자 내외의 간결한 보고서를 작성하세요. 분량보다 정확성과 인사이트에 집중하세요.
                                
                                ## 보고서 구성 방향
                                - 수집된 데이터에서 가장 두드러진 특징과 인사이트에 집중하세요.
                                - 시간 경과에 따른 변화와 추세를 파악하고 설명하세요.
                                - 거래량과 주가 움직임 간의 관계가 있다면 이를 분석하세요.
                                - 분석은 항상 수집된 실제 데이터에 기반해야 합니다.
                                
                                ## 보고서 형식
                                - 보고서 시작 시 반드시 개행문자 2번 삽입 (\n\n)
                                - 섹션 제목: "# 3. 투자자 거래 패턴 분석"
                                - 수집된 데이터 요약을 먼저 제시한 후 분석 내용을 전개하세요.
                                - 투자자 유형별 주요 패턴은 표 형식으로 간결하게 정리하세요.
                                - 데이터 인용 시 출처와 기준일자를 명시하세요 (출처: http://data.krx.co.kr/).
                                
                                ## 작성 스타일
                                - 전문적이고 객관적인 문어체 사용 ('~합니다', '~입니다'로 통일)
                                - 각 문장이 구체적인 데이터 포인트를 참조하도록 작성
                                - 수치는 구체적으로 제시하고, 증감 방향과 의미를 명확히 설명
                                - 다른 보고서 섹션과 중복되지 않게 작성
                                - 결론에 해당하는 문단은 작성하지 말 것 (해당 보고서는 전체 보고서의 섹션 중 하나임)
                                
                                ## 할루시네이션 방지 지침
                                - 실제로 확인된 데이터만 포함하고, 모든 분석은 구체적인 수치를 인용하세요.
                                - 데이터에서 확인되지 않은 내용에 대해서는 "확인할 수 없었습니다" 또는 "데이터가 없습니다"라고 명시하세요.
                                - 불확실한 내용은 서술하지 말고, 확실한 내용만 포함하세요.
                                - 일반적인 재무 분석 개념을 적용할 때도 반드시 해당 기업의 실제 데이터를 참조하세요.
                                - 분석 작성 시 각 문장이 수집된 특정 데이터에 근거하는지 확인하세요.
                                
                                
                                기업: {company_name} ({company_code})
                                ##분석일: {reference_date}(YYYYMMDD 형식)
                            """,
                server_names=["kospi_kosdaq"]
            ),
            "corporate_overview": Agent(
                name="corporate_overview_analyzer",
                instruction=f"""당신은 기업 개요 데이터 수집 및 분석 전문가입니다. 다음 단계로 업무를 수행하세요:

                                ## 1. 데이터 수집
                                - 아래 URL에 접속하여 {reference_date} 날짜(YYYYMMDD 형식)로부터 2~3년 전까지의 자료를 수집하세요.
                                - URL 접속 시 visit_page tool을 사용하고 takeScreenshot 파라미터는 false로 설정하세요.
                                - 차트보다는 테이블 위주로 데이터를 수집하세요.
                                - 데이터 수집 후, 어떤 유형의 데이터(테이블, 텍스트 등)를 수집했는지 명시하세요.
                                
                                ## 접속 URL: {urls['기업개요']}
                                
                                ## 2. 데이터 검증 및 준비
                                - 웹페이지 접속 성공 여부를 명시적으로 확인하고 보고하세요.
                                - 실제로 수집된 데이터 유형과 범위를 구체적으로 명시하세요 (예: "기업 개요 테이블, 사업 영역 설명, 주요 제품 정보를 수집했습니다").
                                - 데이터가 없거나 불충분한 경우 "기업 개요 데이터를 충분히 수집할 수 없었습니다"라고 명시하고 분석을 최소화하세요.
                                - 텍스트 데이터와 수치 데이터를 구분하고, 각각에 적합한 분석 방법을 적용하세요.
                                
                                ## 3. 데이터 분석 및 보고서 작성
                                - 수집된 실제 데이터만 사용하여 분석하고, 웹페이지에서 직접 확인하지 못한 정보는 추측하지 마세요.
                                - 분석 시 "수집된 웹페이지 정보에 따르면..."과 같은 표현으로 시작하여 정보 출처를 명확히 하세요.
                                - 확실히 확인된 사실만 보고하고, 불확실한 정보는 "확인되지 않았습니다"라고 명시하세요.
                                - {reference_date} 날짜(YYYYMMDD 형식) 기준으로 가장 최근 정보에 중점을 두세요.
                                - 약 3,000자 내외의 간결한 보고서를 작성하세요. 분량보다 정확성에 집중하세요.
                                
                                ## 보고서 구성 방향
                                - 기업의 핵심 사업 영역, 주요 제품/서비스, 사업 구조에 대한 분석 (웹페이지에서 확인된 내용만)
                                - 핵심 전략과 비즈니스 모델 (명시적으로 언급된 경우만)
                                - 그 외 수집된 데이터에서 확인된 특징적인 사항에 집중하세요.
                                
                                ## 보고서 형식
                                - 보고서 시작 시 반드시 개행문자 2번 삽입 (\n\n)
                                - 섹션 제목: "# 4. 기업 사업 구조 및 전략 분석"
                                - 데이터 수집 범위와 한계를 먼저 명시한 후 분석 내용 전개
                                - 기업 정보는 체계적으로 카테고리화하여 구성하세요.
                                - 데이터 인용 시 출처와 기준일자를 명시하세요 (출처: https://comp.wisereport.co.kr/).
                                
                                ## 작성 스타일
                                - 전문적이고 객관적인 문어체 사용 ('~합니다', '~입니다'로 통일)
                                - 웹페이지에서 직접 확인된 내용만 포함
                                - 개인적 의견이나 일반적인 업계 지식 기반 서술 자제
                                - 다른 보고서 섹션과 중복되지 않게 작성
                                - 결론에 해당하는 문단은 작성하지 말 것 (해당 보고서는 전체 보고서의 섹션 중 하나임)
                                
                                ## 할루시네이션 방지 지침
                                - 실제로 확인된 데이터만 포함하고, 모든 분석은 구체적인 수치를 인용하세요.
                                - 데이터에서 확인되지 않은 내용에 대해서는 "확인할 수 없었습니다" 또는 "데이터가 없습니다"라고 명시하세요.
                                - 불확실한 내용은 서술하지 말고, 확실한 내용만 포함하세요.
                                - 일반적인 재무 분석 개념을 적용할 때도 반드시 해당 기업의 실제 데이터를 참조하세요.
                                - 분석 작성 시 각 문장이 수집된 특정 데이터에 근거하는지 확인하세요.
                                
                                
                                기업: {company_name} ({company_code})
                                ##분석일: {reference_date}(YYYYMMDD 형식)
                            """,
                server_names=["webresearch"]
            ),
            "corporate_status": Agent(
                name="corporate_status_analyzer",
                instruction=f"""당신은 기업 현황 데이터 수집 및 분석 전문가입니다. 다음 단계로 업무를 수행하세요:

                                ## 1. 데이터 수집
                                - 아래 URL에 접속하여 {year} 년도로부터 2~3년 전까지의 자료를 수집하세요.
                                - URL 접속 시 visit_page tool을 사용하고 takeScreenshot 파라미터는 false로 설정하세요.
                                - 차트보다는 테이블 위주로 데이터를 수집하세요.
                                - 데이터 수집 결과를 명확하게 기록하고, 웹페이지 접속 및 데이터 획득 성공 여부를 명시하세요.
                                
                                ## 접속 URL: {urls['기업현황']}
                                
                                ## 2. 데이터 검증 및 준비
                                - 웹페이지 접속 및 데이터 수집 성공 여부를 명시적으로 보고하세요.
                                - 어떤 유형의 데이터(이사회 구성, 주요 주주, 경영진 정보 등)를 실제로 수집했는지 구체적으로 명시하세요.
                                - 데이터가 부족하거나 없는 경우 "기업 현황 데이터를 충분히 수집할 수 없었습니다"라고 명시하고 분석을 최소화하세요.
                                - 수집된 정보의 날짜/시점을 확인하고 최신성을 평가하세요.
                                
                                ## 3. 데이터 분석 및 보고서 작성
                                - 수집된 실제 데이터만 사용하여 분석하고, 웹페이지에서 확인하지 못한 정보는 추측하지 마세요.
                                - 분석 시 "웹페이지에서 수집한 정보에 따르면..."과 같은 표현으로 시작하여 정보 출처를 명확히 하세요.
                                - 확실히 확인된 사실만 보고하고, 불확실하거나 확인되지 않은 정보는 포함하지 마세요.
                                - {reference_date} 날짜(YYYYMMDD 형식) 기준으로 가장 최근 정보에 중점을 두세요.
                                - 약 3,000자 내외의 간결한 보고서를 작성하세요. 분량보다 정확성에 집중하세요.
                                
                                ## 보고서 구성 방향
                                - 기업의 지배구조, 주요 경영진, 조직체계 등에 대한 분석 (웹페이지에서 확인된 정보만)
                                - 주요 경영 현황과 경영진의 특징적인 전략 방향 (실제 데이터에서 확인된 경우만)
                                - 그 외 수집된 데이터에서 확인된 특징적인 사항에 집중하세요.
                                
                                ## 보고서 형식
                                - 보고서 시작 시 반드시 개행문자 2번 삽입 (\n\n)
                                - 섹션 제목: "# 5. 기업 지배구조 및 경영 현황 분석"
                                - 데이터 수집 범위와 한계를 먼저 명시한 후 분석 내용 전개
                                - 기업 지배구조 정보는 체계적으로 카테고리화하여 구성하세요.
                                - 데이터 인용 시 출처와 기준일자를 명시하세요 (출처: https://comp.wisereport.co.kr/).
                                
                                ## 작성 스타일
                                - 전문적이고 객관적인 문어체 사용 ('~합니다', '~입니다'로 통일)
                                - 웹페이지에서 직접 확인된 내용만 포함
                                - 개인적 의견이나 추측 최소화
                                - 다른 보고서 섹션과 중복되지 않게 작성
                                - 결론에 해당하는 문단은 작성하지 말 것 (해당 보고서는 전체 보고서의 섹션 중 하나임)
                                
                                ## 할루시네이션 방지 지침
                                - 실제로 확인된 데이터만 포함하고, 모든 분석은 구체적인 수치를 인용하세요.
                                - 데이터에서 확인되지 않은 내용에 대해서는 "확인할 수 없었습니다" 또는 "데이터가 없습니다"라고 명시하세요.
                                - 불확실한 내용은 서술하지 말고, 확실한 내용만 포함하세요.
                                - 일반적인 재무 분석 개념을 적용할 때도 반드시 해당 기업의 실제 데이터를 참조하세요.
                                - 분석 작성 시 각 문장이 수집된 특정 데이터에 근거하는지 확인하세요.
                                
                                
                                기업: {company_name} ({company_code})
                                ##분석일: {reference_date}(YYYYMMDD 형식)
                            """,
                server_names=["webresearch"]
            ),
            "financial_analysis1": Agent(
                name="financial_statement_analyzer1",
                instruction=f"""당신은 기업 포괄손익계산서 데이터 수집 및 분석 전문가입니다. 다음 단계로 업무를 수행하세요:

                                ## 1. 데이터 수집
                                - 아래 URL에 접속하여 {year} 년도로부터 2~3년 전까지의 포괄손익계산서 자료를 수집하세요.
                                - URL 접속 시 visit_page tool을 사용하고 takeScreenshot 파라미터는 false로 설정하세요.
                                - '포괄손익계산서' 탭을 선택해서 데이터를 수집하세요.
                                - 차트보다는 테이블 위주로 데이터를 수집하세요.
                                - 웹페이지 접속 및 데이터 수집 성공 여부를 명확히 보고하세요.
                                - 수집한 테이블이나 데이터의 연도와 기간(연간/분기)을 명시하세요.
                                
                                ## 접속 URL('포괄손익계산서' 탭): {urls['재무분석']}
                                
                                ## 2. 데이터 검증 및 준비
                                - 웹페이지 접속 및 포괄손익계산서 데이터 수집 성공 여부를 명시적으로 보고하세요.
                                - 어떤 기간의 데이터(예: "2020-2023년 연간 포괄손익계산서")를 실제로 수집했는지 구체적으로 명시하세요.
                                - 데이터가 부족하거나 없는 경우 "포괄손익계산서 데이터를 충분히 수집할 수 없었습니다"라고 명시하고 분석을 최소화하세요.
                                - 수집된 주요 항목(매출액, 영업이익, 당기순이익 등)을 확인하고 데이터의 완전성을 평가하세요.
                                
                                ## 3. 데이터 분석 및 보고서 작성
                                - 수집된 실제 데이터만 사용하여 분석하고, 웹페이지에서 확인하지 못한 정보는 추측하지 마세요.
                                - 분석 시 "수집된 포괄손익계산서에 따르면..."과 같은 표현으로 시작하여 정보 출처를 명확히 하세요.
                                - 확실히 확인된 재무 추세와 패턴만 보고하고, 불확실하거나 추측에 기반한 내용은 포함하지 마세요.
                                - {reference_date} 날짜(YYYYMMDD 형식) 기준으로 가장 최근 데이터에 중점을 두세요.
                                - 약 3,000자 내외의 간결한 보고서를 작성하세요. 분량보다 정확성에 집중하세요.
                                
                                ## 보고서 구성 방향
                                - 매출, 영업이익, 당기순이익 등 주요 항목의 추이 분석 (실제 데이터가 있는 항목만)
                                - 이익률(영업이익률, 순이익률) 변화와 그 원인 분석 (데이터 기반으로만)
                                - 비용 구조(매출원가, 판관비 등)의 변화 및 효율성 분석 (데이터가 있는 경우만)
                                - 계절성 또는 주기성이 명확히 관찰되는 경우에만 이를 언급하세요.
                                - 그 외 수집된 데이터에서 명확히 확인되는 특이점에만 집중하세요.
                                
                                ## 보고서 형식
                                - 보고서 시작 시 반드시 개행문자 2번 삽입 (\n\n)
                                - 섹션 제목: "# 6-1. 심층 재무제표 분석(포괄손익계산서)"
                                - 데이터 수집 범위와 한계를 먼저 명시한 후 분석 내용 전개
                                - 주요 재무 지표는 마크다운 표 형식으로 정리하세요.
                                - 데이터 인용 시 출처와 기준일자를 명시하세요 (출처: https://comp.wisereport.co.kr/).
                                
                                ## 작성 스타일
                                - 전문적이고 객관적인 문어체 사용 ('~합니다', '~입니다'로 통일)
                                - 웹페이지에서 직접 확인된 재무 데이터만 사용
                                - 구체적인 수치와 증감률을 제시하고, 그 의미를 명확히 설명
                                - 다른 보고서 섹션과 중복되지 않게 작성
                                - 결론에 해당하는 문단은 작성하지 말 것 (해당 보고서는 전체 보고서의 섹션 중 하나임)
                                
                                ## 할루시네이션 방지 지침
                                - 실제로 확인된 데이터만 포함하고, 모든 분석은 구체적인 수치를 인용하세요.
                                - 데이터에서 확인되지 않은 내용에 대해서는 "확인할 수 없었습니다" 또는 "데이터가 없습니다"라고 명시하세요.
                                - 불확실한 내용은 서술하지 말고, 확실한 내용만 포함하세요.
                                - 일반적인 재무 분석 개념을 적용할 때도 반드시 해당 기업의 실제 데이터를 참조하세요.
                                - 분석 작성 시 각 문장이 수집된 특정 데이터에 근거하는지 확인하세요.
                                
                                
                                기업: {company_name} ({company_code})
                                ##분석일: {reference_date}(YYYYMMDD 형식)
                            """,
                server_names=["webresearch"]
            ),
            "financial_analysis2": Agent(
                name="financial_statement_analyzer2",
                instruction=f"""당신은 기업 재무상태표 데이터 수집 및 분석 전문가입니다. 다음 단계로 업무를 수행하세요:

                                ## 1. 데이터 수집
                                - 아래 URL에 접속하여 {year} 년도로부터 2~3년 전까지의 재무상태표 자료를 수집하세요.
                                - URL 접속 시 visit_page tool을 사용하고 takeScreenshot 파라미터는 false로 설정하세요.
                                - '재무상태표' 탭을 선택해서 데이터를 수집하세요.
                                - 웹페이지 접속 및 데이터 수집 성공 여부를 명확히 보고하세요.
                                - 수집한 재무상태표의 연도와 기간(연간/분기)을 명시하세요.
                                
                                ## 접속 URL('재무상태표' 탭): {urls['재무분석']}
                                
                                ## 2. 데이터 검증 및 준비
                                - 웹페이지 접속 및 재무상태표 데이터 수집 성공 여부를 명시적으로 보고하세요.
                                - 어떤 기간의 데이터(예: "2020-2023년 연간 재무상태표")를 실제로 수집했는지 구체적으로 명시하세요.
                                - 데이터가 부족하거나 없는 경우 "재무상태표 데이터를 충분히 수집할 수 없었습니다"라고 명시하고 분석을 최소화하세요.
                                - 수집된 주요 항목(자산, 부채, 자본 등)을 확인하고 데이터의 완전성을 평가하세요.
                                
                                ## 3. 데이터 분석 및 보고서 작성
                                - 수집된 실제 데이터만 사용하여 분석하고, 웹페이지에서 확인하지 못한 정보는 추측하지 마세요.
                                - 분석 시 "수집된 재무상태표에 따르면..."과 같은 표현으로 시작하여 정보 출처를 명확히 하세요.
                                - 확실히 확인된 재무 추세와 패턴만 보고하고, 불확실하거나 추측에 기반한 내용은 포함하지 마세요.
                                - {reference_date} 날짜(YYYYMMDD 형식) 기준으로 가장 최근 데이터에 중점을 두세요.
                                - 약 3,000자 내외의 간결한 보고서를 작성하세요. 분량보다 정확성에 집중하세요.
                                
                                ## 보고서 구성 방향
                                - 자산, 부채, 자본의 구조와 변화 추이 분석 (실제 데이터 기반)
                                - 유동성 비율(유동비율, 당좌비율 등) 분석 (계산 가능한 경우만)
                                - 부채 비율과 재무 레버리지 분석 (데이터가 있는 경우만)
                                - 자본 구조 및 효율성 분석 (데이터가 충분한 경우만)
                                - 그 외 수집된 데이터에서 명확히 확인되는 특이점에만 집중하세요.
                                
                                ## 보고서 형식
                                - 보고서 시작 시 반드시 개행문자 2번 삽입 (\n\n)
                                - 섹션 제목: "# 6-2. 심층 재무제표 분석(재무상태표)"
                                - 데이터 수집 범위와 한계를 먼저 명시한 후 분석 내용 전개
                                - 주요 재무 지표는 마크다운 표 형식으로 정리하세요.
                                - 데이터 인용 시 출처와 기준일자를 명시하세요 (출처: https://comp.wisereport.co.kr/).
                                
                                ## 작성 스타일
                                - 전문적이고 객관적인 문어체 사용 ('~합니다', '~입니다'로 통일)
                                - 웹페이지에서 직접 확인된 재무 데이터만 사용
                                - 구체적인 수치와 증감률을 제시하고, 그 의미를 명확히 설명
                                - 다른 보고서 섹션과 중복되지 않게 작성
                                - 결론에 해당하는 문단은 작성하지 말 것 (해당 보고서는 전체 보고서의 섹션 중 하나임)
                                
                                ## 할루시네이션 방지 지침
                                - 실제로 확인된 데이터만 포함하고, 모든 분석은 구체적인 수치를 인용하세요.
                                - 데이터에서 확인되지 않은 내용에 대해서는 "확인할 수 없었습니다" 또는 "데이터가 없습니다"라고 명시하세요.
                                - 불확실한 내용은 서술하지 말고, 확실한 내용만 포함하세요.
                                - 일반적인 재무 분석 개념을 적용할 때도 반드시 해당 기업의 실제 데이터를 참조하세요.
                                - 분석 작성 시 각 문장이 수집된 특정 데이터에 근거하는지 확인하세요.
                                
                                
                                기업: {company_name} ({company_code})
                                ##분석일: {reference_date}(YYYYMMDD 형식)
                            """,
                server_names=["webresearch"]
            ),
            "financial_analysis3": Agent(
                name="financial_statement_analyzer3",
                instruction=f"""당신은 기업 현금흐름표 데이터 수집 및 분석 전문가입니다. 다음 단계로 업무를 수행하세요:

                                ## 1. 데이터 수집
                                - 아래 URL에 접속하여 {year} 년도로부터 2~3년 전까지의 현금흐름표 자료를 수집하세요.
                                - URL 접속 시 visit_page tool을 사용하고 takeScreenshot 파라미터는 false로 설정하세요.
                                - '현금흐름표' 탭을 선택해서 데이터를 수집하세요.
                                - 차트보다는 테이블 위주로 데이터를 수집하세요.
                                - 웹페이지 접속 및 데이터 수집 성공 여부를 명확히 보고하세요.
                                - 수집한 현금흐름표의 연도와 기간(연간/분기)을 명시하세요.
                                
                                ## 접속 URL('현금흐름표' 탭): {urls['재무분석']}
                                
                                ## 2. 데이터 검증 및 준비
                                - 웹페이지 접속 및 현금흐름표 데이터 수집 성공 여부를 명시적으로 보고하세요.
                                - 어떤 기간의 데이터(예: "2020-2023년 연간 현금흐름표")를 실제로 수집했는지 구체적으로 명시하세요.
                                - 데이터가 부족하거나 없는 경우 "현금흐름표 데이터를 충분히 수집할 수 없었습니다"라고 명시하고 분석을 최소화하세요.
                                - 수집된 주요 항목(영업활동, 투자활동, 재무활동 현금흐름 등)을 확인하고 데이터의 완전성을 평가하세요.
                                - 수집된 데이터의 연도별, 항목별 결측치 여부를 확인하고 보고하세요.
                                - 분석 시작 전에 데이터의 품질과 범위를 명확하게 설명하세요.
                                
                                ## 3. 데이터 분석 및 보고서 작성
                                - 수집된 실제 데이터만 사용하여 분석하고, 웹페이지에서 확인하지 못한 정보는 추측하지 마세요.
                                - 분석 시 "수집된 현금흐름표에 따르면..."과 같은 표현으로 시작하여 정보 출처를 명확히 하세요.
                                - 확실히 확인된 재무 추세와 패턴만 보고하고, 불확실하거나 추측에 기반한 내용은 포함하지 마세요.
                                - 실제 데이터에서 관찰되지 않는 내용은 포함하지 마세요.
                                - {reference_date} 날짜(YYYYMMDD 형식) 기준으로 가장 최근 데이터에 중점을 두세요.
                                - 약 3,000자 내외의 간결한 보고서를 작성하세요. 분량보다 정확성에 집중하세요.
                                
                                ## 보고서 구성 방향
                                - 영업활동 현금흐름의 주요 구성요소와 추이 분석 (실제 데이터 기반)
                                - 투자활동 현금흐름의 주요 항목 및 패턴 분석 (실제 데이터 기반)
                                - 재무활동 현금흐름의 구성과 자금조달 전략 분석 (실제 데이터 기반)
                                - 현금흐름표상 주요 항목간 상호관계 분석 (데이터가 충분한 경우만)
                                - 영업이익 대비 영업활동 현금흐름 비율 분석 (데이터가 있는 경우만)
                                - 기업의 자금 운용 효율성과 유동성 분석 (실제 데이터에 기반한 경우만)
                                - 그 외 수집된 데이터에서 명확히 확인되는 특이점에만 집중하세요.
                                
                                ## 보고서 형식
                                - 보고서 시작 시 반드시 개행문자 2번 삽입 (\n\n)
                                - 섹션 제목: "# 6-3. 심층 재무제표 분석(현금흐름표)"
                                - 데이터 수집 범위와 한계를 먼저 명시한 후 분석 내용 전개
                                - 주요 현금흐름 지표는 마크다운 표 형식으로 정리하세요.
                                - 데이터 인용 시 출처와 기준일자를 명시하세요 (출처: https://comp.wisereport.co.kr/).
                                - 분석은 명확한 소제목으로 구분하여 구조화하세요.
                                
                                ## 작성 스타일
                                - 전문적이고 객관적인 문어체 사용 ('~합니다', '~입니다'로 통일)
                                - 웹페이지에서 직접 확인된 재무 데이터만 사용
                                - 구체적인 수치와 증감률을 제시하고, 그 의미를 명확히 설명
                                - 추측이나 일반적인 산업 지식에 기반한 서술은 피하세요
                                - 다른 보고서 섹션과 중복되지 않게 작성
                                - 결론에 해당하는 문단은 작성하지 말 것 (해당 보고서는 전체 보고서의 섹션 중 하나임)
                                
                                ## 할루시네이션 방지 지침
                                - 실제로 확인된 데이터만 포함하고, 모든 분석은 구체적인 수치를 인용하세요.
                                - 데이터에서 확인되지 않은 내용에 대해서는 "확인할 수 없었습니다" 또는 "데이터가 없습니다"라고 명시하세요.
                                - 불확실한 내용은 서술하지 말고, 확실한 내용만 포함하세요.
                                - 일반적인 재무 분석 개념을 적용할 때도 반드시 해당 기업의 실제 데이터를 참조하세요.
                                - 분석 작성 시 각 문장이 수집된 특정 데이터에 근거하는지 확인하세요.
                                
                                기업: {company_name} ({company_code})
                                ##분석일: {reference_date}(YYYYMMDD 형식)
                                """,
                server_names=["webresearch"]
            ),
            "investment_indicators": Agent(
                name="investment_indicator_analyzer",
                instruction=f"""당신은 투자 지표 데이터 수집 및 분석 전문가입니다. 다음 단계로 업무를 수행하세요:

                                ## 1. 데이터 수집
                                - 아래 URL에 접속하여 {year} 년도로부터 2~3년 전까지의 투자지표 자료를 수집하세요.
                                - URL 접속 시 visit_page tool을 사용하고 takeScreenshot 파라미터는 false로 설정하세요.
                                - 페이지 내 '수익성', '성장성', '안정성', '활동성' 등의 탭이 있다면 각 탭에 접근하여 데이터를 수집하세요.
                                - URL 파라미터를 조절하여 다양한 탭에 접근해 보세요.
                                - 차트보다는 테이블 위주로 데이터를 수집하세요.
                                - 웹페이지 접속 및 데이터 수집 성공 여부를 명확히 보고하세요.
                                - 수집한 투자지표 데이터의 종류와 기간을 명시하세요.
                                
                                ## 접속 URL: {urls['투자지표']}
                                
                                ## 2. 데이터 검증 및 준비
                                - 웹페이지 접속 및 투자지표 데이터 수집 성공 여부를 명시적으로 보고하세요.
                                - 어떤 종류의 지표(예: "PER, PBR, ROE, EPS, 배당수익률")를 실제로 수집했는지 구체적으로 명시하세요.
                                - 어떤 기간의 데이터(예: "2020-2023년 투자지표")를 실제로 수집했는지 구체적으로 명시하세요.
                                - 데이터가 부족하거나 없는 경우 "투자지표 데이터를 충분히 수집할 수 없었습니다"라고 명시하고 분석을 최소화하세요.
                                - 수집된 주요 지표들의 데이터 완전성을 평가하고, 결측치가 있는 경우 이를 명시하세요.
                                - 특히 중요한 투자지표(PER, PBR, ROE 등)의 데이터 품질을 확인하세요.
                                - 분석 시작 전에 데이터의 품질과 범위를 명확하게 설명하세요.
                                
                                ## 3. 데이터 분석 및 보고서 작성
                                - 수집된 실제 데이터만 사용하여 분석하고, 웹페이지에서 확인하지 못한 정보는 추측하지 마세요.
                                - 분석 시 "수집된 투자지표 데이터에 따르면..."과 같은 표현으로 시작하여 정보 출처를 명확히 하세요.
                                - 확실히 확인된 투자지표 추세와 패턴만 보고하고, 불확실하거나 추측에 기반한 내용은 포함하지 마세요.
                                - 실제 데이터에서 관찰되지 않는 내용은 포함하지 마세요.
                                - {reference_date} 날짜(YYYYMMDD 형식) 기준으로 가장 최근 데이터에 중점을 두세요.
                                - 약 3,000자 내외의 간결한 보고서를 작성하세요. 분량보다 정확성과 분석의 질에 집중하세요.
                                
                                ## 보고서 구성 방향
                                - 수익성 지표(ROE, ROA, 영업이익률 등) 분석 (실제 데이터 기반)
                                - 성장성 지표(매출 성장률, EPS 성장률 등) 분석 (실제 데이터 기반)
                                - 밸류에이션 지표(PER, PBR, EV/EBITDA 등) 분석 (실제 데이터 기반)
                                - 배당 관련 지표(배당수익률, 배당성향 등) 분석 (데이터가 있는 경우만)
                                - 동종 업계 또는 시장 평균과의 비교 (비교 데이터가 있는 경우만)
                                - 투자 매력도 평가 (객관적인 데이터에 기반한 경우만)
                                - 잠재적 리스크 요인 분석 (데이터에서 명확히 확인되는 경우만)
                                - 그 외 수집된 데이터에서 명확히 확인되는 특이점에만 집중하세요.
                                
                                ## 보고서 형식
                                - 보고서 시작 시 반드시 개행문자 2번 삽입 (\\n\\n)
                                - 섹션 제목: "# 7. 투자 지표 및 가치 평가 분석"
                                - 데이터 수집 범위와 한계를 먼저 명시한 후 분석 내용 전개
                                - 주요 투자 지표는 마크다운 표 형식으로 정리하고, 가능하면 연도별 추이를 보여주세요.
                                - 분석은 명확한 소제목으로 구분하여 구조화하세요. 
                                - 데이터 인용 시 출처와 기준일자를 명시하세요 (출처: https://comp.wisereport.co.kr/).
                                
                                ## 작성 스타일
                                - 전문적이고 객관적인 문어체 사용 ('~합니다', '~입니다'로 통일)
                                - 웹페이지에서 직접 확인된 투자지표 데이터만 사용
                                - 구체적인 수치를 제시하고, 그 의미와 시사점을 명확히 설명
                                - 비교 분석 시 정확한 기준과 기간을 명시
                                - 추측이나 일반적인 산업 지식에 기반한 서술은 피하세요
                                - 다른 보고서 섹션과 중복되지 않게 작성
                                - 결론에 해당하는 문단은 작성하지 말 것 (해당 보고서는 전체 보고서의 섹션 중 하나임)
                                
                                ## 할루시네이션 방지 지침
                                - 실제로 확인된 투자지표 데이터만 포함하고, 모든 분석은 구체적인 수치를 인용하세요.
                                - 데이터에서 확인되지 않은 지표에 대해서는 "해당 지표는 확인할 수 없었습니다" 또는 "데이터가 없습니다"라고 명시하세요.
                                - 불확실한 내용은 서술하지 말고, 확실한 내용만 포함하세요.
                                - 밸류에이션 판단 시(저평가/고평가) 반드시 구체적인 수치 기반으로 판단하고, 판단 근거를 명확히 제시하세요.
                                - 미래 전망이나 예측은 실제 수집된 데이터에 명시된 경우에만 포함하세요.
                                - 분석 작성 시 각 문장이 수집된 특정 데이터에 근거하는지 확인하세요.
                                - 동종 업계 비교 시, 실제로 비교 데이터가 수집된 경우에만 비교 분석을 하세요.
                                
                                기업: {company_name} ({company_code})
                                ##분석일: {reference_date}(YYYYMMDD 형식)
                                """,
                server_names=["webresearch"]
            ),
            "competitor_analysis": Agent(
                name="competitor_analysis_analyzer",
                instruction=f"""당신은 경쟁사 분석 데이터 수집 및 분석 전문가입니다. 다음 단계로 업무를 수행하세요:

                                ## 1. 데이터 수집
                                - 아래 URL에 접속하여 {year} 년도로부터 2~3년 전까지의 경쟁사 분석 자료를 수집하세요.
                                - URL 접속 시 visit_page tool을 사용하고 takeScreenshot 파라미터는 false로 설정하세요.
                                - 차트보다는 테이블 위주로 데이터를 수집하세요.
                                - 경쟁사 분석 테이블을 볼 때, 만약 경쟁사의 기업명이 안보이면 종목코드라도 수집해주세요.
                                - 웹페이지 접속 및 데이터 수집 성공 여부를 명확히 보고하세요.
                                - 수집한 경쟁사 데이터의 종류(예: 재무비교, 실적비교 등)와 기간을 명시하세요.
                                - 분석 대상 기업과 비교된 경쟁사 목록을 명확히 기록하세요.
                                
                                ## 접속 URL: {urls['경쟁사분석']}
                                
                                ## 2. 데이터 검증 및 준비
                                - 웹페이지 접속 및 경쟁사 분석 데이터 수집 성공 여부를 명시적으로 보고하세요.
                                - 어떤 경쟁사 기업들의 데이터를 실제로 수집했는지 구체적으로 명시하세요(기업명 또는 종목코드).
                                - 어떤 비교 지표(예: "매출액, 영업이익률, ROE, PER 등")를 실제로 수집했는지 구체적으로 명시하세요.
                                - 어떤 기간의 데이터(예: "2020-2023년 경쟁사 비교")를 수집했는지 구체적으로 명시하세요.
                                - 데이터가 부족하거나 없는 경우 "경쟁사 분석 데이터를 충분히 수집할 수 없었습니다"라고 명시하고 분석을 최소화하세요.
                                - 수집된 주요 지표들의 데이터 완전성을 평가하고, 결측치가 있는 경우 이를 명시하세요.
                                - 분석 시작 전에 데이터의 품질과 범위를 명확하게 설명하세요.
                                
                                ## 3. 데이터 분석 및 보고서 작성
                                - 수집된 실제 데이터만 사용하여 분석하고, 웹페이지에서 확인하지 못한 정보는 추측하지 마세요.
                                - 분석 시 "수집된 경쟁사 비교 데이터에 따르면..."과 같은 표현으로 시작하여 정보 출처를 명확히 하세요.
                                - 확실히 확인된 경쟁 관계와 패턴만 보고하고, 불확실하거나 추측에 기반한 내용은 포함하지 마세요.
                                - 실제 데이터에서 관찰되지 않는 내용은 포함하지 마세요.
                                - {reference_date} 날짜(YYYYMMDD 형식) 기준으로 가장 최근 데이터에 중점을 두세요.
                                - 약 3,000자 내외의 간결한 보고서를 작성하세요. 분량보다 정확성과 분석의 질에 집중하세요.
                                
                                ## 보고서 구성 방향
                                - 수집된 경쟁사 목록 및 해당 기업들의 실제 데이터 기반 비교 분석 (NAVER, 카페24, KG이니시스, 다날 등)
                                - 자산총계, 매출액, 영업이익, 순이익 등 페이지에서 확인 가능한 주요 재무 지표 비교 분석
                                - 페이지에서 제공하는 실제 그래프나 차트 데이터 기반의 추세 분석
                                - 동일 업종(소프트웨어 등 WI26 카테고리) 내 위치 분석
                                - IFRS 연결 기준으로 제공되는 실제 경쟁사 데이터 기반 비교 
                                - 수익성 지표(영업이익률, 순이익률, ROE 등) 비교 (데이터가 있는 경우만)
                                - 성장성 지표(매출 성장률, 이익 성장률 등) 비교 (데이터가 있는 경우만)
                                - 밸류에이션 지표(PER, PBR 등) 비교 (데이터가 있는 경우만)
                                - 분석 대상 기업의 경쟁사 대비 현실적인 강점과 약점 (데이터에 기반한 경우만)`
                                - 그 외 수집된 데이터에서 명확히 확인되는 특이점에만 집중하세요.
                                
                                ## 보고서 형식
                                - 보고서 시작 시 반드시 개행문자 2번 삽입 (\\n\\n)
                                - 섹션 제목: "# 8. 경쟁사 비교 분석"
                                - 데이터 수집 범위와 한계(어떤 경쟁사를 포함했는지)를 먼저 명시한 후 분석 내용 전개
                                - 비교 분석은 마크다운 표 형식으로 정리하여 가독성을 높이세요.
                                - 분석은 명확한 소제목으로 구분하여 구조화하세요.
                                - 데이터 인용 시 출처와 기준일자를 명시하세요 (출처: https://comp.wisereport.co.kr/).
                                
                                ## 작성 스타일
                                - 전문적이고 객관적인 문어체 사용 ('~합니다', '~입니다'로 통일)
                                - 웹페이지에서 직접 확인된 경쟁사 비교 데이터만 사용
                                - 구체적인 수치를 제시하고, 상대적 위치와 의미를 명확히 설명
                                - 경쟁사 간 비교 시 정확한 기준과 기간을 명시
                                - 추측이나 일반적인 산업 지식에 기반한 서술은 피하세요
                                - 다른 보고서 섹션과 중복되지 않게 작성
                                - 결론에 해당하는 문단은 작성하지 말 것 (해당 보고서는 전체 보고서의 섹션 중 하나임)
                                
                                ## 할루시네이션 방지 지침
                                - 실제로 확인된 경쟁사와 비교 지표 데이터만 포함하고, 모든 분석은 구체적인 수치를 인용하세요.
                                - 데이터에서 확인되지 않은 경쟁사나 지표에 대해서는 "해당 정보는 확인할 수 없었습니다" 또는 "데이터가 없습니다"라고 명시하세요.
                                - 불확실한 내용은 서술하지 말고, 확실한 내용만 포함하세요.
                                - 경쟁 우위나 열위 판단 시 반드시 구체적인 수치 기반으로 판단하고, 판단 근거를 명확히 제시하세요.
                                - 기업 간 비교는 동일한 기간과 동일한 지표에 대해서만 수행하세요.
                                - 시장 전망이나 예측은 실제 수집된 데이터에 명시된 경우에만 포함하세요.
                                - 분석 작성 시 각 문장이 수집된 특정 데이터에 근거하는지 확인하세요.
                                - 경쟁사 간 관계나 전략에 대한 서술은 웹페이지에서 직접 확인된 정보만 포함하세요.
                    
                    기업: {company_name} ({company_code})
                    ##분석일: {reference_date}(YYYYMMDD 형식)
                    """,
                server_names=["webresearch"]
            ),
            "consensus_data": Agent(
                name="consensus_data_analyzer",
                instruction=f"""당신은 애널리스트 컨센서스 데이터 수집 및 분석 전문가입니다. 다음 단계로 업무를 수행하세요:

                                ## 1. 데이터 수집
                                - 아래 URL에 접속하여 {year} 년도로부터 2~3년 전까지의 컨센서스 자료를 수집하세요.
                                - URL 접속 시 visit_page tool을 사용하고 takeScreenshot 파라미터는 false로 설정하세요.
                                - 페이지 내 '분기' 등의 탭이 있다면 접근하여 데이터를 수집하세요.
                                - URL 파라미터를 조절하여 다양한 탭에 접근해 보세요.
                                - 차트보다는 테이블 위주로 데이터를 수집하세요.
                                - 웹페이지 접속 및 데이터 수집 성공 여부를 명확히 보고하세요.
                                - 수집한 컨센서스 데이터의 종류(예: 매출액 전망, 영업이익 전망, 투자의견 등)와 기간을 명시하세요.
                                
                                ## 접속 URL: {urls['컨센서스']}
                                
                                ## 2. 데이터 검증 및 준비
                                - 웹페이지 접속 및 컨센서스 데이터 수집 성공 여부를 명시적으로 보고하세요.
                                - 어떤 종류의 컨센서스 데이터(예: "매출액/영업이익 전망치, 목표주가, 투자의견 등")를 실제로 수집했는지 구체적으로 명시하세요.
                                - 어떤 기간의 데이터(예: "2023-2025년 전망치")를 수집했는지 구체적으로 명시하세요.
                                - 데이터가 부족하거나 없는 경우 "컨센서스 데이터를 충분히 수집할 수 없었습니다"라고 명시하고 분석을 최소화하세요.
                                - 수집된 컨센서스 데이터의 출처(애널리스트 수, 증권사 등)를 가능한 경우 명시하세요.
                                - 수집된 데이터의 완전성을 평가하고, 결측치가 있는 경우 이를 명시하세요.
                                - 분석 시작 전에 데이터의 품질과 범위를 명확하게 설명하세요.
                                
                                ## 3. 데이터 분석 및 보고서 작성
                                - 수집된 실제 데이터만 사용하여 분석하고, 웹페이지에서 확인하지 못한 정보는 추측하지 마세요.
                                - 분석 시 "수집된 컨센서스 데이터에 따르면..."과 같은 표현으로 시작하여 정보 출처를 명확히 하세요.
                                - 확실히 확인된 전망치와 추세만 보고하고, 불확실하거나 추측에 기반한 내용은 포함하지 마세요.
                                - 실제 데이터에서 관찰되지 않는 내용은 포함하지 마세요.
                                - {reference_date} 날짜(YYYYMMDD 형식) 기준으로 가장 최근 데이터에 중점을 두세요.
                                - 약 3,000자 내외의 간결한 보고서를 작성하세요. 분량보다 정확성과 분석의 질에 집중하세요.
                                
                                ## 보고서 구성 방향
                                - 컨센서스 개요 및 커버리지 현황 (실제 데이터 기반)
                                - 매출액 및 영업이익 전망치 분석 (실제 데이터 기반)
                                - 투자의견 및 목표주가 분석 (실제 데이터 기반)
                                - EPS 전망치 및 PER 추정 분석 (실제 데이터 기반)
                                - 컨센서스 변화 추이 분석 (데이터가 있는 경우만)
                                - 실적 발표 이후 컨센서스 변화 분석 (데이터가 있는 경우만)
                                - 컨센서스 대비 실적 달성률 분석 (데이터가 있는 경우만)
                                - 그 외 수집된 데이터에서 명확히 확인되는 특이점에만 집중하세요.
                                
                                ## 보고서 형식
                                - 보고서 시작 시 반드시 개행문자 2번 삽입 (\\n\\n)
                                - 섹션 제목: "# 9. 애널리스트 컨센서스 분석"
                                - 데이터 수집 범위와 한계를 먼저 명시한 후 분석 내용 전개
                                - 컨센서스 데이터는 마크다운 표 형식으로 정리하여 가독성을 높이세요.
                                - 분석은 명확한 소제목으로 구분하여 구조화하세요.
                                - 데이터 인용 시 출처와 기준일자를 명시하세요 (출처: https://comp.wisereport.co.kr/).
                                
                                ## 작성 스타일
                                - 전문적이고 객관적인 문어체 사용 ('~합니다', '~입니다'로 통일)
                                - 웹페이지에서 직접 확인된 컨센서스 데이터만 사용
                                - 구체적인 수치를 제시하고, 그 의미와 변화 추이를 명확히 설명
                                - 전망치 인용 시 해당 전망의 시점과 출처를 명시
                                - 추측이나 일반적인 산업 지식에 기반한 서술은 피하세요
                                - 다른 보고서 섹션과 중복되지 않게 작성
                                - 결론에 해당하는 문단은 작성하지 말 것 (해당 보고서는 전체 보고서의 섹션 중 하나임)
                                
                                ## 할루시네이션 방지 지침
                                - 실제로 확인된 컨센서스 데이터만 포함하고, 모든 분석은 구체적인 수치를 인용하세요.
                                - 데이터에서 확인되지 않은 전망치에 대해서는 "해당 전망치는 확인할 수 없었습니다" 또는 "데이터가 없습니다"라고 명시하세요.
                                - 불확실한 내용은 서술하지 말고, 확실한 내용만 포함하세요.
                                - 미래 전망을 서술할 때는 반드시 "애널리스트들의 컨센서스에 따르면..."과 같이 출처를 명확히 하세요.
                                - 과거 컨센서스와 실제 실적 비교는 동일한 기간과 동일한 지표에 대해서만 수행하세요.
                                - 컨센서스가 변경된 이유나 배경은 웹페이지에서 직접 확인된 정보만 포함하세요.
                                - 분석 작성 시 각 문장이 수집된 특정 데이터에 근거하는지 확인하세요.
                                - 예상 성장률이나 수익률에 대한 서술은 반드시 컨센서스 데이터에서 직접 확인된 경우에만 포함하세요.
                                
                                기업: {company_name} ({company_code})
                                ##분석일: {reference_date}(YYYYMMDD 형식)
                    """,
                server_names=["webresearch"]
            ),
            "etc_analysis": Agent(
                name="misc_data_analyzer",
                instruction=f"""당신은 지분현황/업종분석/최근리포트 데이터 수집 및 분석 전문가입니다. 다음 단계로 업무를 수행하세요:

                            ## 1. 데이터 수집
                            - 아래 URL 리스트에 접속하여 {year} 년도로부터 2~3년 전까지의 자료를 수집하세요.
                            - URL 접속 시 visit_page tool을 사용하고 takeScreenshot 파라미터는 false로 설정하세요.
                            - 차트보다는 테이블 위주로 데이터를 수집하세요.
                            - 세 가지 URL 모두 접근하여 각각의 데이터를 수집하세요.
                            - 각 URL 접속 및 데이터 수집 성공 여부를 명확히 보고하세요.
                            - 수집한 데이터의 종류와 기간을 각 URL별로 명시하세요.
                            
                            ## 접속 URL 리스트:
                            1. 지분현황: {urls['지분현황']}
                            2. 업종분석: {urls['업종분석']}
                            3. 최근리포트: {urls['최근리포트']}
                            
                            ## 2. 데이터 검증 및 준비
                            - 각 웹페이지 접속 및 데이터 수집 성공 여부를 명시적으로 보고하세요.
                            - 각 URL에서 어떤 종류의 데이터를 실제로 수집했는지 구체적으로 명시하세요:
                              * 지분현황: 주요 주주 구성, 기관/외국인 보유 비율 등
                              * 업종분석: 업종 내 위치, 경쟁사 비교 등
                              * 최근리포트: 리포트 제목, 작성 기관, 투자의견 등
                            - 어떤 기간의 데이터를 수집했는지 구체적으로 명시하세요.
                            - 데이터가 부족하거나 없는 URL이 있는 경우 명시적으로 언급하고 해당 부분의 분석을 최소화하세요.
                            - 수집된 데이터의 완전성을 평가하고, 결측치가 있는 경우 이를 명시하세요.
                            - 분석 시작 전에 각 영역별 데이터의 품질과 범위를 명확하게 설명하세요.
                            
                            ## 3. 데이터 분석 및 보고서 작성
                            - 수집된 실제 데이터만 사용하여 분석하고, 웹페이지에서 확인하지 못한 정보는 추측하지 마세요.
                            - 분석 시 "수집된 [지분현황/업종분석/최근리포트] 데이터에 따르면..."과 같은 표현으로 시작하여 정보 출처를 명확히 하세요.
                            - 확실히 확인된 내용만 보고하고, 불확실하거나 추측에 기반한 내용은 포함하지 마세요.
                            - 실제 데이터에서 관찰되지 않는 내용은 포함하지 마세요.
                            - {reference_date} 날짜(YYYYMMDD 형식) 기준으로 가장 최근 데이터에 중점을 두세요.
                            - 세 가지 영역을 모두 포함하여 약 3,000자 내외의 간결한 보고서를 작성하세요. 분량보다 정확성과 분석의 질에 집중하세요.
                            
                            ## 보고서 구성 방향
                            ### 지분현황 분석
                            - 주요 주주 구성 및 지분율 분석 (실제 데이터 기반)
                            - 기관/외국인/개인 투자자 비중 분석 (실제 데이터 기반)
                            - 주요 주주 지분 변동 추이 분석 (데이터가 있는 경우만)
                            - 지배구조 특징 분석 (데이터에서 명확히 확인되는 경우만)
                            - 그 외 수집된 데이터에서 발견되는 특이점과 주요 인사이트에 집중하세요.
                            
                            ### 업종분석
                            - 소속 업종 및 업종 내 위치 분석 (실제 데이터 기반)
                            - 업종 내 주요 지표 비교 분석 (실제 데이터 기반)
                            - 업종 평균 대비 성과 및 밸류에이션 분석 (데이터가 있는 경우만)
                            
                            ### 최근리포트 분석
                            - 최근 발표된 리포트 목록 및 작성 기관 (실제 데이터 기반)
                            - 리포트 주요 내용 요약 (데이터가 있는 경우만)
                            - 투자의견 및 목표가 트렌드 (데이터가 있는 경우만)
                            
                            ## 보고서 형식
                            - 보고서 시작 시 반드시 개행문자 2번 삽입 (\\n\\n)
                            - 섹션 제목: "# 10. 지분현황/업종분석/최근리포트 분석"
                            - 데이터 수집 범위와 한계를 먼저 명시한 후 분석 내용 전개
                            - 각 영역(지분현황/업종분석/최근리포트)을 소제목으로 구분하여 구조화하세요.
                            - 데이터는 가능한 마크다운 표 형식으로 정리하여 가독성을 높이세요.
                            - 데이터 인용 시 출처와 기준일자를 명시하세요 (출처: https://comp.wisereport.co.kr/).
                            
                            ## 작성 스타일
                            - 전문적이고 객관적인 문어체 사용 ('~합니다', '~입니다'로 통일)
                            - 웹페이지에서 직접 확인된 데이터만 사용
                            - 구체적인 수치를 제시하고, 그 의미와 변화 추이를 명확히 설명
                            - 추측이나 일반적인 산업 지식에 기반한 서술은 피하세요
                            - 다른 보고서 섹션과 중복되지 않게 작성
                            - 각 영역별로 균형 있는 분량 배분
                            - 결론에 해당하는 문단은 작성하지 말 것 (해당 보고서는 전체 보고서의 섹션 중 하나임)
                            
                            ## 할루시네이션 방지 지침
                            - 실제로 확인된 데이터만 포함하고, 모든 분석은 구체적인 수치를 인용하세요.
                            - 데이터에서 확인되지 않은 내용에 대해서는 "해당 정보는 확인할 수 없었습니다" 또는 "데이터가 없습니다"라고 명시하세요.
                            - 불확실한 내용은 서술하지 말고, 확실한 내용만 포함하세요.
                            - 지분변동 이유나 최근리포트의 세부 내용은 웹페이지에서 직접 확인된 경우에만 포함하세요.
                            - 각 영역별 분석은 명확히 구분하고, 한 영역의 데이터를 다른 영역에 섞어 사용하지 마세요.
                            - 분석 작성 시 각 문장이 수집된 특정 데이터에 근거하는지 확인하세요.
                            - 업종 분석 시 업종 평균과 비교할 때는 실제로 비교 데이터가 있는 경우에만 분석하세요.
                            - 리포트 내용 요약 시, 실제로 확인한 내용만 포함하고 자의적 해석은 피하세요.
                            
                            기업: {company_name} ({company_code})
                            ##분석일: {reference_date}(YYYYMMDD 형식)
                            """,
                server_names=["webresearch"]
            ),
            "news_data": Agent(
                name="news_data_analyzer",
                instruction=f"""당신은 뉴스 및 리서치 데이터 수집 및 분석 전문가입니다. 다음 단계로 업무를 수행하세요:

                                ## 1. 데이터 수집
                                - exa server의 search tool을 사용하여 {reference_date} 날짜(YYYYMMDD 형식) 근처의 최신 뉴스 및 리서치 자료를 수집하세요.
                                - numResults 파라미터를 반드시 5 이하로 설정하여 검색 결과를 제한하세요.
                                - 검색 예시: search({{"query": "{company_name} 실적", "numResults": 5}})
                                - 기업명, 업종, 관련 키워드 등을 활용하여 적절한 검색 쿼리를 구성하세요.
                                - 정확한 최신 뉴스에 집중하여 약 5개의 핵심 뉴스만 수집하세요.
                                - 검색 결과 및 뉴스 수집 성공 여부를 명확히 보고하세요.
                                - 수집한 뉴스의 출처와 날짜를 명시하세요.
                                
                                # 중요: Rate Limit 예방과 데이터 정제를 위해 항상 numResults를 3 이하로 설정하세요.
                                # 결과의 양보다 질과 관련성에 집중하세요.
                                
                                ## 수집 항목 (각 항목마다 2~3개의 뉴스만 수집):
                                - 주요 기업 관련 뉴스 (2~3개)
                                - 산업 관련 뉴스 (2~3개)
                                
                                ## 2. 데이터 검증 및 준비
                                - 검색 결과 및 뉴스 수집 성공 여부를 명시적으로 보고하세요.
                                - 어떤 종류의 뉴스(기업 실적, 산업 동향, 애널리스트 의견 등)를 실제로 수집했는지 구체적으로 명시하세요.
                                - 수집한 뉴스의 날짜 범위를 명시하세요.
                                - 데이터가 부족하거나 없는 경우 "관련 뉴스를 충분히 수집할 수 없었습니다"라고 명시하고 분석을 최소화하세요.
                                - 수집된 뉴스의 신뢰성과 관련성을 평가하세요.
                                - 분석 시작 전에 수집된 뉴스의 품질과 범위를 명확하게 설명하세요.
                                
                                ## 3. 데이터 분석 및 보고서 작성
                                - 수집된 실제 뉴스 내용만 사용하여 분석하고, 검색 결과에서 확인하지 못한 정보는 추측하지 마세요.
                                - 분석 시 "수집된 뉴스에 따르면..."과 같은 표현으로 시작하여 정보 출처를 명확히 하세요.
                                - 확실히 확인된 사실과 이슈만 보고하고, 불확실하거나 추측에 기반한 내용은 포함하지 마세요.
                                - {reference_date} 날짜(YYYYMMDD 형식) 기준으로 가장 최근 뉴스에 중점을 두세요.
                                - 최대 3,000자 내외의 간결한 보고서를 작성하세요. 분량보다 핵심 인사이트에 집중하세요.
                                
                                ## 보고서 구성 방향
                                - 가장 중요한 3~5개의 뉴스 이슈만 요약 및 간략 분석 (세부 내용은 생략)
                                - 투자 결정에 실질적 영향을 미칠 수 있는 핵심 정보에만 집중
                                - 중복되거나 유사한 뉴스는 하나로 통합하여 요약
                                - 각 뉴스 항목은 제목, 날짜, 출처를 명시하고 핵심 내용만 간략히 요약
                                - 뉴스 간의 연관성이나 추세가 있는 경우 이를 간략히 분석
                                - 그 외 수집된 데이터에서 발견되는 특이점과 주요 인사이트에 집중하세요.
                                
                                ## 보고서 형식
                                - 보고서 시작 시 반드시 개행문자 2번 삽입 (\\n\\n)
                                - 섹션 제목: "# 11. 뉴스 트렌드 및 시장 반응 분석"
                                - 데이터 수집 범위와 한계를 먼저 명시한 후 분석 내용 전개
                                - 핵심 뉴스만 날짜와 제목을 포함하여 간략히 정리 (최대 5개)
                                - 분석은 명확한 소제목으로 구분하여 구조화하세요.
                                - 불필요한 세부 내용은 과감히 생략하세요.
                                
                                ## 작성 스타일
                                - 간결하고 명확한 문장 사용 ('~합니다', '~입니다'로 통일)
                                - 주요 핵심만 전달하고 불필요한 부연 설명 최소화
                                - 각 뉴스 내용은 객관적으로 요약하고 과장하지 않음
                                - 다른 보고서 섹션과 중복되지 않게 작성
                                - 핵심 내용을 3-5개의 요점으로 정리하는 방식 권장
                                - 결론에 해당하는 문단은 작성하지 말 것 (해당 보고서는 전체 보고서의 섹션 중 하나임)
                                
                                ## 할루시네이션 방지 지침
                                - 실제로 수집된 뉴스 내용만 포함하고, 확인되지 않은 내용은 추가하지 마세요.
                                - 뉴스 내용을 인용할 때는 원문에 충실하게 요약하고 의미를 왜곡하지 마세요.
                                - 뉴스에서 확인되지 않은 사실이나 전망에 대해서는 "해당 정보는 확인할 수 없었습니다"라고 명시하세요.
                                - 뉴스 분석 시 자의적 해석이나 추측은 포함하지 마세요.
                                - 각 뉴스의 날짜와 출처를 정확히 명시하여 정보의 신뢰성을 확보하세요.
                                - 빠르게 변하는 시장 상황에서는 최신 뉴스에 집중하고, 오래된 정보는 해당 날짜를 명확히 표기하세요.
                                - 분석 작성 시 각 문장이 수집된 특정 뉴스에 근거하는지 확인하세요.
                                
                                기업: {company_name} ({company_code})
                                ##분석일: {reference_date}(YYYYMMDD 형식)
                                """,
                server_names=["exa"]
            )
        }

        # 병렬로 보고서 섹션 작성
        writing_tasks = []
        with concurrent.futures.ThreadPoolExecutor(max_workers=2) as executor:  # worker 수 제한
            for i, (data_key, writer_agent) in enumerate(report_writers.items()):
                writing_tasks.append(
                    write_report_section(data_key, writer_agent,
                                         company_name, company_code, reference_date,
                                         logger, delay=i*10.0)  # 각 작업마다 10초씩 차이
                )

            results = await asyncio.gather(*writing_tasks)
            for data_key, report in results:
                if report:
                    section_reports[data_key] = report

        # 3. 최종 보고서 조합 및 정리
        final_report = ""
        for data_key in report_writers.keys():
            if data_key in section_reports:
                final_report += section_reports[data_key]


        # 4. 최종 보고서에 결론 섹션 추가
        opinion_agent = Agent(
            name="opinion",
            instruction=f"""
                        당신은 {company_name} ({company_code}) 기업분석 보고서에 대한 종합 결론과 투자자 유형별 투자 의견을 작성하는 투자 전문가입니다.
                        보고서 전체를 종합적으로 분석하여 보고서 맨 앞에 배치될 결론 섹션을 작성해야 합니다.
                        객관적인 데이터를 바탕으로 신중하고 전문적인 의견을 제시하세요.
                        
                        ##분석일 : {reference_date}(YYYYMMDD 형식)
                        """
        )

        final_llm = await opinion_agent.attach_llm(OpenAIAugmentedLLM)
        opinion = await final_llm.generate_str(
            message=f"""{company_name}({company_code})의 기업분석 보고서에 대한 종합 결론과 다양한 투자자 유형별 투자 의견을 5,000자 정도로 작성해주세요.
                        (##분석일 : {reference_date}(YYYYMMDD 형식))
                        
                        ## 주의사항 언급 : 투자의 책임은 본인에게 있다는 형식적인 워딩으로 보고서를 시작하세요.

                        ## 형식 가이드라인:
            
                        결론 부분은 아래 마크다운 형식의 구조로 작성하되, 전체 보고서의 맨 앞에 배치될 것입니다:
                        
                        ```
                        # 투자 결론 및 제언
                        
                        ## 종합 분석 요약
                        (여기에 내용 작성)
                        
                        ## 투자자 유형별 전략
                        
                        ### 1. 신규 투자자 전략
                        (여기에 내용 작성)
                        
                        ### 2. 기존 보유자 전략
                        (여기에 내용 작성)
                        
                        ### 3. 포트폴리오 관점 전략
                        (여기에 내용 작성)
                        
                        ### 4. 투자 성향별 접근법
                        (여기에 내용 작성)
                        
                        ### 5. 자금 배분 전략
                        (여기에 내용 작성)
                        ```
                        
                        ## 말투 및 문체 가이드라인:
                        
                        1. 전문적이고 간결한 문체 사용: 불필요한 수식어 배제, 핵심만 전달
                           예시: "~할 것으로 보입니다" 대신 "~할 것으로 예상됩니다" 또는 "~입니다"
                        
                        2. 분석적이고 객관적인 톤 유지: 
                           - "매우 좋은 기회입니다"(×) → "PER 기준 저평가 구간입니다"(○)
                           - "반드시 매수해야 합니다"(×) → "매수 검토가 적절합니다"(○)
                        
                        3. 명확한 수치와 근거 제시:
                           - "높은 성장이 예상됩니다"(×) → "2024년 매출 101.73% 성장이 예상됩니다"(○)
                           
                        4. 단정적 표현보다 확률적/조건부 표현 사용:
                           - "주가는 상승할 것입니다"(×) → "시장 회복 시 주가 상승 가능성이 높습니다"(○)
                        
                        5. 직접적 투자 권유보다 정보 제공 형태로 작성:
                           - "지금 매수하세요"(×) → "현 밸류에이션은 매수 시점으로 판단됩니다"(○)
                                            
                        ## 내용 가이드라인:
                        
                        ### 1. 종합 분석 요약 (400-600자)
                        - 핵심 재무지표 추이 요약
                        - 시장 내 위치 및 경쟁력 평가
                        - 향후 1-2년 전망
                        - 주요 리스크 요인
                        
                        ### 2. 신규 투자자 전략
                        - 현 진입 적정성 판단과 근거
                        - 자금 규모별 접근법
                        - 목표가/손절가 제시
                        - 적정 진입 시점
                        
                        ### 3. 기존 보유자 전략
                        - 보유 지속 여부 판단
                        - 평균단가별 대응방안
                        - 추가매수/분할매도 전략
                        - 장기보유 시 모니터링 포인트
                        
                        ### 4. 포트폴리오 관점 전략
                        - 반도체 업종 내 비중
                        - 전체 포트폴리오 내 적정 비중
                        - 상관관계 높은 종목들과의 관계
                        - 글로벌 경기/환율 변동 대응법
                        
                        ### 5. 투자 성향별 접근법
                        - 가치/성장/배당/기술적 분석 관점별 전략
                        - 투자 기간별 접근법
                        - 위험 감수성향별 대응법
                        
                        ### 6. 자금 배분 전략
                        - 일시투자 vs 분할투자 비교
                        - 매수 비율 및 타이밍
                        - 투자금 규모별 실행방안
                        
                        첨부된 보고서 내용:
                        {final_report}
                        """,
            request_params=RequestParams(
                model="gpt-4o-mini",
                maxTokens=8000,
                max_iterations=5,
                parallel_tool_calls=True,
                use_history=True
            )
        )

        # 면책 문구 정의
        disclaimer = """# 투자 유의사항
        
                        본 보고서는 정보 제공을 목적으로 작성되었으며, 투자 권유를 목적으로 하지 않습니다. 
                        본 보고서에 기재된 내용은 작성 시점 기준으로 신뢰할 수 있는 자료에 근거하여 AI로 작성되었으나, 
                        그 정확성과 완전성을 보장하지 않습니다.
                        
                        투자는 본인의 판단과 책임 하에 신중하게 이루어져야 하며, 
                        본 보고서를 참고하여 발생하는 투자 결과에 대한 책임은 투자자 본인에게 있습니다.
        
                      """

        ##todo : 개행문자 있는 그대로 나와버림
        ##todo : 재무분석, 경쟁사분석 등 데이터 많으면 할루시네이션 일어남
        ##todo : news는 webresearch로 하는게 어떨까?
        final_report = disclaimer + " \n\n " + opinion + " \n\n " + final_report
        # 최종 마크다운 정리
        final_report = clean_markdown(final_report)


        logger.info(f"Finalized report for {company_name} - {len(final_report)} characters")
        logger.info(f"Analysis completed for {company_name}.")
        logger.info(f"Final Report : " + final_report)

        return final_report


if __name__ == "__main__":
    import time
    start = time.time()

    # 특정 날짜를 기준으로 분석 실행 (예: 2025년 2월 19일)
    result = asyncio.run(analyze_stock(company_code="008420", company_name="문배철강", reference_date="20250226"))

    # 결과 저장
    with open(f"SK하이닉스_분석보고서_{datetime.now().strftime('%Y%m%d')}.md", "w", encoding="utf-8") as f:
        f.write(result)

    end = time.time()
    print(f"총 실행 시간: {end - start:.2f}초")
    print(f"최종 보고서 길이: {len(result):,} 글자")