import asyncio
import concurrent.futures
import re
from datetime import datetime, timedelta

from mcp_agent.agents.agent import Agent
from mcp_agent.app import MCPApp
from mcp_agent.workflows.llm.augmented_llm import RequestParams
from mcp_agent.workflows.llm.augmented_llm_openai import OpenAIAugmentedLLM

app = MCPApp(name="stock_analysis")

# WiseReport URL 템플릿 설정
WISE_REPORT_BASE = "https://comp.wisereport.co.kr/company/"
URLS = {
    "기업현황": "c1010001.aspx?cmp_cd={}",
    "기업개요": "c1020001.aspx?cmp_cd={}",
    "재무분석": "c1030001.aspx?cmp_cd={}",
    "투자지표": "c1040001.aspx?cmp_cd={}",
    "컨센서스": "c1050001.aspx?cmp_cd={}",
    "경쟁사분석": "c1060001.aspx?cmp_cd={}",
    "지분현황": "c1070001.aspx?cmp_cd={}",
    "업종분석": "c1090001.aspx?cmp_cd={}",
    "최근리포트": "c1080001.aspx?cmp_cd={}"
}

async def write_report_section(data_key: str, agent: Agent,
                               company_name: str, company_code: str, reference_date: str, logger, delay: float = 10.0):
    """데이터 수집 및 보고서 작성을 위한 통합 async 함수"""
    # 각 작업 시작 전 지연
    await asyncio.sleep(delay)

    logger.info(f"Processing {data_key} for {company_name}...")

    llm = await agent.attach_llm(OpenAIAugmentedLLM)
    section_report = await llm.generate_str(
        message=f"""{company_name}({company_code})의 {data_key} 분석 보고서를 작성해주세요.
                
                ## 분석 및 보고서 작성 지침:
                1. 데이터 수집부터 분석까지 모든 과정을 수행하세요.
                2. 보고서의 길이는 response token이 허락하는 최대한도를 사용하세요.
                3. 가능하면 5,000글자 이상의 상세한 보고서를 작성하세요.
                4. 최대한 상세하고 구체적인 수치가 많이 들어가도록 전문성 있는 보고서를 작성하세요.
                5. 실제 수집된 데이터에만 기반하여 분석하고, 없는 데이터는 추측하지 마세요.
                
                ## 형식 요구사항:
                1. 보고서 시작 시 제목을 넣기 전에 반드시 개행문자를 2번 넣어 시작하세요 (\\n\\n).
                2. 이는 보고서의 시작부분에서 충분한 여백을 확보하기 위함입니다.
                3. 섹션 제목과 구조는 에이전트 지침에 명시된 형식을 따르세요.
                
                ##분석일: {reference_date}(YYYYMMDD 형식)
                """,
        request_params=RequestParams(
            model="gpt-4o-mini",
            maxTokens=8000,
            max_iterations=5,
            parallel_tool_calls=True,
            use_history=True
        )
    )

    logger.info(f"Completed {data_key} - {len(section_report)} characters")
    return data_key, section_report

def clean_markdown(text: str) -> str:
    """마크다운 텍스트 정리"""

    # 1. 백틱 블록 제거
    text = re.sub(r'```[^\n]*\n(.*?)\n```', r'\1', text, flags=re.DOTALL)

    return text


def get_wise_report_url(report_type: str, company_code: str) -> str:
    """WiseReport URL 생성"""
    return WISE_REPORT_BASE + URLS[report_type].format(company_code)

async def analyze_stock(company_code: str = "000660", company_name: str = "SK하이닉스", reference_date: str = None):
    # reference_date가 없으면 오늘 날짜를 사용
    if reference_date is None:
        reference_date = datetime.now().strftime("%Y%m%d")

    year = reference_date[:4]

    # 날짜 객체로 변환
    ref_date = datetime.strptime(reference_date, "%Y%m%d")

    # 기간 계산
    max_years = 1
    max_years_ago = (ref_date - timedelta(days=365*max_years)).strftime("%Y%m%d")
    six_months_ago = (ref_date - timedelta(days=180)).strftime("%Y%m%d")

    async with app.run() as parallel_app:
        logger = parallel_app.logger
        logger.info(f"시작: {company_name}({company_code}) 분석 - 기준일: {reference_date}")

        # 공유 리소스로 데이터를 저장할 딕셔너리 생성
        section_reports = {}

        # URL 매핑 생성
        urls = {k: get_wise_report_url(k, company_code) for k in URLS.keys()}

        # 데이터 수집 에이전트 설정
        report_writers = {
            "price_data": Agent(
                name="price_data_analyzer",
                instruction=f"""당신은 주가 데이터 수집 및 분석 전문가입니다. 다음 단계로 업무를 수행하세요:

                                ## 1. 데이터 수집
                                - get_stock_ohlcv tool을 사용하여 {max_years_ago} ~ {reference_date} 기간의 주가/거래량 데이터를 수집하세요.
                                - 예시: get_stock_ohlcv("20240101", "20240131", "005930")
                                - 필요시 추가 데이터를 수집하여 분석의 질을 높이세요.
                                
                                ## 2. 데이터 분석 및 보고서 작성
                                - 수집한 데이터를 직접 분석하여 객관적이고 데이터 중심의 분석 보고서를 작성하세요.
                                - 실제로 수집된 데이터를 바탕으로 자율적으로 분석하세요. 수집되지 않은 데이터에 대해 추측하지 마세요.
                                - 데이터에서 나타나는 중요한 패턴, 추세, 특이점을 식별하고 이를 중심으로 분석하세요.
                                - {reference_date} 날짜(YYYYMMDD 형식) 기준으로 가장 최근 흐름에 중점을 두세요.
                                - 5,000자 이상의 상세한 보고서를 작성하되, 모델의 출력 한계(약 8,000자)를 고려하세요.
                                
                                ## 보고서 구성 방향
                                - 수집된 데이터에서 가장 두드러진 특징과 인사이트에 집중하세요.
                                - 기업의 재무 상태를 종합적으로 평가할 수 있는 분석을 수행하세요.
                                - 시간 경과에 따른 변화와 추세를 파악하고 설명하세요.
                                - 가능하다면 동종 업계 평균 또는 경쟁사와 비교한 상대적 위치를 평가하세요.
                                - 분석은 항상 수집된 실제 데이터에 기반해야 합니다.
                                
                                ## 보고서 형식
                                - 보고서 시작 시 반드시 개행문자 2번 삽입 (\n\n)
                                - 첫 번째로 전체 보고서 제목 작성 (예: `{company_name} 기업 분석 보고서 ({reference_date})`)
                                - 그 다음 섹션 제목: "# 1. 주가 및 기술적 분석"
                                - 모든 주요 항목은 마크다운 형식으로 명확히 구조화 (##, ### 등 활용)
                                - 수집된 데이터를 기반으로 적절한 구조와 소제목을 자율적으로 구성하세요.
                                - 복잡한 데이터는 표 형식으로 정리하여 가독성을 높이세요.
                                - 데이터 인용 시 출처와 기준일자 명시 (출처: http://data.krx.co.kr/)
                                
                                ## 작성 스타일
                                - 전문적이고 객관적인 문어체 사용 ('~합니다', '~입니다'로 통일)
                                - 개인적 의견보다 데이터에 기반한 객관적 분석 제시
                                - 모든 분석은 구체적 수치와 기간을 명시
                                - 다른 보고서 섹션(재무분석, 기업개요 등)과 중복되지 않게 작성
                                - 주요 지표와 패턴은 표 형식으로 요약 제시
                                - 결론에 해당하는 문단은 작성하지 말 것 (해당 보고서는 전체 보고서의 섹션 중 하나임)
                                
                                기업: {company_name} ({company_code})
                                ##분석일: {reference_date}(YYYYMMDD 형식)
                                """,
                server_names=["kospi_kosdaq"]
            ),
            "market_cap_data": Agent(
                name="market_cap_analyzer",
                instruction=f"""당신은 시가총액 데이터 수집 및 분석 전문가입니다. 다음 단계로 업무를 수행하세요:

                                ## 1. 데이터 수집
                                - get_stock_market_cap tool을 사용하여 {max_years_ago} ~ {reference_date} 기간(YYYYMMDD 형식)의 시가총액 데이터를 수집하세요.
                                - 예시: get_stock_market_cap("20240101", "20240131", "005930")
                                - 필요시 추가 데이터를 수집하여 분석의 질을 높이세요.
                                
                                ## 2. 데이터 분석 및 보고서 작성
                                - 수집한 데이터를 직접 분석하여 객관적이고 데이터 중심의 분석 보고서를 작성하세요.
                                - 실제로 수집된 데이터를 바탕으로 자율적으로 분석하세요. 수집되지 않은 데이터에 대해 추측하지 마세요.
                                - 데이터에서 나타나는 중요한 패턴, 추세, 특이점을 식별하고 이를 중심으로 분석하세요.
                                - {reference_date} 날짜(YYYYMMDD 형식) 기준으로 가장 최근 흐름에 중점을 두세요.
                                - 5,000자 이상의 상세한 보고서를 작성하되, 모델의 출력 한계(약 8,000자)를 고려하세요.
                                
                                ## 보고서 구성 방향
                                - 수집된 데이터에서 가장 두드러진 특징과 인사이트에 집중하세요.
                                - 시간 경과에 따른 변화와 추세를 파악하고 설명하세요.
                                - 가능하다면 동종 업계 평균 또는 시장 전체와 비교한 상대적 위치를 평가하세요.
                                - 분석은 항상 수집된 실제 데이터에 기반해야 합니다.
                                
                                ## 보고서 형식
                                - 보고서 시작 시 반드시 개행문자 2번 삽입 (\n\n)
                                - 섹션 제목: "# 2. 시가총액 및 유동성 분석"
                                - 수집된 데이터를 기반으로 적절한 구조와 소제목을 자율적으로 구성하세요.
                                - 복잡한 데이터는 표 형식으로 정리하여 가독성을 높이세요.
                                - 데이터 인용 시 출처와 기준일자를 명시하세요 (출처: http://data.krx.co.kr/).
                                
                                ## 작성 스타일
                                - 전문적이고 객관적인 문어체 사용 ('~합니다', '~입니다'로 통일)
                                - 개인적 의견보다 데이터에 기반한 객관적 분석 제시
                                - 수치는 구체적으로 제시하고, 증감 방향과 의미를 명확히 설명
                                - 다른 보고서 섹션과 중복되지 않게 작성
                                - 결론에 해당하는 문단은 작성하지 말 것 (해당 보고서는 전체 보고서의 섹션 중 하나임)
                                
                                기업: {company_name} ({company_code})
                                ##분석일: {reference_date}(YYYYMMDD 형식)
                                """,
                server_names=["kospi_kosdaq"]
            ),
            "trading_volume_data": Agent(
                name="trading_volume_analyzer",
                instruction=f"""당신은 투자자 거래 데이터 수집 및 분석 전문가입니다. 다음 단계로 업무를 수행하세요:

                                ## 1. 데이터 수집
                                - get_stock_trading_volume tool을 사용하여 {max_years_ago} ~ {reference_date} 기간(YYYYMMDD 형식)의 투자자별 거래 데이터를 수집하세요.
                                - 예시: get_stock_trading_volume("20240101", "20240131", "005930")
                                - 필요시 추가 데이터를 수집하여 분석의 질을 높이세요.
                                
                                ## 2. 데이터 분석 및 보고서 작성
                                - 수집한 데이터를 직접 분석하여 객관적이고 데이터 중심의 분석 보고서를 작성하세요.
                                - 실제로 수집된 데이터를 바탕으로 자율적으로 분석하세요. 수집되지 않은 데이터에 대해 추측하지 마세요.
                                - 데이터에서 나타나는 중요한 패턴, 추세, 특이점을 식별하고 이를 중심으로 분석하세요.
                                - {reference_date} 날짜(YYYYMMDD 형식) 기준으로 가장 최근 흐름에 중점을 두세요.
                                - 5,000자 이상의 상세한 보고서를 작성하되, 모델의 출력 한계(약 8,000자)를 고려하세요.
                                
                                ## 보고서 구성 방향
                                - 수집된 데이터에서 가장 두드러진 특징과 인사이트에 집중하세요.
                                - 시간 경과에 따른 변화와 추세를 파악하고 설명하세요.
                                - 거래량과 주가 움직임 간의 관계가 있다면 이를 분석하세요.
                                - 분석은 항상 수집된 실제 데이터에 기반해야 합니다.
                                
                                ## 보고서 형식
                                - 보고서 시작 시 반드시 개행문자 2번 삽입 (\n\n)
                                - 섹션 제목: "# 3. 투자자 거래 패턴 분석"
                                - 수집된 데이터를 기반으로 적절한 구조와 소제목을 자율적으로 구성하세요.
                                - 복잡한 데이터는 표 형식으로 정리하여 가독성을 높이세요.
                                - 데이터 인용 시 출처와 기준일자를 명시하세요 (출처: http://data.krx.co.kr/).
                                
                                ## 작성 스타일
                                - 전문적이고 객관적인 문어체 사용 ('~합니다', '~입니다'로 통일)
                                - 개인적 의견보다 데이터에 기반한 객관적 분석 제시
                                - 수치는 구체적으로 제시하고, 증감 방향과 의미를 명확히 설명
                                - 다른 보고서 섹션과 중복되지 않게 작성
                                - 결론에 해당하는 문단은 작성하지 말 것 (해당 보고서는 전체 보고서의 섹션 중 하나임)
                                
                                기업: {company_name} ({company_code})
                                ##분석일: {reference_date}(YYYYMMDD 형식)
                                """,
                server_names=["kospi_kosdaq"]
            ),
            "corporate_overview": Agent(
                name="corporate_overview_analyzer",
                instruction=f"""당신은 기업 개요 데이터 수집 및 분석 전문가입니다. 다음 단계로 업무를 수행하세요:

                                ## 1. 데이터 수집
                                - 아래 URL에 접속하여 {reference_date} 날짜(YYYYMMDD 형식)로부터 2~3년 전까지의 자료를 수집하세요.
                                - URL 접속 시 visit_page tool을 사용하고 takeScreenshot 파라미터는 false로 설정하세요.
                                - 차트보다는 테이블 위주로 데이터를 수집하세요.
                                
                                ## 접속 URL: {urls['기업개요']}
                                
                                ## 2. 데이터 분석 및 보고서 작성
                                - 수집한 데이터를 직접 분석하여 객관적이고 데이터 중심의 분석 보고서를 작성하세요.
                                - 실제로 수집된 데이터를 바탕으로 자율적으로 분석하세요. 수집되지 않은 데이터에 대해 추측하지 마세요.
                                - 데이터에서 나타나는 중요한 패턴, 추세, 특이점을 식별하고 이를 중심으로 분석하세요.
                                - {reference_date} 날짜(YYYYMMDD 형식) 기준으로 가장 최근 자료에 중점을 두세요.
                                - 5,000자 이상의 상세한 보고서를 작성하되, 모델의 출력 한계(약 8,000자)를 고려하세요.
                                
                                ## 보고서 구성 방향
                                - 기업의 핵심 사업 영역, 주요 제품/서비스, 사업 구조에 대한 분석
                                - 핵심 전략과 비즈니스 모델의 특징과 강점
                                - 수집된 데이터에서 가장 두드러진 특징과 인사이트에 집중하세요.
                                - 분석은 항상 수집된 실제 데이터에 기반해야 합니다.
                                
                                ## 보고서 형식
                                - 보고서 시작 시 반드시 개행문자 2번 삽입 (\n\n)
                                - 섹션 제목: "# 4. 기업 사업 구조 및 전략 분석"
                                - 수집된 데이터를 기반으로 적절한 구조와 소제목을 자율적으로 구성하세요.
                                - 복잡한 데이터는 표 형식으로 정리하여 가독성을 높이세요.
                                - 데이터 인용 시 출처와 기준일자를 명시하세요 (출처: https://comp.wisereport.co.kr/).
                                
                                ## 작성 스타일
                                - 전문적이고 객관적인 문어체 사용 ('~합니다', '~입니다'로 통일)
                                - 개인적 의견보다 데이터에 기반한 객관적 분석 제시
                                - 수치는 구체적으로 제시하고, 의미를 명확히 설명
                                - 다른 보고서 섹션과 중복되지 않게 작성
                                - 결론에 해당하는 문단은 작성하지 말 것 (해당 보고서는 전체 보고서의 섹션 중 하나임)
                                
                                기업: {company_name} ({company_code})
                                ##분석일: {reference_date}(YYYYMMDD 형식)
                                """,
                server_names=["webresearch"]
            ),
            "corporate_status": Agent(
                name="corporate_status_analyzer",
                instruction=f"""당신은 기업 현황 데이터 수집 및 분석 전문가입니다. 다음 단계로 업무를 수행하세요:

                                ## 1. 데이터 수집
                                - 아래 URL에 접속하여 {year} 년도로부터 2~3년 전까지의 자료를 수집하세요.
                                - URL 접속 시 visit_page tool을 사용하고 takeScreenshot 파라미터는 false로 설정하세요.
                                - 차트보다는 테이블 위주로 데이터를 수집하세요.
                                
                                ## 접속 URL: {urls['기업현황']}
                                
                                ## 2. 데이터 분석 및 보고서 작성
                                - 수집한 데이터를 직접 분석하여 객관적이고 데이터 중심의 분석 보고서를 작성하세요.
                                - 실제로 수집된 데이터를 바탕으로 자율적으로 분석하세요. 수집되지 않은 데이터에 대해 추측하지 마세요.
                                - 데이터에서 나타나는 중요한 패턴, 추세, 특이점을 식별하고 이를 중심으로 분석하세요.
                                - {reference_date} 날짜(YYYYMMDD 형식) 기준으로 가장 최근 자료에 중점을 두세요.
                                - 5,000자 이상의 상세한 보고서를 작성하되, 모델의 출력 한계(약 8,000자)를 고려하세요.
                                
                                ## 보고서 구성 방향
                                - 기업의 지배구조, 주요 경영진, 조직체계 등에 대한 분석
                                - 주요 경영 현황과 경영진의 특징적인 전략 방향
                                - 수집된 데이터에서 가장 두드러진 특징과 인사이트에 집중하세요.
                                - 분석은 항상 수집된 실제 데이터에 기반해야 합니다.
                                
                                ## 보고서 형식
                                - 보고서 시작 시 반드시 개행문자 2번 삽입 (\n\n)
                                - 섹션 제목: "# 5. 기업 지배구조 및 경영 현황 분석"
                                - 수집된 데이터를 기반으로 적절한 구조와 소제목을 자율적으로 구성하세요.
                                - 복잡한 데이터는 표 형식으로 정리하여 가독성을 높이세요.
                                - 데이터 인용 시 출처와 기준일자를 명시하세요 (출처: https://comp.wisereport.co.kr/).
                                
                                ## 작성 스타일
                                - 전문적이고 객관적인 문어체 사용 ('~합니다', '~입니다'로 통일)
                                - 개인적 의견보다 데이터에 기반한 객관적 분석 제시
                                - 수치는 구체적으로 제시하고, 의미를 명확히 설명
                                - 다른 보고서 섹션과 중복되지 않게 작성
                                - 결론에 해당하는 문단은 작성하지 말 것 (해당 보고서는 전체 보고서의 섹션 중 하나임)
                                
                                기업: {company_name} ({company_code})
                                ##분석일: {reference_date}(YYYYMMDD 형식)
                                """,
                server_names=["webresearch"]
            ),
            "fundamental_data": Agent(
                name="fundamental_data_analyzer",
                instruction=f"""당신은 기업 재무 데이터 수집 및 분석 전문가입니다. 다음 단계로 업무를 수행하세요:

                                ## 1. 데이터 수집
                                - get_stock_fundamental tool을 사용하여 {max_years_ago} ~ {reference_date} 기간(YYYYMMDD 형식)의 재무 지표를 수집하세요.
                                - 예시: get_stock_fundamental("20240101", "20240131", "005930")
                                - 필요시 추가 데이터를 수집하여 분석의 질을 높이세요.
                                - 주요 수집 항목: PER, PBR, EPS, BPS, 배당률(DIV), 주당 배당금(DPS) 등 기본적 분석 지표
                                
                                ## 2. 데이터 분석 및 보고서 작성
                                - 수집한 데이터를 직접 분석하여 객관적이고 데이터 중심의 분석 보고서를 작성하세요.
                                - 실제로 수집된 데이터를 바탕으로 자율적으로 분석하세요. 수집되지 않은 데이터에 대해 추측하지 마세요.
                                - 데이터에서 나타나는 중요한 패턴, 추세, 특이점을 식별하고 이를 중심으로 분석하세요.
                                - {reference_date} 날짜(YYYYMMDD 형식) 기준으로 가장 최근 흐름에 중점을 두세요.
                                - 5,000자 이상의 상세한 보고서를 작성하되, 모델의 출력 한계(약 8,000자)를 고려하세요.
                                
                                ## 보고서 구성 방향
                                - 수집된 데이터에서 가장 두드러진 특징과 인사이트에 집중하세요.
                                - 기업의 재무 상태를 종합적으로 평가할 수 있는 분석을 수행하세요.
                                - 시간 경과에 따른 변화와 추세를 파악하고 설명하세요.
                                - 가능하다면 동종 업계 평균 또는 경쟁사와 비교한 상대적 위치를 평가하세요.
                                - 분석은 항상 수집된 실제 데이터에 기반해야 합니다.
                                
                                ## 보고서 형식
                                - 보고서 시작 시 반드시 개행문자 2번 삽입 (\n\n)
                                - 섹션 제목: "# 6. 재무 및 기본적 분석"
                                - 모든 주요 항목은 마크다운 형식으로 명확히 구조화 (##, ### 등 활용)
                                - 수집된 데이터를 기반으로 적절한 구조와 소제목을 자율적으로 구성하세요.
                                - 복잡한 데이터는 표 형식으로 정리하여 가독성을 높이세요.
                                - 데이터 인용 시 출처와 기준일자를 명시하세요.
                                
                                ## 작성 스타일
                                - 전문적이고 객관적인 문어체 사용 ('~합니다', '~입니다'로 통일)
                                - 개인적 의견보다 데이터에 기반한 객관적 분석 제시 ('~나타납니다', '~확인됩니다' 사용)
                                - 모든 분석은 구체적 수치와 기간을 명시
                                - 다른 보고서 섹션과 중복되지 않게 작성
                                - 결론에 해당하는 문단은 작성하지 말 것 (해당 보고서는 전체 보고서의 섹션 중 하나임)
                                
                                기업: {company_name} ({company_code})
                                ##분석일: {reference_date}(YYYYMMDD 형식)
                                """,
                server_names=["kospi_kosdaq"]
            ),
            "financial_analysis1": Agent(
                name="financial_statement_analyzer1",
                instruction=f"""당신은 기업 포괄손익계산서 데이터 수집 및 분석 전문가입니다. 다음 단계로 업무를 수행하세요:

                                ## 1. 데이터 수집
                                - 아래 URL에 접속하여 {year} 년도로부터 2~3년 전까지의 포괄손익계산서 자료를 수집하세요.
                                - URL 접속 시 visit_page tool을 사용하고 takeScreenshot 파라미터는 false로 설정하세요.
                                - '포괄손익계산서' 탭을 선택해서 데이터를 수집하세요.
                                - 차트보다는 테이블 위주로 데이터를 수집하세요.
                                
                                ## 접속 URL('포괄손익계산서' 탭): {urls['재무분석']}
                                
                                ## 2. 데이터 분석 및 보고서 작성
                                - 수집한 데이터를 직접 분석하여 객관적이고 데이터 중심의 분석 보고서를 작성하세요.
                                - 실제로 수집된 데이터를 바탕으로 자율적으로 분석하세요. 수집되지 않은 데이터에 대해 추측하지 마세요.
                                - 데이터에서 나타나는 중요한 패턴, 추세, 특이점을 식별하고 이를 중심으로 분석하세요.
                                - {reference_date} 날짜(YYYYMMDD 형식) 기준으로 가장 최근 자료에 중점을 두세요.
                                - 5,000자 이상의 상세한 보고서를 작성하되, 모델의 출력 한계(약 8,000자)를 고려하세요.
                                
                                ## 보고서 구성 방향
                                - 매출, 영업이익, 당기순이익 등 주요 항목의 추이 분석
                                - 이익률 변화와 그 원인 분석
                                - 비용 구조 및 효율성 분석
                                - 계절성 또는 주기성이 있다면 이를 식별
                                - 수집된 데이터에서 발견되는 특이점과 주요 인사이트에 집중하세요.
                                - 분석은 항상 수집된 실제 데이터에 기반해야 합니다.
                                
                                ## 보고서 형식
                                - 보고서 시작 시 반드시 개행문자 2번 삽입 (\n\n)
                                - 섹션 제목: "# 7-1. 심층 재무제표 분석(포괄손익계산서)"
                                - 수집된 데이터를 기반으로 적절한 구조와 소제목을 자율적으로 구성하세요.
                                - 복잡한 데이터는 표 형식으로 정리하여 가독성을 높이세요.
                                - 데이터 인용 시 출처와 기준일자를 명시하세요 (출처: https://comp.wisereport.co.kr/).
                                
                                ## 작성 스타일
                                - 전문적이고 객관적인 문어체 사용 ('~합니다', '~입니다'로 통일)
                                - 개인적 의견보다 데이터에 기반한 객관적 분석 제시
                                - 수치는 구체적으로 제시하고, 증감률과 의미를 명확히 설명
                                - 다른 보고서 섹션과 중복되지 않게 작성
                                - 결론에 해당하는 문단은 작성하지 말 것 (해당 보고서는 전체 보고서의 섹션 중 하나임)
                                
                                기업: {company_name} ({company_code})
                                ##분석일: {reference_date}(YYYYMMDD 형식)
                                """,
                server_names=["webresearch"]
            ),
            "financial_analysis2": Agent(
                name="financial_statement_analyzer2",
                instruction=f"""당신은 기업 재무상태표 데이터 수집 및 분석 전문가입니다. 다음 단계로 업무를 수행하세요:

                                ## 1. 데이터 수집
                                - 아래 URL에 접속하여 {year} 년도로부터 2~3년 전까지의 재무상태표 자료를 수집하세요.
                                - URL 접속 시 visit_page tool을 사용하고 takeScreenshot 파라미터는 false로 설정하세요.
                                - '재무상태표' 탭을 선택해서 데이터를 수집하세요.
                                - 차트보다는 테이블 위주로 데이터를 수집하세요.
                                
                                ## 접속 URL('재무상태표' 탭): {urls['재무분석']}
                                
                                ## 2. 데이터 분석 및 보고서 작성
                                - 수집한 데이터를 직접 분석하여 객관적이고 데이터 중심의 분석 보고서를 작성하세요.
                                - 실제로 수집된 데이터를 바탕으로 자율적으로 분석하세요. 수집되지 않은 데이터에 대해 추측하지 마세요.
                                - 데이터에서 나타나는 중요한 패턴, 추세, 특이점을 식별하고 이를 중심으로 분석하세요.
                                - {reference_date} 날짜(YYYYMMDD 형식) 기준으로 가장 최근 자료에 중점을 두세요.
                                - 5,000자 이상의 상세한 보고서를 작성하되, 모델의 출력 한계(약 8,000자)를 고려하세요.
                                
                                ## 보고서 구성 방향
                                - 자산, 부채, 자본의 구조와 변화 추이 분석
                                - 유동성 및 재무 안정성 분석
                                - 부채 비율과 재무 레버리지 분석
                                - 수집된 데이터에서 발견되는 특이점과 주요 인사이트에 집중하세요.
                                - 분석은 항상 수집된 실제 데이터에 기반해야 합니다.
                                
                                ## 보고서 형식
                                - 보고서 시작 시 반드시 개행문자 2번 삽입 (\n\n)
                                - 섹션 제목: "# 7-2. 심층 재무제표 분석(재무상태표)"
                                - 수집된 데이터를 기반으로 적절한 구조와 소제목을 자율적으로 구성하세요.
                                - 복잡한 데이터는 표 형식으로 정리하여 가독성을 높이세요.
                                - 데이터 인용 시 출처와 기준일자를 명시하세요 (출처: https://comp.wisereport.co.kr/).
                                
                                ## 작성 스타일
                                - 전문적이고 객관적인 문어체 사용 ('~합니다', '~입니다'로 통일)
                                - 개인적 의견보다 데이터에 기반한 객관적 분석 제시
                                - 수치는 구체적으로 제시하고, 증감률과 의미를 명확히 설명
                                - 다른 보고서 섹션과 중복되지 않게 작성
                                - 결론에 해당하는 문단은 작성하지 말 것 (해당 보고서는 전체 보고서의 섹션 중 하나임)
                                
                                기업: {company_name} ({company_code})
                                ##분석일: {reference_date}(YYYYMMDD 형식)
                                """,
                server_names=["webresearch"]
            ),
            "financial_analysis3": Agent(
                name="financial_statement_analyzer3",
                instruction=f"""당신은 기업 현금흐름표 데이터 수집 및 분석 전문가입니다. 다음 단계로 업무를 수행하세요:

                                ## 1. 데이터 수집
                                - 아래 URL에 접속하여 {year} 년도로부터 2~3년 전까지의 현금흐름표 자료를 수집하세요.
                                - URL 접속 시 visit_page tool을 사용하고 takeScreenshot 파라미터는 false로 설정하세요.
                                - '현금흐름표' 탭을 선택해서 데이터를 수집하세요.
                                - 차트보다는 테이블 위주로 데이터를 수집하세요.
                                
                                ## 접속 URL('현금흐름표' 탭): {urls['재무분석']}
                                
                                ## 2. 데이터 분석 및 보고서 작성
                                - 수집한 데이터를 직접 분석하여 객관적이고 데이터 중심의 분석 보고서를 작성하세요.
                                - 실제로 수집된 데이터를 바탕으로 자율적으로 분석하세요. 수집되지 않은 데이터에 대해 추측하지 마세요.
                                - 데이터에서 나타나는 중요한 패턴, 추세, 특이점을 식별하고 이를 중심으로 분석하세요.
                                - {reference_date} 날짜(YYYYMMDD 형식) 기준으로 가장 최근 자료에 중점을 두세요.
                                - 5,000자 이상의 상세한 보고서를 작성하되, 모델의 출력 한계(약 8,000자)를 고려하세요.
                                
                                ## 보고서 구성 방향
                                - 영업/투자/재무 활동 현금흐름의 구조와 변화 추이 분석
                                - 현금창출능력 및 자금운용 효율성 분석
                                - 투자 및 자본지출 패턴 분석
                                - 재무활동을 통한 자금조달 전략 분석
                                - 수집된 데이터에서 발견되는 특이점과 주요 인사이트에 집중하세요.
                                - 분석은 항상 수집된 실제 데이터에 기반해야 합니다.
                                
                                ## 보고서 형식
                                - 보고서 시작 시 반드시 개행문자 2번 삽입 (\n\n)
                                - 섹션 제목: "# 7-3. 심층 재무제표 분석(현금흐름표)"
                                - 수집된 데이터를 기반으로 적절한 구조와 소제목을 자율적으로 구성하세요.
                                - 복잡한 데이터는 표 형식으로 정리하여 가독성을 높이세요.
                                - 데이터 인용 시 출처와 기준일자를 명시하세요 (출처: https://comp.wisereport.co.kr/).
                                
                                ## 작성 스타일
                                - 전문적이고 객관적인 문어체 사용 ('~합니다', '~입니다'로 통일)
                                - 개인적 의견보다 데이터에 기반한 객관적 분석 제시
                                - 수치는 구체적으로 제시하고, 증감률과 의미를 명확히 설명
                                - 다른 보고서 섹션과 중복되지 않게 작성
                                - 결론에 해당하는 문단은 작성하지 말 것 (해당 보고서는 전체 보고서의 섹션 중 하나임)
                                
                                기업: {company_name} ({company_code})
                                ##분석일: {reference_date}(YYYYMMDD 형식)
                                """,
                server_names=["webresearch"]
            ),
            "investment_indicators": Agent(
                name="investment_indicator_analyzer",
                instruction=f"""당신은 투자 지표 데이터 수집 및 분석 전문가입니다. 다음 단계로 업무를 수행하세요:

                                ## 1. 데이터 수집
                                - 아래 URL에 접속하여 {year} 년도로부터 2~3년 전까지의 투자지표 자료를 수집하세요.
                                - URL 접속 시 visit_page tool을 사용하고 takeScreenshot 파라미터는 false로 설정하세요.
                                - 페이지 내 '수익성', '성장성', '안정성', '활동성' 등의 탭이 있다면 접근하여 데이터를 수집하세요.
                                - URL 파라미터를 조절하여 다양한 탭에 접근해 보세요.
                                - 차트보다는 테이블 위주로 데이터를 수집하세요.
                                
                                ## 접속 URL: {urls['투자지표']}
                                
                                ## 2. 데이터 분석 및 보고서 작성
                                - 수집한 데이터를 직접 분석하여 객관적이고 데이터 중심의 분석 보고서를 작성하세요.
                                - 실제로 수집된 데이터를 바탕으로 자율적으로 분석하세요. 수집되지 않은 데이터에 대해 추측하지 마세요.
                                - 데이터에서 나타나는 중요한 패턴, 추세, 특이점을 식별하고 이를 중심으로 분석하세요.
                                - {reference_date} 날짜(YYYYMMDD 형식) 기준으로 가장 최근 자료에 중점을 두세요.
                                - 5,000자 이상의 상세한 보고서를 작성하되, 모델의 출력 한계(약 8,000자)를 고려하세요.
                                
                                ## 보고서 구성 방향
                                - 주요 투자 지표(PER, PBR, ROE, EPS 등)의 추이와 의미 분석
                                - 동종 업계 또는 시장 평균과 비교한 상대적 가치 평가
                                - 수익성, 성장성, 안정성, 활동성 측면의 종합 분석
                                - 투자 매력도와 잠재적 리스크 요인 분석
                                - 수집된 데이터에서 발견되는 특이점과 주요 인사이트에 집중하세요.
                                - 분석은 항상 수집된 실제 데이터에 기반해야 합니다.
                                
                                ## 보고서 형식
                                - 보고서 시작 시 반드시 개행문자 2번 삽입 (\n\n)
                                - 섹션 제목: "# 8. 투자 지표 및 가치 평가 분석"
                                - 수집된 데이터를 기반으로 적절한 구조와 소제목을 자율적으로 구성하세요.
                                - 복잡한 데이터는 표 형식으로 정리하여 가독성을 높이세요.
                                - 데이터 인용 시 출처와 기준일자를 명시하세요 (출처: https://comp.wisereport.co.kr/).
                                
                                ## 작성 스타일
                                - 전문적이고 객관적인 문어체 사용 ('~합니다', '~입니다'로 통일)
                                - 개인적 의견보다 데이터에 기반한 객관적 분석 제시
                                - 수치는 구체적으로 제시하고, 증감률과 의미를 명확히 설명
                                - 다른 보고서 섹션과 중복되지 않게 작성
                                - 결론에 해당하는 문단은 작성하지 말 것 (해당 보고서는 전체 보고서의 섹션 중 하나임)
                                
                                기업: {company_name} ({company_code})
                                ##분석일: {reference_date}(YYYYMMDD 형식)
                                """,
                server_names=["webresearch"]
            ),
            "competitor_analysis": Agent(
                name="competitor_analysis_analyzer",
                instruction=f"""당신은 경쟁사 분석 데이터 수집 및 분석 전문가입니다. 다음 단계로 업무를 수행하세요:

                                ## 1. 데이터 수집
                                - 아래 URL에 접속하여 {year} 년도로부터 2~3년 전까지의 경쟁사 분석 자료를 수집하세요.
                                - URL 접속 시 visit_page tool을 사용하고 takeScreenshot 파라미터는 false로 설정하세요.
                                - 차트보다는 테이블 위주로 데이터를 수집하세요.
                                - 경쟁사 분석 테이블을 볼 때, 만약 경쟁사의 기업명이 안보이면 종목코드라도 수집해주세요.
                                
                                ## 접속 URL: {urls['경쟁사분석']}
                                
                                ## 2. 데이터 분석 및 보고서 작성
                                - 수집한 데이터를 직접 분석하여 객관적이고 데이터 중심의 분석 보고서를 작성하세요.
                                - 실제로 수집된 데이터를 바탕으로 자율적으로 분석하세요. 수집되지 않은 데이터에 대해 추측하지 마세요.
                                - 데이터에서 나타나는 중요한 패턴, 추세, 특이점을 식별하고 이를 중심으로 분석하세요.
                                - {reference_date} 날짜(YYYYMMDD 형식) 기준으로 가장 최근 자료에 중점을 두세요.
                                - 5,000자 이상의 상세한 보고서를 작성하되, 모델의 출력 한계(약 8,000자)를 고려하세요.
                                
                                ## 보고서 구성 방향
                                - 주요 경쟁사와의 재무 지표 비교 분석
                                - 시장 점유율 및 경쟁 포지션 분석
                                - 수익성, 성장성, 효율성 등의 비교 분석
                                - 상대적 강점과 약점 분석
                                - 경쟁 환경 내 차별화 요소 분석
                                - 수집된 데이터에서 발견되는 특이점과 주요 인사이트에 집중하세요.
                                - 분석은 항상 수집된 실제 데이터에 기반해야 합니다.
                                
                                ## 보고서 형식
                                - 보고서 시작 시 반드시 개행문자 2번 삽입 (\n\n)
                                - 섹션 제목: "# 9. 경쟁사 비교 분석"
                                - 수집된 데이터를 기반으로 적절한 구조와 소제목을 자율적으로 구성하세요.
                                - 복잡한 데이터는 표 형식으로 정리하여 가독성을 높이세요.
                                - 데이터 인용 시 출처와 기준일자를 명시하세요 (출처: https://comp.wisereport.co.kr/).
                                
                                ## 작성 스타일
                                - 전문적이고 객관적인 문어체 사용 ('~합니다', '~입니다'로 통일)
                                - 개인적 의견보다 데이터에 기반한 객관적 분석 제시
                                - 수치는 구체적으로 제시하고, 증감률과 의미를 명확히 설명
                                - 다른 보고서 섹션과 중복되지 않게 작성
                                - 결론에 해당하는 문단은 작성하지 말 것 (해당 보고서는 전체 보고서의 섹션 중 하나임)
                                
                                기업: {company_name} ({company_code})
                                ##분석일: {reference_date}(YYYYMMDD 형식)
                                """,
                server_names=["webresearch"]
            ),
            "consensus_data": Agent(
                name="consensus_data_analyzer",
                instruction=f"""당신은 애널리스트 컨센서스 데이터 수집 및 분석 전문가입니다. 다음 단계로 업무를 수행하세요:

                                ## 1. 데이터 수집
                                - 아래 URL에 접속하여 {year} 년도로부터 2~3년 전까지의 컨센서스 자료를 수집하세요.
                                - URL 접속 시 visit_page tool을 사용하고 takeScreenshot 파라미터는 false로 설정하세요.
                                - 페이지 내 '분기' 등의 탭이 있다면 접근하여 데이터를 수집하세요.
                                - URL 파라미터를 조절하여 다양한 탭에 접근해 보세요.
                                - 차트보다는 테이블 위주로 데이터를 수집하세요.
                                
                                ## 접속 URL: {urls['컨센서스']}
                                
                                ## 2. 데이터 분석 및 보고서 작성
                                - 수집한 데이터를 직접 분석하여 객관적이고 데이터 중심의 분석 보고서를 작성하세요.
                                - 실제로 수집된 데이터를 바탕으로 자율적으로 분석하세요. 수집되지 않은 데이터에 대해 추측하지 마세요.
                                - 데이터에서 나타나는 중요한 패턴, 추세, 특이점을 식별하고 이를 중심으로 분석하세요.
                                - {reference_date} 날짜(YYYYMMDD 형식) 기준으로 가장 최근 자료에 중점을 두세요.
                                - 5,000자 이상의 상세한 보고서를 작성하되, 모델의 출력 한계(약 8,000자)를 고려하세요.
                                
                                ## 보고서 구성 방향
                                - 애널리스트들의 전망과 목표가 분석
                                - 매출, 영업이익, EPS 추정치 추이 분석
                                - 컨센서스 변화 패턴과 그 의미 분석
                                - 실적 발표와 컨센서스 조정 간의 관계 분석
                                - 컨센서스 대비 실적 달성률 분석
                                - 수집된 데이터에서 발견되는 특이점과 주요 인사이트에 집중하세요.
                                - 분석은 항상 수집된 실제 데이터에 기반해야 합니다.
                                
                                ## 보고서 형식
                                - 보고서 시작 시 반드시 개행문자 2번 삽입 (\n\n)
                                - 섹션 제목: "# 10. 애널리스트 컨센서스 분석"
                                - 수집된 데이터를 기반으로 적절한 구조와 소제목을 자율적으로 구성하세요.
                                - 복잡한 데이터는 표 형식으로 정리하여 가독성을 높이세요.
                                - 데이터 인용 시 출처와 기준일자를 명시하세요 (출처: https://comp.wisereport.co.kr/).
                                
                                ## 작성 스타일
                                - 전문적이고 객관적인 문어체 사용 ('~합니다', '~입니다'로 통일)
                                - 개인적 의견보다 데이터에 기반한 객관적 분석 제시
                                - 수치는 구체적으로 제시하고, 증감률과 의미를 명확히 설명
                                - 다른 보고서 섹션과 중복되지 않게 작성
                                - 결론에 해당하는 문단은 작성하지 말 것 (해당 보고서는 전체 보고서의 섹션 중 하나임)
                                
                                기업: {company_name} ({company_code})
                                ##분석일: {reference_date}(YYYYMMDD 형식)
                                """,
                server_names=["webresearch"]
            ),
            "etc_analysis": Agent(
                name="misc_data_analyzer",
                instruction=f"""당신은 지분현황/업종분석/최근리포트 데이터 수집 및 분석 전문가입니다. 다음 단계로 업무를 수행하세요:

                                ## 1. 데이터 수집
                                - 아래 URL 리스트에 접속하여 {year} 년도로부터 2~3년 전까지의 자료를 수집하세요.
                                - URL 접속 시 visit_page tool을 사용하고 takeScreenshot 파라미터는 false로 설정하세요.
                                - 차트보다는 테이블 위주로 데이터를 수집하세요.
                                - 세 가지 URL 모두 접근하여 각각의 데이터를 수집하세요.
                                
                                ## 접속 URL 리스트:
                                1. 지분현황: {urls['지분현황']}
                                2. 업종분석: {urls['업종분석']}
                                3. 최근리포트: {urls['최근리포트']}
                                
                                ## 2. 데이터 분석 및 보고서 작성
                                - 수집한 데이터를 직접 분석하여 객관적이고 데이터 중심의 분석 보고서를 작성하세요.
                                - 실제로 수집된 데이터를 바탕으로 자율적으로 분석하세요. 수집되지 않은 데이터에 대해 추측하지 마세요.
                                - 데이터에서 나타나는 중요한 패턴, 추세, 특이점을 식별하고 이를 중심으로 분석하세요.
                                - {reference_date} 날짜(YYYYMMDD 형식) 기준으로 가장 최근 자료에 중점을 두세요.
                                - 5,000자 이상의 상세한 보고서를 작성하되, 모델의 출력 한계(약 8,000자)를 고려하세요.
                                
                                ## 보고서 구성 방향
                                - 주요 주주 구성 및 변동 분석 (지분현황)
                                - 기관/외국인/개인 등 주요 주주 그룹의 지분 변화 추이 (지분현황)
                                - 업종 내 위치 및 경쟁력 분석 (업종분석)
                                - 업종 평균 대비 성과 및 밸류에이션 분석 (업종분석)
                                - 최근 발표된 주요 리포트의 핵심 내용 요약 (최근리포트)
                                - 수집된 데이터에서 발견되는 특이점과 주요 인사이트에 집중하세요.
                                - 분석은 항상 수집된 실제 데이터에 기반해야 합니다.
                                
                                ## 보고서 형식
                                - 보고서 시작 시 반드시 개행문자 2번 삽입 (\n\n)
                                - 섹션 제목: "# 11. 지분현황/업종분석/최근리포트 분석"
                                - 수집된 데이터를 기반으로 적절한 구조와 소제목을 자율적으로 구성하세요.
                                - 복잡한 데이터는 표 형식으로 정리하여 가독성을 높이세요.
                                - 데이터 인용 시 출처와 기준일자를 명시하세요 (출처: https://comp.wisereport.co.kr/).
                                
                                ## 작성 스타일
                                - 전문적이고 객관적인 문어체 사용 ('~합니다', '~입니다'로 통일)
                                - 개인적 의견보다 데이터에 기반한 객관적 분석 제시
                                - 수치는 구체적으로 제시하고, 증감률과 의미를 명확히 설명
                                - 다른 보고서 섹션과 중복되지 않게 작성
                                - 결론에 해당하는 문단은 작성하지 말 것 (해당 보고서는 전체 보고서의 섹션 중 하나임)
                                
                                기업: {company_name} ({company_code})
                                ##분석일: {reference_date}(YYYYMMDD 형식)
                                """,
                server_names=["webresearch"]
            ),
            "news_data": Agent(
                name="news_data_analyzer",
                instruction=f"""당신은 뉴스 및 리서치 데이터 수집 및 분석 전문가입니다. 다음 단계로 업무를 수행하세요:

                                ## 1. 데이터 수집
                                - exa server의 search tool을 사용하여 {six_months_ago} ~ {reference_date} 기간(YYYYMMDD 형식)의 뉴스 및 리서치 자료를 수집하세요.
                                - numResults 파라미터를 반드시 10 이하로 설정하여 검색 결과를 제한하세요.
                                - 검색 예시: search({{"query": "{company_name} 실적", "numResults": 10}})
                                - 기업명, 업종, 관련 키워드 등을 활용하여 적절한 검색 쿼리를 구성하세요.
                                - 최신 뉴스를 중심으로 약 10개의 주요 뉴스/리서치 자료를 수집하세요.
                                
                                # 중요: Rate Limit 예방을 위해 항상 numResults를 10 이하로 설정하세요.
                                # 과도한 검색 결과는 토큰 제한을 초과할 수 있습니다.
                                
                                ## 수집 항목:
                                - 주요 기업 뉴스
                                - 산업 뉴스
                                - 애널리스트 리포트
                                
                                ## 2. 데이터 분석 및 보고서 작성
                                - 수집한 데이터를 직접 분석하여 객관적이고 데이터 중심의 분석 보고서를 작성하세요.
                                - 실제로 수집된 데이터를 바탕으로 자율적으로 분석하세요. 수집되지 않은 데이터에 대해 추측하지 마세요.
                                - 뉴스에서 나타나는 중요한 패턴, 트렌드, 이슈를 식별하고 이를 중심으로 분석하세요.
                                - {reference_date} 날짜(YYYYMMDD 형식) 기준으로 가장 최근 뉴스에 중점을 두세요.
                                - 5,000자 이상의 상세한 보고서를 작성하되, 모델의 출력 한계(약 8,000자)를 고려하세요.
                                
                                ## 보고서 구성 방향
                                - 주요 뉴스 이슈 및 이벤트 요약 및 분석
                                - 시장 반응 및 주가 영향 분석
                                - 뉴스 트렌드 및 산업 동향 분석
                                - 애널리스트들의 주요 의견 및 전망 분석
                                - 수집된 데이터에서 발견되는 특이점과 주요 인사이트에 집중하세요.
                                - 분석은 항상 수집된 실제 뉴스 데이터에 기반해야 합니다.
                                
                                ## 보고서 형식
                                - 보고서 시작 시 반드시 개행문자 2번 삽입 (\n\n)
                                - 섹션 제목: "# 12. 뉴스 트렌드 및 시장 반응 분석"
                                - 수집된 데이터를 기반으로 적절한 구조와 소제목을 자율적으로 구성하세요.
                                - 주요 뉴스는 날짜와 제목을 포함하여 체계적으로 정리하세요.
                                - 뉴스 데이터 인용 시 출처와 일자를 명시하세요.
                                
                                ## 작성 스타일
                                - 전문적이고 객관적인 문어체 사용 ('~합니다', '~입니다'로 통일)
                                - 개인적 의견보다 데이터에 기반한 객관적 분석 제시
                                - 주요 트렌드와 패턴을 명확히 설명
                                - 다른 보고서 섹션과 중복되지 않게 작성
                                - 결론에 해당하는 문단은 작성하지 말 것 (해당 보고서는 전체 보고서의 섹션 중 하나임)
                                
                                기업: {company_name} ({company_code})
                                ##분석일: {reference_date}(YYYYMMDD 형식)
                                """,
                server_names=["exa"]
            )
        }

        # 병렬로 보고서 섹션 작성
        writing_tasks = []
        with concurrent.futures.ThreadPoolExecutor(max_workers=2) as executor:  # worker 수 제한
            for i, (data_key, writer_agent) in enumerate(report_writers.items()):
                writing_tasks.append(
                    write_report_section(data_key, writer_agent,
                                         company_name, company_code, reference_date,
                                         logger, delay=i*10.0)  # 각 작업마다 10초씩 차이
                )

            results = await asyncio.gather(*writing_tasks)
            for data_key, report in results:
                if report:
                    section_reports[data_key] = report

        # 3. 최종 보고서 조합 및 정리
        final_report = ""
        for data_key in report_writers.keys():
            if data_key in section_reports:
                final_report += section_reports[data_key]


        # 4. 최종 보고서에 결론 섹션 추가
        opinion_agent = Agent(
            name="opinion",
            instruction=f"""
                        당신은 {company_name} ({company_code}) 기업분석 보고서에 대한 종합 결론과 투자자 유형별 투자 의견을 작성하는 투자 전문가입니다.
                        보고서 전체를 종합적으로 분석하여 보고서 맨 앞에 배치될 결론 섹션을 작성해야 합니다.
                        객관적인 데이터를 바탕으로 신중하고 전문적인 의견을 제시하세요.
                        
                        ##분석일 : {reference_date}(YYYYMMDD 형식)
                        """
        )

        final_llm = await opinion_agent.attach_llm(OpenAIAugmentedLLM)
        opinion = await final_llm.generate_str(
            message=f"""{company_name}({company_code})의 기업분석 보고서에 대한 종합 결론과 다양한 투자자 유형별 투자 의견을 5,000자 정도로 작성해주세요.
                        (##분석일 : {reference_date}(YYYYMMDD 형식))
                        
                        ## 주의사항 언급 : 투자의 책임은 본인에게 있다는 형식적인 워딩으로 보고서를 시작하세요.

                        ## 형식 가이드라인:
            
                        결론 부분은 아래 마크다운 형식의 구조로 작성하되, 전체 보고서의 맨 앞에 배치될 것입니다:
                        
                        ```
                        # 투자 결론 및 제언
                        
                        ## 종합 분석 요약
                        (여기에 내용 작성)
                        
                        ## 투자자 유형별 전략
                        
                        ### 1. 신규 투자자 전략
                        (여기에 내용 작성)
                        
                        ### 2. 기존 보유자 전략
                        (여기에 내용 작성)
                        
                        ### 3. 포트폴리오 관점 전략
                        (여기에 내용 작성)
                        
                        ### 4. 투자 성향별 접근법
                        (여기에 내용 작성)
                        
                        ### 5. 자금 배분 전략
                        (여기에 내용 작성)
                        ```
                        
                        ## 말투 및 문체 가이드라인:
                        
                        1. 전문적이고 간결한 문체 사용: 불필요한 수식어 배제, 핵심만 전달
                           예시: "~할 것으로 보입니다" 대신 "~할 것으로 예상됩니다" 또는 "~입니다"
                        
                        2. 분석적이고 객관적인 톤 유지: 
                           - "매우 좋은 기회입니다"(×) → "PER 기준 저평가 구간입니다"(○)
                           - "반드시 매수해야 합니다"(×) → "매수 검토가 적절합니다"(○)
                        
                        3. 명확한 수치와 근거 제시:
                           - "높은 성장이 예상됩니다"(×) → "2024년 매출 101.73% 성장이 예상됩니다"(○)
                           
                        4. 단정적 표현보다 확률적/조건부 표현 사용:
                           - "주가는 상승할 것입니다"(×) → "시장 회복 시 주가 상승 가능성이 높습니다"(○)
                        
                        5. 직접적 투자 권유보다 정보 제공 형태로 작성:
                           - "지금 매수하세요"(×) → "현 밸류에이션은 매수 시점으로 판단됩니다"(○)
                                            
                        ## 내용 가이드라인:
                        
                        ### 1. 종합 분석 요약 (400-600자)
                        - 핵심 재무지표 추이 요약
                        - 시장 내 위치 및 경쟁력 평가
                        - 향후 1-2년 전망
                        - 주요 리스크 요인
                        
                        ### 2. 신규 투자자 전략
                        - 현 진입 적정성 판단과 근거
                        - 자금 규모별 접근법
                        - 목표가/손절가 제시
                        - 적정 진입 시점
                        
                        ### 3. 기존 보유자 전략
                        - 보유 지속 여부 판단
                        - 평균단가별 대응방안
                        - 추가매수/분할매도 전략
                        - 장기보유 시 모니터링 포인트
                        
                        ### 4. 포트폴리오 관점 전략
                        - 반도체 업종 내 비중
                        - 전체 포트폴리오 내 적정 비중
                        - 상관관계 높은 종목들과의 관계
                        - 글로벌 경기/환율 변동 대응법
                        
                        ### 5. 투자 성향별 접근법
                        - 가치/성장/배당/기술적 분석 관점별 전략
                        - 투자 기간별 접근법
                        - 위험 감수성향별 대응법
                        
                        ### 6. 자금 배분 전략
                        - 일시투자 vs 분할투자 비교
                        - 매수 비율 및 타이밍
                        - 투자금 규모별 실행방안
                        
                        첨부된 보고서 내용:
                        {final_report}
                        """,
            request_params=RequestParams(
                model="gpt-4o-mini",
                maxTokens=8000,
                max_iterations=5,
                parallel_tool_calls=True,
                use_history=True
            )
        )

        # 면책 문구 정의
        disclaimer = """# 투자 유의사항
        
                        본 보고서는 정보 제공을 목적으로 작성되었으며, 투자 권유를 목적으로 하지 않습니다. 
                        본 보고서에 기재된 내용은 작성 시점 기준으로 신뢰할 수 있는 자료에 근거하여 AI로 작성되었으나, 
                        그 정확성과 완전성을 보장하지 않습니다.
                        
                        투자는 본인의 판단과 책임 하에 신중하게 이루어져야 하며, 
                        본 보고서를 참고하여 발생하는 투자 결과에 대한 책임은 투자자 본인에게 있습니다.
        
                      """

        ##todo : 개행문자 있는 그대로 나와버림
        final_report = disclaimer + "\n\n" + opinion + "\n\n" + final_report
        # 최종 마크다운 정리
        final_report = clean_markdown(final_report)


        logger.info(f"Finalized report for {company_name} - {len(final_report)} characters")
        logger.info(f"Analysis completed for {company_name}.")
        logger.info(f"Final Report : " + final_report)

        return final_report


if __name__ == "__main__":
    import time
    start = time.time()

    # 특정 날짜를 기준으로 분석 실행 (예: 2025년 2월 19일)
    result = asyncio.run(analyze_stock(company_code="008420", company_name="문배철강", reference_date="20250226"))

    # 결과 저장
    with open(f"SK하이닉스_분석보고서_{datetime.now().strftime('%Y%m%d')}.md", "w", encoding="utf-8") as f:
        f.write(result)

    end = time.time()
    print(f"총 실행 시간: {end - start:.2f}초")
    print(f"최종 보고서 길이: {len(result):,} 글자")